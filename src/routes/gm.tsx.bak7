import { createSignal, Show, For, onMount } from "solid-js";
import { A, useNavigate } from "@solidjs/router";
import { getUser } from "~/lib/auth";
import { isGM, getAllPlayers, getAllMobs, getAllItems, getAllRegions, getAllAbilities, getAllMerchants, updateMob, deleteMob, createMob, updateItem, deleteItem, createItem, getAllMobLoot, getAllRegionRareLoot, createMobLoot, updateMobLoot, deleteMobLoot, createRegionRareLoot, updateRegionRareLoot, deleteRegionRareLoot, createAbility, updateAbility, deleteAbility, createRegion, updateRegion, deleteRegion, createMerchant, updateMerchant, deleteMerchant, getAllSubAreaMobs, createSubAreaMob, updateSubAreaMob, deleteSubAreaMob, getAllSubAreas, getAllMerchantInventory, createMerchantInventory, updateMerchantInventory, deleteMerchantInventory, getAbilityEffects, createAbilityEffect, updateAbilityEffect, deleteAbilityEffect, getCharacter, updateCharacter, getCharacterInventory, getCharacterAbilities, addItemToCharacter, removeItemFromCharacter, updateCharacterInventoryItem, addAbilityToCharacter, removeAbilityFromCharacter, getCharacterRegionUnlocks, unlockRegionForCharacter, lockRegionForCharacter, getCharacterProfessions, updateCharacterProfession } from "~/lib/gm";
import { BulkEditTable } from "~/components/BulkEditTable";

export default function GMPage() {
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = createSignal<string>("players");
  const [loading, setLoading] = createSignal(true);
  const [authorized, setAuthorized] = createSignal(false);
  
  const [players, setPlayers] = createSignal<any[]>([]);
  const [mobs, setMobs] = createSignal<any[]>([]);
  const [items, setItems] = createSignal<any[]>([]);
  const [regions, setRegions] = createSignal<any[]>([]);
  const [abilities, setAbilities] = createSignal<any[]>([]);
  const [merchants, setMerchants] = createSignal<any[]>([]);
  const [mobLoot, setMobLoot] = createSignal<any[]>([]);
  const [regionRareLoot, setRegionRareLoot] = createSignal<any[]>([]);
  const [subAreaMobs, setSubAreaMobs] = createSignal<any[]>([]);
  const [subAreas, setSubAreas] = createSignal<any[]>([]);
  const [merchantInventory, setMerchantInventory] = createSignal<any[]>([]);
  const [abilityEffects, setAbilityEffects] = createSignal<any[]>([]);
  const [quests, setQuests] = createSignal<any[]>([]);
  
  // Edit modal state
  const [editingMob, setEditingMob] = createSignal<any | null>(null);
  const [editingItem, setEditingItem] = createSignal<any | null>(null);
  const [editingMobLoot, setEditingMobLoot] = createSignal<any | null>(null);
  const [editingRegionLoot, setEditingRegionLoot] = createSignal<any | null>(null);
  const [editingAbility, setEditingAbility] = createSignal<any | null>(null);
  const [editingRegion, setEditingRegion] = createSignal<any | null>(null);
  const [editingMerchant, setEditingMerchant] = createSignal<any | null>(null);
  const [editingSubAreaMob, setEditingSubAreaMob] = createSignal<any | null>(null);
  const [editingMerchantInv, setEditingMerchantInv] = createSignal<any | null>(null);
  const [editingAbilityEffect, setEditingAbilityEffect] = createSignal<any | null>(null);
  const [editingCharacter, setEditingCharacter] = createSignal<any | null>(null);
  const [characterInventory, setCharacterInventory] = createSignal<any[]>([]);
  const [characterAbilities, setCharacterAbilities] = createSignal<any[]>([]);
  const [characterRegionUnlocks, setCharacterRegionUnlocks] = createSignal<any[]>([]);
  const [characterProfessions, setCharacterProfessions] = createSignal<any[]>([]);
  const [selectedAbilityForEffects, setSelectedAbilityForEffects] = createSignal<number | null>(null);
  const [showMobModal, setShowMobModal] = createSignal(false);
  const [showItemModal, setShowItemModal] = createSignal(false);
  const [showMobLootModal, setShowMobLootModal] = createSignal(false);
  const [showRegionLootModal, setShowRegionLootModal] = createSignal(false);
  const [showAbilityModal, setShowAbilityModal] = createSignal(false);
  const [showRegionModal, setShowRegionModal] = createSignal(false);
  const [showMerchantModal, setShowMerchantModal] = createSignal(false);
  const [showSubAreaMobModal, setShowSubAreaMobModal] = createSignal(false);
  const [showMerchantInvModal, setShowMerchantInvModal] = createSignal(false);
  const [showAbilityEffectModal, setShowAbilityEffectModal] = createSignal(false);
  const [showCharacterModal, setShowCharacterModal] = createSignal(false);
  const [characterModalTab, setCharacterModalTab] = createSignal<'stats' | 'inventory' | 'abilities' | 'regions' | 'professions'>('stats');
  const [showQuestModal, setShowQuestModal] = createSignal(false);
  const [editingQuest, setEditingQuest] = createSignal<any | null>(null);
  const [editingQuestObjectives, setEditingQuestObjectives] = createSignal<any[]>([]);
  const [editingQuestRewards, setEditingQuestRewards] = createSignal<any[]>([]);
  const [questFilterRegion, setQuestFilterRegion] = createSignal<number | null>(null);
  const [showQuestRewardItemModal, setShowQuestRewardItemModal] = createSignal(false);
  const [editingRewardIndex, setEditingRewardIndex] = createSignal<number | null>(null);
  const [selectedRewardItemId, setSelectedRewardItemId] = createSignal<number | null>(null);
  const [rewardItemQuantity, setRewardItemQuantity] = createSignal(1);
  const [showAddItemModal, setShowAddItemModal] = createSignal(false);
  const [showAddAbilityModal, setShowAddAbilityModal] = createSignal(false);
  const [searchAddItem, setSearchAddItem] = createSignal("");
  const [searchAddAbility, setSearchAddAbility] = createSignal("");
  const [selectedItemToAdd, setSelectedItemToAdd] = createSignal<number | null>(null);
  const [selectedAbilityToAdd, setSelectedAbilityToAdd] = createSignal<number | null>(null);
  const [itemQuantityToAdd, setItemQuantityToAdd] = createSignal(1);
  const [calcLevel, setCalcLevel] = createSignal(1);
  const [selectedMobForLoot, setSelectedMobForLoot] = createSignal<number | null>(null);
  const [selectedRegionForLoot, setSelectedRegionForLoot] = createSignal<number | null>(null);
  const [selectedSubAreaForMobs, setSelectedSubAreaForMobs] = createSignal<number | null>(null);
  const [selectedMerchantForInv, setSelectedMerchantForInv] = createSignal<number | null>(null);
  
  // Search filters
  const [searchPlayers, setSearchPlayers] = createSignal("");
  const [searchMobs, setSearchMobs] = createSignal("");
  const [searchItems, setSearchItems] = createSignal("");
  const [searchRegions, setSearchRegions] = createSignal("");
  const [searchAbilities, setSearchAbilities] = createSignal("");
  const [searchMerchants, setSearchMerchants] = createSignal("");
  const [searchMobLoot, setSearchMobLoot] = createSignal("");
  const [searchRegionLoot, setSearchRegionLoot] = createSignal("");
  const [searchRegionMobs, setSearchRegionMobs] = createSignal("");
  const [searchMerchantInventory, setSearchMerchantInventory] = createSignal("");
  const [searchAbilityLookup, setSearchAbilityLookup] = createSignal("");
  const [copiedAbilityId, setCopiedAbilityId] = createSignal<number | null>(null);
  
  // Computed values
  const allRegions = () => regions();
  const filteredQuests = () => {
    const filter = questFilterRegion();
    if (!filter) return quests();
    return quests().filter((q: any) => q.region_id === filter);
  };
  
  // Helper to check if XP is balanced
  const getXPStatus = (mobLevel: number, xp: number) => {
    const xpNeeded = mobLevel * 125;
    const recommended = Math.ceil(xpNeeded / 10); // 10 kills per level (medium)
    const min = Math.ceil(xpNeeded / 15); // 15 kills per level (slow)
    const max = Math.ceil(xpNeeded / 5); // 5 kills per level (fast)
    
    if (xp < min) return { status: 'low', color: 'var(--danger)', text: `Low (${Math.ceil(xpNeeded / xp)} kills/lvl)` };
    if (xp > max) return { status: 'high', color: 'var(--warning)', text: `High (${Math.ceil(xpNeeded / xp)} kills/lvl)` };
    return { status: 'good', color: 'var(--success)', text: `Good (${Math.ceil(xpNeeded / xp)} kills/lvl)` };
  };
  
  // Helper to reload data
  const reloadMobs = async () => {
    const mobsData = await getAllMobs();
    setMobs(mobsData as any);
  };
  
  const reloadItems = async () => {
    const itemsData = await getAllItems();
    setItems(itemsData as any);
  };
  
  const reloadMobLoot = async () => {
    const lootData = await getAllMobLoot();
    setMobLoot(lootData as any);
  };
  
  const reloadRegionLoot = async () => {
    const lootData = await getAllRegionRareLoot();
    setRegionRareLoot(lootData as any);
  };
  
  const reloadAbilities = async () => {
    const abilitiesData = await getAllAbilities();
    setAbilities(abilitiesData as any);
  };
  
  const reloadRegions = async () => {
    const regionsData = await getAllRegions();
    setRegions(regionsData as any);
  };
  
  const reloadMerchants = async () => {
    const merchantsData = await getAllMerchants();
    setMerchants(merchantsData as any);
  };
  
  const refetchQuests = async () => {
    const response = await fetch('/api/gm/quests');
    const data = await response.json();
    setQuests(data.quests || []);
  };
  
  // Column configurations for bulk edit tables
  const itemColumns = [
    { key: 'id', label: 'ID', width: '60px', type: 'readonly' as const, align: 'center' as const },
    { key: 'name', label: 'Name', width: '300px', type: 'text' as const },
    { key: 'type', label: 'Type', width: '100px', type: 'select' as const, align: 'center' as const, options: [
      { value: 'weapon', label: 'Weapon' },
      { value: 'armor', label: 'Armor' },
      { value: 'offhand', label: 'Offhand' },
      { value: 'consumable', label: 'Consumable' },
      { value: 'material', label: 'Material' },
      { value: 'quest', label: 'Quest Item' }
    ]},
    { key: 'slot', label: 'Slot', width: '100px', type: 'select' as const, align: 'center' as const, options: [
      { value: 'weapon', label: 'Weapon' },
      { value: 'offhand', label: 'Offhand' },
      { value: 'head', label: 'Head' },
      { value: 'chest', label: 'Chest' },
      { value: 'legs', label: 'Legs' },
      { value: 'feet', label: 'Feet' },
      { value: 'hands', label: 'Hands' },
      { value: 'accessory', label: 'Accessory' },
      { value: '', label: 'None' }
    ]},
    { key: 'rarity', label: 'Rarity', width: '90px', type: 'select' as const, align: 'center' as const, options: [
      { value: 'common', label: 'Common' },
      { value: 'uncommon', label: 'Uncommon' },
      { value: 'rare', label: 'Rare' },
      { value: 'epic', label: 'Epic' },
      { value: 'legendary', label: 'Legendary' }
    ]},
    { key: 'required_level', label: 'Req Lvl', width: '70px', type: 'number' as const, align: 'center' as const },
    { key: 'value', label: 'Value', width: '70px', type: 'number' as const, align: 'right' as const },
    { key: 'weapon_type', label: 'Wpn Type', width: '100px', type: 'select' as const, align: 'center' as const, options: [
      { value: '', label: 'None' },
      { value: 'sword', label: 'Sword' },
      { value: 'dual_sword', label: 'Dual Sword' },
      { value: 'greatsword', label: 'Greatsword' },
      { value: 'axe', label: 'Axe' },
      { value: 'greataxe', label: 'Greataxe' },
      { value: 'mace', label: 'Mace' },
      { value: 'dagger', label: 'Dagger' },
      { value: 'dual_dagger', label: 'Dual Dagger' },
      { value: 'staff', label: 'Staff' },
      { value: 'wand', label: 'Wand' },
      { value: 'bow', label: 'Bow' }
    ]},
    { key: 'offhand_type', label: 'Off Type', width: '100px', type: 'select' as const, align: 'center' as const, options: [
      { value: '', label: 'None' },
      { value: 'shield', label: 'Shield' },
      { value: 'tome', label: 'Tome' },
      { value: 'orb', label: 'Orb' },
      { value: 'focus', label: 'Focus' },
      { value: 'quiver', label: 'Quiver' },
      { value: 'instrument', label: 'Instrument' },
      { value: 'dagger', label: 'Dagger' }
    ]},
    { key: 'is_two_handed', label: '2H', width: '50px', type: 'select' as const, align: 'center' as const, options: [
      { value: 0, label: 'No' },
      { value: 1, label: 'Yes' }
    ]},
    { key: 'damage_min', label: 'Dmg Min', width: '70px', type: 'number' as const, align: 'right' as const },
    { key: 'damage_max', label: 'Dmg Max', width: '70px', type: 'number' as const, align: 'right' as const },
    { key: 'armor', label: 'Armor', width: '60px', type: 'number' as const, align: 'right' as const },
    { key: 'armor_type', label: 'Armor Type', width: '100px', type: 'select' as const, align: 'center' as const, options: [
      { value: '', label: 'None' },
      { value: 'cloth', label: 'Cloth' },
      { value: 'leather', label: 'Leather' },
      { value: 'chain', label: 'Chain' },
      { value: 'plate', label: 'Plate' }
    ]},
    { key: 'attack_speed', label: 'Atk Spd', width: '70px', type: 'number' as const, align: 'right' as const },
    { key: 'strength_bonus', label: 'STR', width: '50px', type: 'number' as const, align: 'right' as const },
    { key: 'dexterity_bonus', label: 'DEX', width: '50px', type: 'number' as const, align: 'right' as const },
    { key: 'constitution_bonus', label: 'CON', width: '50px', type: 'number' as const, align: 'right' as const },
    { key: 'intelligence_bonus', label: 'INT', width: '50px', type: 'number' as const, align: 'right' as const },
    { key: 'wisdom_bonus', label: 'WIS', width: '50px', type: 'number' as const, align: 'right' as const },
    { key: 'charisma_bonus', label: 'CHA', width: '50px', type: 'number' as const, align: 'right' as const },
    { key: 'required_strength', label: 'Req STR', width: '70px', type: 'number' as const, align: 'right' as const },
    { key: 'required_dexterity', label: 'Req DEX', width: '70px', type: 'number' as const, align: 'right' as const },
    { key: 'required_constitution', label: 'Req CON', width: '70px', type: 'number' as const, align: 'right' as const },
    { key: 'required_intelligence', label: 'Req INT', width: '70px', type: 'number' as const, align: 'right' as const },
    { key: 'required_wisdom', label: 'Req WIS', width: '70px', type: 'number' as const, align: 'right' as const },
    { key: 'required_charisma', label: 'Req CHA', width: '70px', type: 'number' as const, align: 'right' as const },
    { key: 'health_restore', label: 'HP Restore', width: '80px', type: 'number' as const, align: 'right' as const },
    { key: 'mana_restore', label: 'MP Restore', width: '80px', type: 'number' as const, align: 'right' as const },
    { key: 'stackable', label: 'Stack', width: '60px', type: 'select' as const, align: 'center' as const, options: [
      { value: 0, label: 'No' },
      { value: 1, label: 'Yes' }
    ]},
    { key: 'teaches_ability_id', label: 'Teaches', width: '70px', type: 'number' as const, align: 'center' as const }
  ];
  
  const itemFilters = [
    {
      key: 'type',
      label: 'Type',
      type: 'multiselect' as const,
      options: [
        { value: 'weapon', label: 'Weapon' },
        { value: 'armor', label: 'Armor' },
        { value: 'offhand', label: 'Offhand' },
        { value: 'consumable', label: 'Consumable' },
        { value: 'material', label: 'Material' },
        { value: 'quest', label: 'Quest Item' }
      ]
    },
    {
      key: 'slot',
      label: 'Slot',
      type: 'multiselect' as const,
      options: [
        { value: 'weapon', label: 'Weapon' },
        { value: 'offhand', label: 'Offhand' },
        { value: 'head', label: 'Head' },
        { value: 'chest', label: 'Chest' },
        { value: 'legs', label: 'Legs' },
        { value: 'feet', label: 'Feet' },
        { value: 'hands', label: 'Hands' },
        { value: 'accessory', label: 'Accessory' }
      ]
    }
  ];
  
  const abilityColumns = [
    {
      key: 'checkbox',
      label: '',
      width: '40px',
      type: 'readonly' as const,
      align: 'center' as const,
      sortable: false,
      render: (value: any, row: any) => (
        <input
          type="checkbox"
          checked={selectedAbilities().has(row.id)}
          onChange={(e) => {
            const newSet = new Set(selectedAbilities());
            if (e.currentTarget.checked) {
              newSet.add(row.id);
            } else {
              newSet.delete(row.id);
            }
            setSelectedAbilities(newSet);
            loadSelectedAbilityEffects();
          }}
        />
      )
    },
    { key: 'id', label: 'ID', width: '60px', type: 'readonly' as const, align: 'center' as const },
    { key: 'name', label: 'Name', width: '200px', type: 'text' as const },
    { key: 'description', label: 'Description', width: '300px', type: 'text' as const },
    { key: 'type', label: 'Type', width: '120px', type: 'select' as const, align: 'center' as const, options: [
      { value: 'damage', label: 'Damage' },
      { value: 'heal', label: 'Heal' },
      { value: 'buff', label: 'Buff' },
      { value: 'debuff', label: 'Debuff' },
      { value: 'utility', label: 'Utility' },
      { value: 'passive', label: 'Passive' }
    ]},
    { key: 'category', label: 'Category', width: '120px', type: 'select' as const, align: 'center' as const, options: [
      { value: 'combat', label: 'Combat' },
      { value: 'passive', label: 'Passive' },
      { value: 'song', label: 'Song' },
      { value: 'crafting', label: 'Crafting' }
    ]},
    { key: 'level', label: 'Level', width: '70px', type: 'number' as const, align: 'center' as const },
    { key: 'base_id', label: 'Base ID', width: '70px', type: 'number' as const, align: 'center' as const },
    { key: 'required_level', label: 'Lvl Req', width: '80px', type: 'number' as const, align: 'center' as const },
    { key: 'required_strength', label: 'STR Req', width: '80px', type: 'number' as const, align: 'center' as const },
    { key: 'required_dexterity', label: 'DEX Req', width: '80px', type: 'number' as const, align: 'center' as const },
    { key: 'required_constitution', label: 'CON Req', width: '80px', type: 'number' as const, align: 'center' as const },
    { key: 'required_intelligence', label: 'INT Req', width: '80px', type: 'number' as const, align: 'center' as const },
    { key: 'required_wisdom', label: 'WIS Req', width: '80px', type: 'number' as const, align: 'center' as const },
    { key: 'required_charisma', label: 'CHA Req', width: '80px', type: 'number' as const, align: 'center' as const },
    { key: 'weapon_type_requirement', label: 'Weapon Type', width: '120px', type: 'select' as const, align: 'center' as const, options: [
      { value: '', label: 'None' },
      { value: 'sword', label: 'Sword' },
      { value: 'dual_sword', label: 'Dual Sword' },
      { value: 'greatsword', label: 'Greatsword' },
      { value: 'axe', label: 'Axe' },
      { value: 'greataxe', label: 'Greataxe' },
      { value: 'mace', label: 'Mace' },
      { value: 'dagger', label: 'Dagger' },
      { value: 'dual_dagger', label: 'Dual Dagger' },
      { value: 'spear', label: 'Spear' },
      { value: 'bow', label: 'Bow' },
      { value: 'staff', label: 'Staff' },
      { value: 'wand', label: 'Wand' }
    ]},
    { key: 'offhand_type_requirement', label: 'Offhand Type', width: '120px', type: 'select' as const, align: 'center' as const, options: [
      { value: '', label: 'None' },
      { value: 'shield', label: 'Shield' },
      { value: 'tome', label: 'Tome' },
      { value: 'orb', label: 'Orb' },
      { value: 'focus', label: 'Focus' },
      { value: 'quiver', label: 'Quiver' },
      { value: 'instrument', label: 'Instrument' },
      { value: 'dagger', label: 'Dagger' }
    ]},
    { key: 'mana_cost', label: 'Mana', width: '80px', type: 'number' as const, align: 'right' as const },
    { key: 'cooldown', label: 'Cooldown', width: '90px', type: 'number' as const, align: 'right' as const },
    { key: 'primary_stat', label: 'Primary Stat', width: '120px', type: 'select' as const, align: 'center' as const, options: [
      { value: '', label: 'None' },
      { value: 'strength', label: 'Strength' },
      { value: 'dexterity', label: 'Dexterity' },
      { value: 'intelligence', label: 'Intelligence' },
      { value: 'wisdom', label: 'Wisdom' },
      { value: 'charisma', label: 'Charisma' }
    ]},
    { key: 'stat_scaling', label: 'Scaling %', width: '90px', type: 'number' as const, align: 'right' as const },
    {
      key: 'actions',
      label: 'Actions',
      width: '120px',
      type: 'readonly' as const,
      align: 'center' as const,
      sortable: false,
      render: (value: any, row: any) => (
        <button
          class="button primary"
          style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem" }}
          onClick={async () => {
            setSelectedAbilityForEffects(row.id);
            setEditingAbilityEffect({
              ability_id: row.id,
              effect_order: 0,
              effect_type: 'damage',
              target: 'enemy',
              value_min: 0,
              value_max: 0,
              is_periodic: 0,
              tick_interval: 2.0,
              tick_count: 0,
              tick_value: 0,
              stat_affected: null,
              stat_scaling: null,
              scaling_factor: 0,
              duration: 0,
              chance: 1.0
            });
            setShowAbilityEffectModal(true);
          }}
        >
          Add Effect
        </button>
      )
    }
  ];
  
  const abilityFilters = [
    {
      key: 'type',
      label: 'Type',
      type: 'multiselect' as const,
      options: [
        { value: 'damage', label: 'Damage' },
        { value: 'heal', label: 'Heal' },
        { value: 'buff', label: 'Buff' },
        { value: 'debuff', label: 'Debuff' },
        { value: 'utility', label: 'Utility' },
        { value: 'passive', label: 'Passive' }
      ]
    },
    {
      key: 'category',
      label: 'Category',
      type: 'multiselect' as const,
      options: [
        { value: 'combat', label: 'Combat' },
        { value: 'passive', label: 'Passive' },
        { value: 'song', label: 'Song' },
        { value: 'crafting', label: 'Crafting' }
      ]
    },
    {
      key: 'primary_stat',
      label: 'Primary Stat',
      type: 'multiselect' as const,
      options: [
        { value: 'strength', label: 'Strength' },
        { value: 'dexterity', label: 'Dexterity' },
        { value: 'intelligence', label: 'Intelligence' },
        { value: 'wisdom', label: 'Wisdom' },
        { value: 'charisma', label: 'Charisma' }
      ]
    }
  ];
  
  // Bulk save handlers
  const handleBulkSaveItems = async (changes: Map<number | string, Partial<any>>) => {
    const promises = Array.from(changes.entries()).map(async ([id, fields]) => {
      const item = items().find((i: any) => i.id === id);
      if (!item) return;
      const updated = { ...item, ...fields };
      await updateItem(id as number, updated);
    });
    
    await Promise.all(promises);
    await reloadItems();
  };
  
  const handleBulkSaveAbilities = async (changes: Map<number | string, Partial<any>>) => {
    const promises = Array.from(changes.entries()).map(async ([id, fields]) => {
      const ability = abilities().find((a: any) => a.id === id);
      if (!ability) return;
      const updated = { ...ability, ...fields };
      await updateAbility(id as number, updated);
    });
    
    await Promise.all(promises);
    await reloadAbilities();
  };
  
  // Ability effects columns and handlers
  const abilityEffectColumns = [
    { key: 'ability_name', label: 'Ability', width: '150px', type: 'readonly' as const, align: 'left' as const },
    { key: 'effect_order', label: 'Order', width: '70px', type: 'number' as const, align: 'center' as const },
    { key: 'effect_type', label: 'Type', width: '120px', type: 'select' as const, align: 'left' as const, options: [
      { value: 'damage', label: 'Damage' },
      { value: 'heal', label: 'Heal' },
      { value: 'buff', label: 'Buff' },
      { value: 'debuff', label: 'Debuff' },
      { value: 'stun', label: 'Stun' },
      { value: 'dot', label: 'DOT' },
      { value: 'hot', label: 'HOT' },
      { value: 'shield', label: 'Shield' },
      { value: 'drain', label: 'Drain' }
    ]},
    { key: 'target', label: 'Target', width: '100px', type: 'select' as const, align: 'left' as const, options: [
      { value: 'self', label: 'Self' },
      { value: 'enemy', label: 'Enemy' },
      { value: 'ally', label: 'Ally' },
      { value: 'area', label: 'Area' }
    ]},
    { key: 'value_min', label: 'Min', width: '70px', type: 'number' as const, align: 'right' as const },
    { key: 'value_max', label: 'Max', width: '70px', type: 'number' as const, align: 'right' as const },
    { key: 'duration', label: 'Duration', width: '80px', type: 'number' as const, align: 'center' as const },
    { key: 'stat_affected', label: 'Stat', width: '100px', type: 'select' as const, align: 'left' as const, options: [
      { value: '', label: 'None' },
      { value: 'strength', label: 'Strength' },
      { value: 'dexterity', label: 'Dexterity' },
      { value: 'constitution', label: 'Constitution' },
      { value: 'intelligence', label: 'Intelligence' },
      { value: 'wisdom', label: 'Wisdom' },
      { value: 'charisma', label: 'Charisma' },
      { value: 'attack', label: 'Attack' },
      { value: 'defense', label: 'Defense' },
      { value: 'speed', label: 'Speed' }
    ]},
    { 
      key: 'stat_scaling', 
      label: 'Scaling Stat', 
      width: '120px', 
      type: 'select' as const, 
      align: 'left' as const, 
      options: [
        { value: '', label: 'None' },
        { value: 'strength', label: 'Strength' },
        { value: 'dexterity', label: 'Dexterity' },
        { value: 'intelligence', label: 'Intelligence' },
        { value: 'wisdom', label: 'Wisdom' },
        { value: 'charisma', label: 'Charisma' }
      ]
    },
    { key: 'scaling_factor', label: 'Factor', width: '70px', type: 'number' as const, align: 'right' as const },
    { key: 'is_periodic', label: 'Periodic', width: '80px', type: 'select' as const, align: 'center' as const, options: [
      { value: 0, label: 'No' },
      { value: 1, label: 'Yes' }
    ]},
    { key: 'tick_count', label: 'Ticks', width: '70px', type: 'number' as const, align: 'right' as const },
    { key: 'tick_value', label: 'Tick Val', width: '80px', type: 'number' as const, align: 'right' as const },
    { key: 'chance', label: 'Chance', width: '70px', type: 'number' as const, align: 'right' as const }
  ];
  
  const handleBulkSaveEffects = async (changes: Map<number | string, Partial<any>>) => {
    const promises = Array.from(changes.entries()).map(async ([id, fields]) => {
      const effect = allAbilityEffects().find((e: any) => e.id === id);
      if (!effect) return;
      const updated = { ...effect, ...fields };
      await updateAbilityEffect(id as number, updated);
    });
    
    await Promise.all(promises);
    await loadSelectedAbilityEffects();
  };
  
  const handleDeleteEffect = async (id: number | string) => {
    if (!confirm('Are you sure you want to delete this effect?')) return;
    try {
      await deleteAbilityEffect(Number(id));
      await loadSelectedAbilityEffects();
    } catch (err) {
      console.error('Error deleting effect:', err);
      alert('Failed to delete effect');
    }
  };
  
  // Ability selection for effects editing
  const [selectedAbilities, setSelectedAbilities] = createSignal<Set<number>>(new Set());
  const [allAbilityEffects, setAllAbilityEffects] = createSignal<any[]>([]);
  const [loadingEffects, setLoadingEffects] = createSignal(false);
  
  const toggleAbilitySelection = (abilityId: number) => {
    const selected = new Set<number>(selectedAbilities());
    if (selected.has(abilityId)) {
      selected.delete(abilityId);
    } else {
      selected.add(abilityId);
    }
    setSelectedAbilities(selected);
    loadSelectedAbilityEffects();
  };
  
  const selectAllAbilities = () => {
    const allIds = new Set<number>(abilities().map((a: any) => a.id));
    setSelectedAbilities(allIds);
    loadSelectedAbilityEffects();
  };
  
  const clearAbilitySelection = () => {
    setSelectedAbilities(new Set<number>());
    setAllAbilityEffects([]);
  };
  
  const loadSelectedAbilityEffects = async () => {
    const selected = selectedAbilities();
    if (selected.size === 0) {
      setAllAbilityEffects([]);
      return;
    }
    
    setLoadingEffects(true);
    try {
      const effectsPromises = Array.from(selected).map(async (abilityId) => {
        const effects = await getAbilityEffects(abilityId);
        return effects.map((effect: any) => ({
          ...effect,
          ability_id: abilityId,
          ability_name: abilities().find((a: any) => a.id === abilityId)?.name || `ID ${abilityId}`
        }));
      });
      
      const allEffects = await Promise.all(effectsPromises);
      setAllAbilityEffects(allEffects.flat());
    } catch (error) {
      console.error('Failed to load effects:', error);
    } finally {
      setLoadingEffects(false);
    }
  };
  

  
  // Handle mob edit/delete
  const handleEditMob = (mob: any) => {
    setEditingMob(mob);
    setShowMobModal(true);
  };
  
  const handleDeleteMob = async (id: number) => {
    if (!confirm('Are you sure you want to delete this mob?')) return;
    try {
      await deleteMob(id);
      await reloadMobs();
    } catch (err) {
      console.error('Error deleting mob:', err);
      alert('Failed to delete mob');
    }
  };
  
  const handleSaveMob = async (e: Event) => {
    e.preventDefault();
    const mob = editingMob();
    if (!mob) return;
    
    try {
      if (mob.id) {
        await updateMob(mob.id, mob);
      } else {
        await createMob(mob);
      }
      setShowMobModal(false);
      setEditingMob(null);
      await reloadMobs();
    } catch (err) {
      console.error('Error saving mob:', err);
      alert('Failed to save mob');
    }
  };
  
  // Handle item edit/delete
  const handleEditItem = (item: any) => {
    setEditingItem({...item});
    setShowItemModal(true);
  };
  
  const handleDeleteItem = async (id: number | string) => {
    if (!confirm('Are you sure you want to delete this item?')) return;
    try {
      await deleteItem(Number(id));
      await reloadItems();
    } catch (err) {
      console.error('Error deleting item:', err);
      alert('Failed to delete item');
    }
  };
  
  const handleSaveItem = async (e: Event) => {
    e.preventDefault();
    const item = editingItem();
    if (!item) return;
    
    try {
      if (item.id) {
        await updateItem(item.id, item);
      } else {
        await createItem(item);
      }
      setShowItemModal(false);
      setEditingItem(null);
      await reloadItems();
    } catch (err) {
      console.error('Error saving item:', err);
      alert('Failed to save item');
    }
  };
  
  // Handle mob loot edit/delete
  const handleEditMobLoot = (loot: any) => {
    setEditingMobLoot(loot);
    setShowMobLootModal(true);
  };
  
  const handleDeleteMobLoot = async (id: number) => {
    if (!confirm('Are you sure you want to delete this loot entry?')) return;
    try {
      await deleteMobLoot(id);
      await reloadMobLoot();
    } catch (err) {
      console.error('Error deleting loot:', err);
      alert('Failed to delete loot');
    }
  };
  
  const handleSaveMobLoot = async (e: Event) => {
    e.preventDefault();
    const loot = editingMobLoot();
    if (!loot) return;
    
    try {
      if (loot.id) {
        await updateMobLoot(loot.id, loot);
      } else {
        await createMobLoot(loot);
      }
      setShowMobLootModal(false);
      setEditingMobLoot(null);
      await reloadMobLoot();
    } catch (err) {
      console.error('Error saving loot:', err);
      alert('Failed to save loot');
    }
  };
  
  // Handle region rare loot edit/delete
  const handleEditRegionLoot = (loot: any) => {
    setEditingRegionLoot(loot);
    setShowRegionLootModal(true);
  };
  
  const handleDeleteRegionLoot = async (id: number) => {
    if (!confirm('Are you sure you want to delete this rare loot entry?')) return;
    try {
      await deleteRegionRareLoot(id);
      await reloadRegionLoot();
    } catch (err) {
      console.error('Error deleting rare loot:', err);
      alert('Failed to delete rare loot');
    }
  };
  
  const handleSaveRegionLoot = async (e: Event) => {
    e.preventDefault();
    const loot = editingRegionLoot();
    if (!loot) return;
    
    try {
      if (loot.id) {
        await updateRegionRareLoot(loot.id, loot);
      } else {
        await createRegionRareLoot(loot);
      }
      setShowRegionLootModal(false);
      setEditingRegionLoot(null);
      await reloadRegionLoot();
    } catch (err) {
      console.error('Error saving rare loot:', err);
      alert('Failed to save rare loot');
    }
  };
  
  // Handle ability edit/delete
  const handleEditAbility = (ability: any) => {
    setEditingAbility({...ability});
    setShowAbilityModal(true);
  };
  
  const handleDeleteAbility = async (id: number | string) => {
    if (!confirm('Are you sure you want to delete this ability?')) return;
    try {
      await deleteAbility(Number(id));
      await reloadAbilities();
    } catch (err) {
      console.error('Error deleting ability:', err);
      alert('Failed to delete ability');
    }
  };
  
  const handleSaveAbility = async (e: Event) => {
    e.preventDefault();
    const ability = editingAbility();
    if (!ability) return;
    
    try {
      if (ability.id) {
        await updateAbility(ability.id, ability);
      } else {
        await createAbility(ability);
      }
      setShowAbilityModal(false);
      setEditingAbility(null);
      await reloadAbilities();
    } catch (err) {
      console.error('Error saving ability:', err);
      alert('Failed to save ability');
    }
  };
  
  // Handle ability effects edit/delete
  const handleEditAbilityEffect = (effect: any) => {
    setEditingAbilityEffect({...effect});
  };
  
  const handleDeleteAbilityEffect = async (id: number) => {
    if (!confirm('Are you sure you want to delete this effect?')) return;
    try {
      await deleteAbilityEffect(id);
      const abilityId = selectedAbilityForEffects();
      if (abilityId) {
        const effects = await getAbilityEffects(abilityId);
        setAbilityEffects(effects as any);
      }
    } catch (err) {
      console.error('Error deleting effect:', err);
      alert('Failed to delete effect');
    }
  };
  
  const handleSaveAbilityEffect = async (e: Event) => {
    e.preventDefault();
    const effect = editingAbilityEffect();
    if (!effect) return;
    
    try {
      if (effect.id) {
        await updateAbilityEffect(effect.id, effect);
      } else {
        const abilityId = selectedAbilityForEffects();
        if (!abilityId) return;
        effect.ability_id = abilityId;
        await createAbilityEffect(effect);
      }
      setEditingAbilityEffect(null);
      const abilityId = selectedAbilityForEffects();
      if (abilityId) {
        const effects = await getAbilityEffects(abilityId);
        setAbilityEffects(effects as any);
      }
    } catch (err) {
      console.error('Error saving effect:', err);
      alert('Failed to save effect');
    }
  };
  
  // Handle region edit/delete
  const handleEditRegion = (region: any) => {
    setEditingRegion({...region});
    setShowRegionModal(true);
  };
  
  const handleDeleteRegion = async (id: number) => {
    if (!confirm('Are you sure you want to delete this region? This may break the game if characters are in this region.')) return;
    try {
      await deleteRegion(id);
      await reloadRegions();
    } catch (err) {
      console.error('Error deleting region:', err);
      alert('Failed to delete region');
    }
  };
  
  const handleSaveRegion = async (e: Event) => {
    e.preventDefault();
    const region = editingRegion();
    if (!region) return;
    
    try {
      if (region.id) {
        await updateRegion(region.id, region);
      } else {
        await createRegion(region);
      }
      setShowRegionModal(false);
      setEditingRegion(null);
      await reloadRegions();
    } catch (err) {
      console.error('Error saving region:', err);
      alert('Failed to save region');
    }
  };
  
  // Handle merchant edit/delete
  const handleEditMerchant = (merchant: any) => {
    setEditingMerchant({...merchant});
    setShowMerchantModal(true);
  };
  
  const handleDeleteMerchant = async (id: number) => {
    if (!confirm('Are you sure you want to delete this merchant?')) return;
    try {
      await deleteMerchant(id);
      await reloadMerchants();
    } catch (err) {
      console.error('Error deleting merchant:', err);
      alert('Failed to delete merchant');
    }
  };
  
  const handleSaveMerchant = async (e: Event) => {
    e.preventDefault();
    const merchant = editingMerchant();
    if (!merchant) return;
    
    try {
      if (merchant.id) {
        await updateMerchant(merchant.id, merchant);
      } else {
        await createMerchant(merchant);
      }
      setShowMerchantModal(false);
      setEditingMerchant(null);
      await reloadMerchants();
    } catch (err) {
      console.error('Error saving merchant:', err);
      alert('Failed to save merchant');
    }
  };
  
  // Reload functions for new tables
  const reloadSubAreaMobs = async () => {
    const data = await getAllSubAreaMobs();
    setSubAreaMobs(data as any);
  };
  
  const reloadMerchantInventory = async () => {
    const data = await getAllMerchantInventory();
    setMerchantInventory(data as any);
  };
  
  // Handle sub-area mob spawns edit/delete  
  const handleDeleteSubAreaMob = async (id: number) => {
    if (!confirm('Are you sure you want to remove this mob from the sub-area?')) return;
    try {
      await deleteSubAreaMob(id);
      await reloadSubAreaMobs();
    } catch (err) {
      console.error('Error deleting sub-area mob:', err);
      alert('Failed to delete sub-area mob');
    }
  };
  
  const handleSaveSubAreaMob = async (e: Event) => {
    e.preventDefault();
    const subAreaMob = editingSubAreaMob();
    if (!subAreaMob) return;
    
    try {
      if (subAreaMob.id) {
        await updateSubAreaMob(subAreaMob.id, subAreaMob);
      } else {
        await createSubAreaMob(subAreaMob);
      }
      setShowSubAreaMobModal(false);
      setEditingSubAreaMob(null);
      await reloadSubAreaMobs();
    } catch (err) {
      console.error('Error saving sub-area mob:', err);
      alert('Failed to save sub-area mob');
    }
  };
  
  const handleEditSubAreaMob = (subAreaMob: any) => {
    setEditingSubAreaMob(subAreaMob);
    setShowSubAreaMobModal(true);
  };
  
  // Handle merchant inventory edit/delete
  const handleEditMerchantInv = (inv: any) => {
    setEditingMerchantInv({...inv});
    setShowMerchantInvModal(true);
  };
  
  const handleDeleteMerchantInv = async (id: number) => {
    if (!confirm('Are you sure you want to remove this item from the merchant?')) return;
    try {
      await deleteMerchantInventory(id);
      await reloadMerchantInventory();
    } catch (err) {
      console.error('Error deleting merchant inventory:', err);
      alert('Failed to delete merchant inventory');
    }
  };
  
  const handleSaveMerchantInv = async (e: Event) => {
    e.preventDefault();
    const inv = editingMerchantInv();
    if (!inv) return;
    
    try {
      if (inv.id) {
        await updateMerchantInventory(inv.id, inv);
      } else {
        await createMerchantInventory(inv);
      }
      setShowMerchantInvModal(false);
      setEditingMerchantInv(null);
      await reloadMerchantInventory();
    } catch (err) {
      console.error('Error saving merchant inventory:', err);
      alert('Failed to save merchant inventory');
    }
  };
  
  // Handle character editing
  const handleEditCharacter = async (player: any) => {
    if (!player.character_id) return;
    
    try {
      const charData = await getCharacter(player.character_id);
      const inventory = await getCharacterInventory(player.character_id);
      const abilities = await getCharacterAbilities(player.character_id);
      const regionUnlocks = await getCharacterRegionUnlocks(player.character_id);
      const professions = await getCharacterProfessions(player.character_id);
      
      setEditingCharacter(charData);
      setCharacterInventory(inventory as any);
      setCharacterAbilities(abilities as any);
      setCharacterRegionUnlocks(regionUnlocks as any);
      setCharacterProfessions(professions as any);
      setCharacterModalTab('stats');
      setShowCharacterModal(true);
    } catch (err) {
      console.error('Error loading character:', err);
      alert('Failed to load character');
    }
  };
  
  const handleSaveCharacter = async (e: Event) => {
    e.preventDefault();
    const char = editingCharacter();
    if (!char) return;
    
    try {
      await updateCharacter(char.id, char);
      setShowCharacterModal(false);
      setEditingCharacter(null);
      
      // Reload players
      const playersData = await getAllPlayers();
      setPlayers(playersData as any);
    } catch (err) {
      console.error('Error saving character:', err);
      alert('Failed to save character');
    }
  };
  
  const handleAddItemToCharacter = async () => {
    setSearchAddItem("");
    setSelectedItemToAdd(null);
    setItemQuantityToAdd(1);
    setShowAddItemModal(true);
  };
  
  const handleConfirmAddItem = async () => {
    const char = editingCharacter();
    const itemId = selectedItemToAdd();
    const quantity = itemQuantityToAdd();
    
    if (!char || !itemId || quantity <= 0) return;
    
    try {
      await addItemToCharacter(char.id, itemId, quantity);
      const inventory = await getCharacterInventory(char.id);
      setCharacterInventory(inventory as any);
      setShowAddItemModal(false);
    } catch (err) {
      console.error('Error adding item:', err);
      alert('Failed to add item');
    }
  };
  
  const handleRemoveItemFromCharacter = async (inventoryId: number) => {
    if (!confirm('Remove this item from inventory?')) return;
    
    try {
      await removeItemFromCharacter(inventoryId);
      const char = editingCharacter();
      if (char) {
        const inventory = await getCharacterInventory(char.id);
        setCharacterInventory(inventory as any);
      }
    } catch (err) {
      console.error('Error removing item:', err);
      alert('Failed to remove item');
    }
  };
  
  const handleUpdateInventoryItem = async (inventoryId: number, quantity: number, equipped: number) => {
    try {
      await updateCharacterInventoryItem(inventoryId, quantity, equipped);
      const char = editingCharacter();
      if (char) {
        const inventory = await getCharacterInventory(char.id);
        setCharacterInventory(inventory as any);
      }
    } catch (err) {
      console.error('Error updating item:', err);
      alert('Failed to update item');
    }
  };
  
  const handleAddAbilityToCharacter = async () => {
    setSearchAddAbility("");
    setSelectedAbilityToAdd(null);
    setShowAddAbilityModal(true);
  };
  
  const handleConfirmAddAbility = async () => {
    const char = editingCharacter();
    const abilityId = selectedAbilityToAdd();
    
    if (!char || !abilityId) return;
    
    try {
      await addAbilityToCharacter(char.id, abilityId);
      const charAbilities = await getCharacterAbilities(char.id);
      setCharacterAbilities(charAbilities as any);
      setShowAddAbilityModal(false);
    } catch (err) {
      console.error('Error adding ability:', err);
      alert('Failed to add ability');
    }
  };
  
  const handleRemoveAbilityFromCharacter = async (characterAbilityId: number) => {
    if (!confirm('Remove this ability?')) return;
    
    try {
      await removeAbilityFromCharacter(characterAbilityId);
      const char = editingCharacter();
      if (char) {
        const charAbilities = await getCharacterAbilities(char.id);
        setCharacterAbilities(charAbilities as any);
      }
    } catch (err) {
      console.error('Error removing ability:', err);
      alert('Failed to remove ability');
    }
  };
  
  const handleToggleRegionUnlock = async (regionId: number, currentlyUnlocked: boolean) => {
    const char = editingCharacter();
    if (!char) return;
    
    try {
      if (currentlyUnlocked) {
        await lockRegionForCharacter(char.id, regionId);
      } else {
        await unlockRegionForCharacter(char.id, regionId);
      }
      
      // Reload region unlocks
      const regionUnlocks = await getCharacterRegionUnlocks(char.id);
      setCharacterRegionUnlocks(regionUnlocks as any);
    } catch (err) {
      console.error('Error toggling region unlock:', err);
      alert('Failed to toggle region unlock');
    }
  };
  
  const handleSaveProfessions = async () => {
    const char = editingCharacter();
    if (!char) return;
    
    try {
      // Update each profession
      for (const profession of characterProfessions()) {
        await updateCharacterProfession(char.id, profession.profession_type, {
          level: profession.level,
          experience: profession.experience
        });
      }
      
      alert('Professions saved successfully');
    } catch (err) {
      console.error('Error saving professions:', err);
      alert('Failed to save professions');
    }
  };

  onMount(async () => {
    try {
      // Check if user is logged in
      const user = await getUser();
      if (!user) {
        navigate("/");
        return;
      }
      
      // Check if user is GM
      const gmStatus = await isGM();
      if (!gmStatus) {
        navigate("/");
        return;
      }
      
      // User is authorized, load data
      setAuthorized(true);
      
      const [playersData, mobsData, itemsData, regionsData, abilitiesData, merchantsData, mobLootData, regionLootData, subAreaMobsData, subAreasData, merchantInvData, questsResponse] = await Promise.all([
        getAllPlayers(),
        getAllMobs(),
        getAllItems(),
        getAllRegions(),
        getAllAbilities(),
        getAllMerchants(),
        getAllMobLoot(),
        getAllRegionRareLoot(),
        getAllSubAreaMobs(),
        getAllSubAreas(),
        getAllMerchantInventory(),
        fetch('/api/gm/quests').then(r => r.json()),
      ]);
      
      setPlayers(playersData as any);
      setMobs(mobsData as any);
      setItems(itemsData as any);
      setRegions(regionsData as any);
      setAbilities(abilitiesData as any);
      setMerchants(merchantsData as any);
      setMobLoot(mobLootData as any);
      setRegionRareLoot(regionLootData as any);
      setSubAreaMobs(subAreaMobsData as any);
      setSubAreas(subAreasData as any);
      setMerchantInventory(merchantInvData as any);
      setQuests(questsResponse.quests || []);
    } catch (err) {
      console.error('GM page error:', err);
      navigate("/");
    } finally {
      setLoading(false);
    }
  });
  
  return (
    <div style={{ padding: "2rem", "max-width": "1400px", margin: "0 auto" }}>
      <Show when={loading()}>
        <div class="card">
          <p>Loading GM Panel...</p>
        </div>
      </Show>
      <Show when={!loading() && authorized()}>
        <div>
          <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "2rem" }}>
            <h1>Game Master Control Panel</h1>
            <A href="/" class="button secondary">Back to Game</A>
          </div>
          
          {/* Tabs */}
          <div style={{ 
            display: "flex", 
            gap: "0.5rem", 
            "margin-bottom": "2rem", 
            "flex-wrap": "wrap",
            "border-bottom": "2px solid var(--bg-light)",
            "padding-bottom": "0.5rem"
          }}>
            <button
              class={activeTab() === "players" ? "button primary" : "button secondary"}
              onClick={() => setActiveTab("players")}
            >
              Players
            </button>
            <button
              class={activeTab() === "mobs" ? "button primary" : "button secondary"}
              onClick={() => setActiveTab("mobs")}
            >
              Mobs
            </button>
            <button
              class={activeTab() === "items" ? "button primary" : "button secondary"}
              onClick={() => setActiveTab("items")}
            >
              Items
            </button>
            <button
              class={activeTab() === "abilities" ? "button primary" : "button secondary"}
              onClick={() => setActiveTab("abilities")}
            >
              Abilities
            </button>
            <button
              class={activeTab() === "regions" ? "button primary" : "button secondary"}
              onClick={() => setActiveTab("regions")}
            >
              Regions
            </button>
            <button
              class={activeTab() === "merchants" ? "button primary" : "button secondary"}
              onClick={() => setActiveTab("merchants")}
            >
              Merchants
            </button>
            <button
              class={activeTab() === "quests" ? "button primary" : "button secondary"}
              onClick={() => setActiveTab("quests")}
            >
              Quests
            </button>
            <button
              class={activeTab() === "loot" ? "button primary" : "button secondary"}
              onClick={() => setActiveTab("loot")}
            >
              Loot Tables
            </button>
            <button
              class={activeTab() === "spawns" ? "button primary" : "button secondary"}
              onClick={() => setActiveTab("spawns")}
            >
              Mob Spawns
            </button>
            <button
              class={activeTab() === "inventory" ? "button primary" : "button secondary"}
              onClick={() => setActiveTab("inventory")}
            >
              Merchant Inventory
            </button>
          </div>
          
          {/* Players Tab */}
          <Show when={activeTab() === "players"}>
            <div class="card">
              <h2>Players & Characters</h2>
              <div style={{ "margin-bottom": "1rem" }}>
                <input 
                  type="text" 
                  placeholder="Search by username, character, or region..." 
                  value={searchPlayers()}
                  onInput={(e) => setSearchPlayers(e.currentTarget.value)}
                  style={{ width: "100%", padding: "0.5rem" }}
                />
              </div>
              <Show when={players()}>
                <div style={{ overflow: "auto", "max-height": "600px" }}>
                  <table style={{ width: "100%", "border-collapse": "collapse" }}>
                    <thead style={{ position: "sticky", top: 0, background: "var(--bg-dark)" }}>
                      <tr style={{ "border-bottom": "2px solid var(--bg-light)" }}>
                        <th style={{ padding: "0.5rem", "text-align": "left" }}>User</th>
                        <th style={{ padding: "0.5rem", "text-align": "left" }}>Character</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Level</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>XP</th>
                        <th style={{ padding: "0.5rem", "text-align": "right" }}>Gold</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>HP</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Mana</th>
                        <th style={{ padding: "0.5rem", "text-align": "left" }}>Region</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>GM</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <For each={players().filter((p: any) => {
                        const search = searchPlayers().toLowerCase();
                        if (!search) return true;
                        return (
                          p.username?.toLowerCase().includes(search) ||
                          p.character_name?.toLowerCase().includes(search) ||
                          p.current_region?.toLowerCase().includes(search)
                        );
                      })}>
                        {(player: any) => (
                          <tr style={{ "border-bottom": "1px solid var(--bg-light)" }}>
                            <td style={{ padding: "0.5rem" }}>{player.username}</td>
                            <td style={{ padding: "0.5rem" }}>{player.character_name || "-"}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>{player.level || "-"}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>{player.experience || "0"}</td>
                            <td style={{ padding: "0.5rem", "text-align": "right" }}>{player.gold || "0"}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>
                              {player.current_health ? `${player.current_health}/${player.max_health}` : "-"}
                            </td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>
                              {player.current_mana ? `${player.current_mana}/${player.max_mana}` : "-"}
                            </td>
                            <td style={{ padding: "0.5rem" }}>{player.current_region || "-"}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>
                              {player.is_gm ? "Yes" : ""}
                            </td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>
                              <Show when={player.character_id}>
                                <button 
                                  class="button secondary" 
                                  style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem" }}
                                  onClick={() => handleEditCharacter(player)}
                                >
                                  Edit
                                </button>
                              </Show>
                            </td>
                          </tr>
                        )}
                      </For>
                    </tbody>
                  </table>
                </div>
              </Show>
            </div>
          </Show>
          
          {/* Mobs Tab */}
          <Show when={activeTab() === "mobs"}>
            <div class="card" style={{ "margin-bottom": "1rem" }}>
              <h3 style={{ "margin-bottom": "1rem" }}>Experience Calculator</h3>
              <div style={{ display: "grid", "grid-template-columns": "repeat(auto-fit, minmax(200px, 1fr))", gap: "1rem", "margin-bottom": "1rem" }}>
                <div style={{ padding: "0.75rem", background: "var(--bg-light)", "border-radius": "4px" }}>
                  <div style={{ "font-size": "0.85rem", color: "var(--text-secondary)", "margin-bottom": "0.25rem" }}>XP Formula</div>
                  <div style={{ "font-weight": "bold" }}>Level  125</div>
                </div>
                <div style={{ padding: "0.75rem", background: "var(--bg-light)", "border-radius": "4px" }}>
                  <div style={{ "font-size": "0.85rem", color: "var(--text-secondary)", "margin-bottom": "0.25rem" }}>Stat Points/Level</div>
                  <div style={{ "font-weight": "bold" }}>3 points</div>
                </div>
                <div style={{ padding: "0.75rem", background: "var(--bg-light)", "border-radius": "4px" }}>
                  <div style={{ "font-size": "0.85rem", color: "var(--text-secondary)", "margin-bottom": "0.25rem" }}>Death Penalty</div>
                  <div style={{ "font-weight": "bold" }}>-25% XP, -10% Gold</div>
                </div>
              </div>
              <div style={{ padding: "1rem", background: "var(--bg-light)", "border-radius": "8px" }}>
                <h4 style={{ "margin-bottom": "1rem" }}>XP Calculator</h4>
                <div style={{ display: "grid", "grid-template-columns": "200px 1fr", gap: "1rem", "align-items": "start" }}>
                  <div>
                    <label style={{ display: "block", "margin-bottom": "0.5rem", "font-weight": "bold" }}>Character Level</label>
                    <input 
                      type="number" 
                      min="1" 
                      max="100" 
                      value={calcLevel()} 
                      onInput={(e) => setCalcLevel(parseInt(e.currentTarget.value) || 1)}
                      style={{ width: "100%", padding: "0.5rem", "font-size": "1rem" }}
                    />
                  </div>
                  <div>
                    <div style={{ "margin-bottom": "0.5rem" }}>
                      <strong>XP Needed for Level {calcLevel()}  {calcLevel() + 1}:</strong> {calcLevel() * 125} XP
                    </div>
                    <div style={{ display: "grid", "grid-template-columns": "repeat(3, 1fr)", gap: "1rem", "margin-top": "1rem" }}>
                      <div style={{ padding: "1rem", background: "var(--bg-dark)", "border-radius": "4px", border: "2px solid var(--warning)" }}>
                        <div style={{ "font-size": "0.85rem", color: "var(--text-secondary)", "margin-bottom": "0.25rem" }}>Fast (5 kills)</div>
                        <div style={{ "font-size": "1.5rem", "font-weight": "bold", color: "var(--warning)" }}>{Math.ceil((calcLevel() * 125) / 5)} XP</div>
                        <div style={{ "font-size": "0.75rem", color: "var(--text-secondary)", "margin-top": "0.25rem" }}>per mob</div>
                      </div>
                      <div style={{ padding: "1rem", background: "var(--bg-dark)", "border-radius": "4px", border: "2px solid var(--success)" }}>
                        <div style={{ "font-size": "0.85rem", color: "var(--text-secondary)", "margin-bottom": "0.25rem" }}>Medium (10 kills)</div>
                        <div style={{ "font-size": "1.5rem", "font-weight": "bold", color: "var(--success)" }}>{Math.ceil((calcLevel() * 125) / 10)} XP</div>
                        <div style={{ "font-size": "0.75rem", color: "var(--text-secondary)", "margin-top": "0.25rem" }}>per mob</div>
                      </div>
                      <div style={{ padding: "1rem", background: "var(--bg-dark)", "border-radius": "4px", border: "2px solid var(--accent)" }}>
                        <div style={{ "font-size": "0.85rem", color: "var(--text-secondary)", "margin-bottom": "0.25rem" }}>Slow (15 kills)</div>
                        <div style={{ "font-size": "1.5rem", "font-weight": "bold", color: "var(--accent)" }}>{Math.ceil((calcLevel() * 125) / 15)} XP</div>
                        <div style={{ "font-size": "0.75rem", color: "var(--text-secondary)", "margin-top": "0.25rem" }}>per mob</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card">
              <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
                <h2>Mobs</h2>
                <button class="button primary" onClick={() => {
                  setEditingMob({
                    name: '', level: 1, area: '', max_health: 100,
                    attack: 10, defense: 5, experience: 10,
                    gold_min: 1, gold_max: 5, attack_speed: 1.0, region_id: 1
                  });
                  setShowMobModal(true);
                }}>
                  Add Mob
                </button>
              </div>
              <div style={{ "margin-bottom": "1rem" }}>
                <input 
                  type="text" 
                  placeholder="Search by name, level, or region..." 
                  value={searchMobs()}
                  onInput={(e) => setSearchMobs(e.currentTarget.value)}
                  style={{ width: "100%", padding: "0.5rem" }}
                />
              </div>
              <Show when={mobs()}>
                <div style={{ overflow: "auto", "max-height": "600px" }}>
                  <table style={{ width: "100%", "border-collapse": "collapse", "font-size": "0.9rem" }}>
                    <thead style={{ position: "sticky", top: 0, background: "var(--bg-dark)" }}>
                      <tr style={{ "border-bottom": "2px solid var(--bg-light)" }}>
                        <th style={{ padding: "0.5rem", "text-align": "left" }}>Name</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Lvl</th>
                        <th style={{ padding: "0.5rem", "text-align": "right" }}>HP</th>
                        <th style={{ padding: "0.5rem", "text-align": "right" }}>Atk</th>
                        <th style={{ padding: "0.5rem", "text-align": "right" }}>Def</th>
                        <th style={{ padding: "0.5rem", "text-align": "right" }}>XP</th>
                        <th style={{ padding: "0.5rem", "text-align": "right" }}>Gold</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Region</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <For each={mobs().filter((m: any) => {
                        const search = searchMobs().toLowerCase();
                        if (!search) return true;
                        return (
                          m.name?.toLowerCase().includes(search) ||
                          m.level?.toString().includes(search) ||
                          m.region_id?.toString().includes(search)
                        );
                      })}>
                        {(mob: any) => (
                          <tr style={{ "border-bottom": "1px solid var(--bg-light)" }}>
                            <td style={{ padding: "0.5rem" }}>{mob.name}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>{mob.level}</td>
                            <td style={{ padding: "0.5rem", "text-align": "right" }}>{mob.max_health}</td>
                            <td style={{ padding: "0.5rem", "text-align": "right" }}>{mob.attack}</td>
                            <td style={{ padding: "0.5rem", "text-align": "right" }}>{mob.defense}</td>
                            <td style={{ padding: "0.5rem", "text-align": "right" }}>
                              <div style={{ display: "flex", "align-items": "center", "justify-content": "flex-end", gap: "0.5rem" }}>
                                <span>{mob.experience}</span>
                                <span style={{ 
                                  "font-size": "0.7rem", 
                                  padding: "0.1rem 0.3rem", 
                                  "border-radius": "3px",
                                  background: getXPStatus(mob.level, mob.experience).color,
                                  color: "#fff"
                                }} title={getXPStatus(mob.level, mob.experience).text}>
                                  {getXPStatus(mob.level, mob.experience).status === 'low' ? '' : 
                                   getXPStatus(mob.level, mob.experience).status === 'high' ? 'High' : 'Yes'}
                                </span>
                              </div>
                            </td>
                            <td style={{ padding: "0.5rem", "text-align": "right" }}>
                              {mob.gold_min}-{mob.gold_max}
                            </td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>{mob.region_id || "-"}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>
                              <button 
                                class="button secondary" 
                                style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", "margin-right": "0.25rem" }}
                                onClick={() => handleEditMob(mob)}
                              >
                                Edit
                              </button>
                              <button 
                                class="button" 
                                style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", background: "var(--danger)" }}
                                onClick={() => handleDeleteMob(mob.id)}
                              >
                                Delete
                              </button>
                            </td>
                          </tr>
                        )}
                      </For>
                    </tbody>
                  </table>
                </div>
              </Show>
            </div>
          </Show>
          
          {/* Items Tab */}
          <Show when={activeTab() === "items"}>
            {/* Ability Lookup Helper */}
            <div class="card" style={{ "margin-bottom": "1rem" }}>
              <details>
                <summary style={{ 
                  cursor: "pointer", 
                  "font-weight": "600",
                  padding: "0.5rem",
                  "user-select": "none",
                  display: "flex",
                  "align-items": "center",
                  gap: "0.5rem"
                }}>
                  <span> Ability Lookup</span>
                  <span style={{ 
                    "font-size": "0.85rem", 
                    color: "var(--text-secondary)",
                    "font-weight": "normal"
                  }}>
                    (for "Teaches Ability ID" column)
                  </span>
                </summary>
                <div style={{ padding: "1rem", "padding-top": "0.5rem" }}>
                  <input
                    type="text"
                    placeholder="Search abilities by name..."
                    value={searchAbilityLookup()}
                    onInput={(e) => setSearchAbilityLookup(e.currentTarget.value)}
                    style={{ 
                      width: "100%", 
                      padding: "0.5rem",
                      "margin-bottom": "0.5rem"
                    }}
                  />
                  <div style={{ 
                    "max-height": "200px", 
                    overflow: "auto",
                    border: "1px solid var(--border)",
                    "border-radius": "4px"
                  }}>
                    <For each={abilities().filter((a: any) => 
                      !searchAbilityLookup() || 
                      a.name?.toLowerCase().includes(searchAbilityLookup().toLowerCase()) ||
                      a.id?.toString().includes(searchAbilityLookup())
                    ).slice(0, 20)}>
                      {(ability: any) => (
                        <div 
                          style={{ 
                            padding: "0.5rem",
                            display: "flex",
                            "justify-content": "space-between",
                            "align-items": "center",
                            "border-bottom": "1px solid var(--border)",
                            cursor: "pointer",
                            background: "var(--bg-medium)"
                          }}
                          onClick={() => {
                            navigator.clipboard.writeText(ability.id.toString());
                            setCopiedAbilityId(ability.id);
                            setTimeout(() => setCopiedAbilityId(null), 2000);
                          }}
                          title="Click to copy ID to clipboard"
                        >
                          <div>
                            <span style={{ "font-weight": "600" }}>{ability.name}</span>
                            <span style={{ 
                              "margin-left": "0.5rem",
                              color: "var(--text-secondary)",
                              "font-size": "0.85rem"
                            }}>
                              ({ability.type})
                            </span>
                          </div>
                          <div style={{ display: "flex", "align-items": "center", gap: "0.5rem" }}>
                            <span style={{ 
                              padding: "0.2rem 0.5rem",
                              background: "var(--accent)",
                              "border-radius": "4px",
                              "font-weight": "600",
                              color: "var(--bg-dark)"
                            }}>
                              ID: {ability.id}
                            </span>
                            <Show when={copiedAbilityId() === ability.id}>
                              <span style={{ color: "var(--success)", "font-size": "0.85rem" }}>
                                 Copied!
                              </span>
                            </Show>
                          </div>
                        </div>
                      )}
                    </For>
                  </div>
                  <p style={{ 
                    "margin-top": "0.5rem",
                    "font-size": "0.85rem",
                    color: "var(--text-secondary)"
                  }}>
                     Click any ability to copy its ID to clipboard, then paste into "Teaches" column
                  </p>
                </div>
              </details>
            </div>
            
            <BulkEditTable
              data={items()}
              columns={itemColumns}
              filters={itemFilters}
              onSave={handleBulkSaveItems}
              onDelete={handleDeleteItem}
              onCreate={() => {
                setEditingItem({
                  name: '', description: '', type: 'weapon', slot: 'weapon',
                  rarity: 'common', level: 1, value: 1, damage_min: 0, damage_max: 0, armor: 0,
                  strength_bonus: 0, dexterity_bonus: 0, constitution_bonus: 0,
                  intelligence_bonus: 0, wisdom_bonus: 0, charisma_bonus: 0,
                  attack_speed: 1.0, stackable: 0
                });
                setShowItemModal(true);
              }}
              getRowId={(row) => row.id}
              title="Items"
            />
          </Show>
          
          {/* Abilities Tab */}
          <Show when={activeTab() === "abilities"}>
            <BulkEditTable
              data={abilities()}
              columns={abilityColumns}
              filters={abilityFilters}
              onSave={handleBulkSaveAbilities}
              onDelete={handleDeleteAbility}
              onCreate={() => {
                setEditingAbility({
                  name: '', description: '', type: 'damage', category: 'combat',
                  required_level: 1, mana_cost: 0, cooldown: 0, primary_stat: null,
                  stat_scaling: 0,
                  required_strength: 0, required_dexterity: 0, required_constitution: 0,
                  required_intelligence: 0, required_wisdom: 0, required_charisma: 0
                });
                setShowAbilityModal(true);
              }}
              getRowId={(row) => row.id}
              title="Abilities"
            />
            
            {/* Selected Abilities Effects Table */}
            <Show when={selectedAbilities().size > 0}>
              <div style={{ "margin-top": "1rem" }}>
                <div style={{ 
                  display: "flex", 
                  "justify-content": "space-between", 
                  "align-items": "center", 
                  "margin-bottom": "0.5rem",
                  padding: "0.5rem 1rem",
                  background: "var(--bg-medium)",
                  "border-radius": "4px"
                }}>
                  <h3 style={{ margin: 0 }}>
                    Effects for Selected Abilities ({selectedAbilities().size})
                  </h3>
                  <button
                    class="button secondary"
                    onClick={clearAbilitySelection}
                  >
                    Clear Selection
                  </button>
                </div>
                
                <Show when={loadingEffects()}>
                  <div class="card">
                    <p>Loading effects...</p>
                  </div>
                </Show>
                
                <Show when={!loadingEffects() && allAbilityEffects().length === 0}>
                  <div class="card">
                    <p style={{ color: "var(--text-secondary)", "font-style": "italic" }}>
                      Selected abilities have no effects configured
                    </p>
                  </div>
                </Show>
                
                <Show when={!loadingEffects() && allAbilityEffects().length > 0}>
                  <BulkEditTable
                    data={allAbilityEffects()}
                    columns={abilityEffectColumns}
                    onSave={handleBulkSaveEffects}
                    onDelete={handleDeleteEffect}
                    getRowId={(row) => row.id}
                    title={`${allAbilityEffects().length} Effects`}
                  />
                </Show>
              </div>
            </Show>
          </Show>
          
          {/* Regions Tab */}
          <Show when={activeTab() === "regions"}>
            <div class="card">
              <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
                <h2>Regions ({regions()?.length || 0})</h2>
                <button class="button primary" onClick={() => {
                  setEditingRegion({
                    name: '', description: '', min_level: 1, max_level: 5,
                    locked: 0, unlock_requirement: null
                  });
                  setShowRegionModal(true);
                }}>
                  Add Region
                </button>
              </div>
              <div style={{ "margin-bottom": "1rem" }}>
                <input 
                  type="text" 
                  placeholder="Search by name or description..." 
                  value={searchRegions()}
                  onInput={(e) => setSearchRegions(e.currentTarget.value)}
                  style={{ width: "100%", padding: "0.5rem" }}
                />
              </div>
              <Show when={regions()}>
                <div style={{ display: "grid", gap: "1rem", overflow: "auto", "max-height": "600px" }}>
                  <For each={regions().filter((r: any) => {
                    const search = searchRegions().toLowerCase();
                    if (!search) return true;
                    return (
                      r.name?.toLowerCase().includes(search) ||
                      r.description?.toLowerCase().includes(search)
                    );
                  })}>
                    {(region: any) => (
                      <div style={{ 
                        padding: "1rem", 
                        background: "var(--bg-light)", 
                        "border-radius": "8px",
                        border: "2px solid var(--accent)",
                        position: "relative"
                      }}>
                        <div style={{ display: "flex", "justify-content": "space-between", "align-items": "start" }}>
                          <div style={{ flex: 1 }}>
                            <h3 style={{ margin: "0 0 0.5rem 0" }}>
                              {region.name}
                              {region.locked === 1 && <span style={{ "margin-left": "0.5rem", "font-size": "0.8rem", color: "var(--warning)" }}>Locked</span>}
                            </h3>
                            <p style={{ margin: "0 0 0.5rem 0", color: "var(--text-secondary)" }}>
                              {region.description}
                            </p>
                            <div style={{ display: "flex", gap: "2rem", "font-size": "0.9rem" }}>
                              <div>
                                <strong>Level Range:</strong> {region.min_level}-{region.max_level}
                              </div>
                              <div>
                                <strong>Unlock Requirement:</strong> {region.unlock_requirement || "None"}
                              </div>
                            </div>
                          </div>
                          <div style={{ display: "flex", gap: "0.5rem", "margin-left": "1rem" }}>
                            <button 
                              class="button secondary" 
                              style={{ padding: "0.5rem 1rem", "font-size": "0.9rem" }}
                              onClick={() => handleEditRegion(region)}
                            >
                              Edit
                            </button>
                            <button 
                              class="button" 
                              style={{ padding: "0.5rem 1rem", "font-size": "0.9rem", background: "var(--danger)" }}
                              onClick={() => handleDeleteRegion(region.id)}
                            >
                              Delete
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </For>
                </div>
              </Show>
            </div>
          </Show>
          
          {/* Quests Tab */}
          <Show when={activeTab() === "quests"}>
            <div class="card" style={{ "margin-bottom": "1rem" }}>
              <h2 style={{ "margin-bottom": "1rem" }}>Quest Management</h2>
              
              <div style={{ display: "grid", "grid-template-columns": "1fr auto", gap: "1rem", "margin-bottom": "1rem" }}>
                <div>
                  <label>Filter by Region</label>
                  <select value={questFilterRegion() || ''} onChange={(e) => setQuestFilterRegion(e.currentTarget.value ? Number(e.currentTarget.value) : null)}>
                    <option value="">All Regions</option>
                    <For each={allRegions()}>
                      {(region) => <option value={region.id}>{region.name}</option>}
                    </For>
                  </select>
                </div>
                <button class="button primary" onClick={() => {
                  setEditingQuest({
                    id: null,
                    name: '',
                    description: '',
                    region_id: 1,
                    min_level: 1,
                    repeatable: 0,
                    cooldown_hours: 0,
                    chain_id: null,
                    chain_order: null
                  });
                  setEditingQuestObjectives([]);
                  setEditingQuestRewards([]);
                  setShowQuestModal(true);
                }}>
                  Create New Quest
                </button>
              </div>

              <div style={{ "max-height": "600px", "overflow-y": "auto" }}>
                <For each={filteredQuests()}>
                  {(quest) => (
                    <div class="card" style={{ "margin-bottom": "1rem", background: "var(--bg-light)" }}>
                      <div style={{ display: "flex", "justify-content": "space-between", "align-items": "start" }}>
                        <div style={{ flex: 1 }}>
                          <h3 style={{ "margin-bottom": "0.5rem" }}>{quest.name}</h3>
                          <p style={{ color: "var(--text-secondary)", "font-size": "0.875rem", "margin-bottom": "0.5rem" }}>
                            {quest.description}
                          </p>
                          <div style={{ "font-size": "0.875rem", color: "var(--text-secondary)", "margin-bottom": "0.5rem" }}>
                            <div>Region: {allRegions().find(r => r.id === quest.region_id)?.name || 'Unknown'}</div>
                            <div>Min Level: {quest.min_level}</div>
                            <div>Repeatable: {quest.repeatable ? `Yes (${quest.cooldown_hours}h cooldown)` : 'No'}</div>
                          </div>
                          
                          <Show when={(quest as any).rewards}>
                            <div style={{ 
                              "margin-top": "0.5rem",
                              "padding-top": "0.5rem",
                              "border-top": "1px solid var(--border)"
                            }}>
                              <div style={{ 
                                "font-size": "0.75rem", 
                                color: "var(--text-secondary)", 
                                "margin-bottom": "0.25rem",
                                "font-weight": "600"
                              }}>
                                Rewards:
                              </div>
                              <div style={{ display: "flex", "flex-wrap": "wrap", gap: "0.5rem" }}>
                                <For each={(quest as any).rewards}>
                                  {(reward: any) => (
                                    <div style={{ 
                                      padding: "0.25rem 0.5rem", 
                                      background: "var(--bg-dark)", 
                                      "border-radius": "4px",
                                      "font-size": "0.75rem",
                                      border: "1px solid var(--border)"
                                    }}>
                                      <Show when={reward.reward_type === 'xp'}>
                                        <span style={{ color: "var(--accent)" }}>+{reward.reward_amount} XP</span>
                                      </Show>
                                      <Show when={reward.reward_type === 'gold'}>
                                        <span style={{ color: "var(--warning)" }}>+{reward.reward_amount} Gold</span>
                                      </Show>
                                      <Show when={reward.reward_type === 'item'}>
                                        <span style={{ color: "var(--success)" }}>
                                          {items().find((i: any) => i.id === reward.reward_item_id)?.name || `Item #${reward.reward_item_id}`}
                                          {reward.reward_amount > 1 ? ` x${reward.reward_amount}` : ''}
                                        </span>
                                      </Show>
                                      <Show when={reward.reward_type === 'crafting_material'}>
                                        <span style={{ color: "var(--text-secondary)" }}>
                                          Material #{reward.reward_material_id} x{reward.reward_amount}
                                        </span>
                                      </Show>
                                    </div>
                                  )}
                                </For>
                              </div>
                            </div>
                          </Show>
                        </div>
                        <div style={{ display: "flex", gap: "0.5rem" }}>
                          <button class="button secondary" onClick={async () => {
                            const response = await fetch(`/api/gm/quests/${quest.id}`);
                            const data = await response.json();
                            setEditingQuest(data.quest);
                            setEditingQuestObjectives(data.objectives || []);
                            setEditingQuestRewards(data.rewards || []);
                            setShowQuestModal(true);
                          }}>
                            Edit
                          </button>
                          <button class="button error" onClick={async () => {
                            if (confirm(`Delete quest "${quest.name}"?`)) {
                              await fetch(`/api/gm/quests/${quest.id}`, { method: 'DELETE' });
                              await refetchQuests();
                            }
                          }}>
                            Delete
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </For>
              </div>
            </div>

            {/* Quest Edit Modal */}
            <Show when={showQuestModal() && editingQuest()}>
              <div class="modal-overlay" onClick={() => setShowQuestModal(false)}>
                <div class="modal-content" style={{ "max-width": "800px", "max-height": "90vh", "overflow-y": "auto" }} onClick={(e) => e.stopPropagation()}>
                  <h2>{editingQuest()!.id ? 'Edit Quest' : 'Create Quest'}</h2>
                  
                  <div style={{ display: "grid", "grid-template-columns": "1fr 1fr", gap: "1rem", "margin-bottom": "1rem" }}>
                    <div style={{ "grid-column": "1 / -1" }}>
                      <label>Quest Name</label>
                      <input type="text" value={editingQuest()!.name} 
                             onChange={(e) => setEditingQuest({...editingQuest()!, name: e.currentTarget.value})} />
                    </div>
                    
                    <div style={{ "grid-column": "1 / -1" }}>
                      <label>Description</label>
                      <textarea rows="3" value={editingQuest()!.description} 
                                onChange={(e) => setEditingQuest({...editingQuest()!, description: e.currentTarget.value})} />
                    </div>
                    
                    <div>
                      <label>Region</label>
                      <select value={editingQuest()!.region_id} 
                              onChange={(e) => setEditingQuest({...editingQuest()!, region_id: Number(e.currentTarget.value)})}>
                        <For each={allRegions()}>
                          {(region) => <option value={region.id}>{region.name}</option>}
                        </For>
                      </select>
                    </div>
                    
                    <div>
                      <label>Minimum Level</label>
                      <input type="number" step="1" min="1" value={editingQuest()!.min_level} 
                             onChange={(e) => setEditingQuest({...editingQuest()!, min_level: parseInt(e.currentTarget.value)})} />
                    </div>
                    
                    <div>
                      <label>
                        <input type="checkbox" checked={editingQuest()!.repeatable === 1} 
                               onChange={(e) => setEditingQuest({...editingQuest()!, repeatable: e.currentTarget.checked ? 1 : 0})} />
                        {' '}Repeatable
                      </label>
                    </div>
                    
                    <Show when={editingQuest()!.repeatable === 1}>
                      <div>
                        <label>Cooldown (hours)</label>
                        <input type="number" step="1" min="0" value={editingQuest()!.cooldown_hours} 
                               onChange={(e) => setEditingQuest({...editingQuest()!, cooldown_hours: parseInt(e.currentTarget.value)})} />
                      </div>
                    </Show>
                  </div>

                  <h3 style={{ "margin-top": "1.5rem", "margin-bottom": "1rem" }}>Quest Objectives</h3>
                  
                  <For each={editingQuestObjectives()}>
                    {(objective, index) => (
                      <div class="card" style={{ background: "var(--bg-light)", "margin-bottom": "1rem" }}>
                        <div style={{ display: "flex", "justify-content": "space-between", "margin-bottom": "0.5rem" }}>
                          <strong>Objective {objective.objective_order}</strong>
                          <button class="button error" onClick={() => {
                            setEditingQuestObjectives(editingQuestObjectives().filter((_, i) => i !== index()));
                          }}>Remove</button>
                        </div>
                        
                        <div style={{ display: "grid", "grid-template-columns": "1fr 1fr", gap: "0.5rem" }}>
                          <div>
                            <label>Type</label>
                            <select value={objective.type} onChange={(e) => {
                              const updated = [...editingQuestObjectives()];
                              updated[index()] = {...objective, type: e.currentTarget.value};
                              setEditingQuestObjectives(updated);
                            }}>
                              <option value="kill">Kill</option>
                              <option value="collect">Collect</option>
                              <option value="explore">Explore</option>
                            </select>
                          </div>
                          
                          <div>
                            <label>Description</label>
                            <input 
                              type="text" 
                              value={objective.description} 
                              onChange={(e) => {
                                const updated = [...editingQuestObjectives()];
                                updated[index()] = {...objective, description: e.currentTarget.value};
                                setEditingQuestObjectives(updated);
                              }}
                            />
                          </div>
                          
                          <Show when={objective.type === 'kill'}>
                            <div>
                              <label>Target Mob ID</label>
                              <input type="number" step="1" value={objective.target_mob_id || ''} onChange={(e) => {
                                const updated = [...editingQuestObjectives()];
                                updated[index()] = {...objective, target_mob_id: parseInt(e.currentTarget.value) || null};
                                setEditingQuestObjectives(updated);
                              }} />
                            </div>
                          </Show>
                          
                          <Show when={objective.type === 'collect'}>
                            <div>
                              <label>Target Material ID (crafting_materials table)</label>
                              <input type="number" step="1" value={objective.target_item_id || ''} onChange={(e) => {
                                const updated = [...editingQuestObjectives()];
                                updated[index()] = {...objective, target_item_id: parseInt(e.currentTarget.value) || null};
                                setEditingQuestObjectives(updated);
                              }} />
                              <small style={{ color: "var(--text-secondary)", display: "block", "margin-top": "0.25rem" }}>
                                Note: This must be a crafting_materials ID, not an items ID
                              </small>
                            </div>
                          </Show>
                          
                          <Show when={objective.type === 'explore'}>
                            <div>
                              <label>Target Sub-Area ID</label>
                              <input type="number" step="1" value={objective.target_sub_area_id || ''} onChange={(e) => {
                                const updated = [...editingQuestObjectives()];
                                updated[index()] = {...objective, target_sub_area_id: parseInt(e.currentTarget.value) || null};
                                setEditingQuestObjectives(updated);
                              }} />
                            </div>
                          </Show>
                          
                          <div>
                            <label>Required Count</label>
                            <input type="number" step="1" min="1" value={objective.required_count} onChange={(e) => {
                              const updated = [...editingQuestObjectives()];
                              updated[index()] = {...objective, required_count: parseInt(e.currentTarget.value)};
                              setEditingQuestObjectives(updated);
                            }} />
                          </div>
                          
                          <div>
                            <label>
                              <input type="checkbox" checked={objective.auto_complete === 1} onChange={(e) => {
                                const updated = [...editingQuestObjectives()];
                                updated[index()] = {...objective, auto_complete: e.currentTarget.checked ? 1 : 0};
                                setEditingQuestObjectives(updated);
                              }} />
                              {' '}Auto-complete
                            </label>
                          </div>
                        </div>
                      </div>
                    )}
                  </For>
                  
                  <button class="button secondary" style={{ "margin-bottom": "1rem" }} onClick={() => {
                    setEditingQuestObjectives([
                      ...editingQuestObjectives(),
                      {
                        id: null,
                        quest_id: editingQuest()!.id,
                        objective_order: editingQuestObjectives().length + 1,
                        type: 'kill',
                        description: '',
                        target_mob_id: null,
                        target_item_id: null,
                        target_region_id: null,
                        target_sub_area_id: null,
                        required_count: 1,
                        auto_complete: 1
                      }
                    ]);
                  }}>
                    Add Objective
                  </button>

                  <h3 style={{ "margin-top": "1.5rem", "margin-bottom": "1rem" }}>Quest Rewards</h3>
                  
                  <For each={editingQuestRewards()}>
                    {(reward, index) => (
                      <div class="card" style={{ background: "var(--bg-light)", "margin-bottom": "1rem" }}>
                        <div style={{ display: "flex", "justify-content": "space-between", "margin-bottom": "0.5rem" }}>
                          <strong>Reward {index() + 1}</strong>
                          <button class="button error" onClick={() => {
                            setEditingQuestRewards(editingQuestRewards().filter((_, i) => i !== index()));
                          }}>Remove</button>
                        </div>
                        
                        <div style={{ display: "grid", "grid-template-columns": "repeat(3, 1fr)", gap: "0.5rem" }}>
                          <div>
                            <label>Type</label>
                            <select value={reward.reward_type} onChange={(e) => {
                              const updated = [...editingQuestRewards()];
                              updated[index()] = {...reward, reward_type: e.currentTarget.value};
                              setEditingQuestRewards(updated);
                            }}>
                              <option value="xp">XP</option>
                              <option value="gold">Gold</option>
                              <option value="item">Item</option>
                              <option value="crafting_material">Crafting Material</option>
                            </select>
                          </div>
                          
                          <Show when={reward.reward_type === 'item'}>
                            <div style={{ "grid-column": "span 2" }}>
                              <label>Item</label>
                              <div style={{ display: "flex", gap: "0.5rem", "align-items": "center" }}>
                                <Show when={reward.reward_item_id}>
                                  <span style={{ flex: 1 }}>
                                    {items().find((i: any) => i.id === reward.reward_item_id)?.name || `Item #${reward.reward_item_id}`}
                                  </span>
                                </Show>
                                <Show when={!reward.reward_item_id}>
                                  <span style={{ flex: 1, color: "var(--text-muted)" }}>No item selected</span>
                                </Show>
                                <button type="button" class="button secondary" onClick={() => {
                                  setEditingRewardIndex(index());
                                  setSelectedRewardItemId(reward.reward_item_id);
                                  setRewardItemQuantity(reward.reward_amount || 1);
                                  setShowQuestRewardItemModal(true);
                                }}>
                                  {reward.reward_item_id ? 'Change' : 'Select'} Item
                                </button>
                              </div>
                            </div>
                          </Show>
                          
                          <Show when={reward.reward_type === 'crafting_material'}>
                            <div>
                              <label>Material ID</label>
                              <input type="number" step="1" value={reward.reward_material_id || ''} onChange={(e) => {
                                const updated = [...editingQuestRewards()];
                                updated[index()] = {...reward, reward_material_id: parseInt(e.currentTarget.value) || null};
                                setEditingQuestRewards(updated);
                              }} />
                            </div>
                          </Show>
                          
                          <div>
                            <label>Amount</label>
                            <input type="number" step="1" min="1" value={reward.reward_amount} onChange={(e) => {
                              const updated = [...editingQuestRewards()];
                              updated[index()] = {...reward, reward_amount: parseInt(e.currentTarget.value)};
                              setEditingQuestRewards(updated);
                            }} />
                          </div>
                        </div>
                      </div>
                    )}
                  </For>
                  
                  <button class="button secondary" style={{ "margin-bottom": "1rem" }} onClick={() => {
                    setEditingQuestRewards([
                      ...editingQuestRewards(),
                      {
                        id: null,
                        quest_id: editingQuest()!.id,
                        reward_type: 'xp',
                        reward_item_id: null,
                        reward_material_id: null,
                        reward_amount: 100
                      }
                    ]);
                  }}>
                    Add Reward
                  </button>

                  <div style={{ display: "flex", gap: "1rem", "justify-content": "flex-end" }}>
                    <button class="button secondary" onClick={() => setShowQuestModal(false)}>
                      Cancel
                    </button>
                    <button class="button primary" onClick={async () => {
                      try {
                        const quest = editingQuest()!;
                        const objectives = editingQuestObjectives();
                        const rewards = editingQuestRewards();
                        
                        // Validate region
                        const regionExists = regions().find((r: any) => r.id === quest.region_id);
                        if (!regionExists) {
                          alert(`Invalid Region ID: ${quest.region_id}\n\nRegion does not exist in the regions table.`);
                          return;
                        }
                        
                        // Validate objectives
                        for (let i = 0; i < objectives.length; i++) {
                          const obj = objectives[i];
                          
                          if (obj.type === 'kill' && obj.target_mob_id) {
                            const mobExists = mobs().find((m: any) => m.id === obj.target_mob_id);
                            if (!mobExists) {
                              alert(`Objective ${i + 1}: Invalid Mob ID ${obj.target_mob_id}\n\nMob does not exist in the mobs table.`);
                              return;
                            }
                          }
                          
                          if (obj.type === 'collect' && obj.target_item_id) {
                            // We can't validate crafting materials here as we don't have them loaded
                            // But we can at least check it's a number
                            if (!obj.target_item_id || obj.target_item_id <= 0) {
                              alert(`Objective ${i + 1}: Invalid Material ID\n\nMust be a valid crafting_materials ID.`);
                              return;
                            }
                          }
                          
                          if (obj.target_sub_area_id) {
                            const subAreaExists = subAreas().find((sa: any) => sa.id === obj.target_sub_area_id);
                            if (!subAreaExists) {
                              alert(`Objective ${i + 1}: Invalid Sub-Area ID ${obj.target_sub_area_id}\n\nSub-area does not exist.`);
                              return;
                            }
                          }
                          
                          if (obj.target_region_id) {
                            const regionExists = regions().find((r: any) => r.id === obj.target_region_id);
                            if (!regionExists) {
                              alert(`Objective ${i + 1}: Invalid Region ID ${obj.target_region_id}\n\nRegion does not exist.`);
                              return;
                            }
                          }
                        }
                        
                        // Validate rewards
                        for (let i = 0; i < rewards.length; i++) {
                          const reward = rewards[i];
                          
                          if (reward.reward_type === 'item' && reward.reward_item_id) {
                            const itemExists = items().find((item: any) => item.id === reward.reward_item_id);
                            if (!itemExists) {
                              alert(`Reward ${i + 1}: Invalid Item ID ${reward.reward_item_id}\n\nItem does not exist in the items table.`);
                              return;
                            }
                          }
                          
                          if (reward.reward_type === 'crafting_material' && reward.reward_material_id) {
                            // We can't validate crafting materials here as we don't have them loaded
                            // But we can at least check it's a number
                            if (!reward.reward_material_id || reward.reward_material_id <= 0) {
                              alert(`Reward ${i + 1}: Invalid Material ID\n\nMust be a valid crafting_materials ID.`);
                              return;
                            }
                          }
                        }
                        
                        const method = quest.id ? 'PUT' : 'POST';
                        const url = quest.id ? `/api/gm/quests/${quest.id}` : '/api/gm/quests';
                        
                        // Strip out IDs from objectives and rewards (they get regenerated on insert)
                        const cleanObjectives = objectives.map(obj => {
                          const { id, quest_id, ...rest } = obj;
                          return rest;
                        });
                        
                        const cleanRewards = rewards.map(reward => {
                          const { id, quest_id, ...rest } = reward;
                          return rest;
                        });
                        
                        console.log('Saving quest...');
                        console.log('Quest:', JSON.stringify(quest, null, 2));
                        console.log('Clean Objectives (without IDs):', JSON.stringify(cleanObjectives, null, 2));
                        console.log('Clean Rewards (without IDs):', JSON.stringify(cleanRewards, null, 2));
                        
                        const response = await fetch(url, {
                          method,
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({
                            quest,
                            objectives: cleanObjectives,
                            rewards: cleanRewards
                          })
                        });
                        
                        const result = await response.json();
                        console.log('Save response:', result);
                        
                        if (response.ok) {
                          setShowQuestModal(false);
                          await refetchQuests();
                        } else {
                          let errorMsg = result.error || 'Unknown error';
                          if (errorMsg.includes('FOREIGN KEY constraint')) {
                            errorMsg = 'Foreign key constraint failed. This usually means:\n\n' +
                                      '- A crafting material ID does not exist (for collect objectives or material rewards)\n' +
                                      '- An item/mob/region/sub-area ID is invalid\n\n' +
                                      'Check the browser console for the full data being sent.';
                          }
                          alert(`Error saving quest:\n\n${errorMsg}`);
                        }
                      } catch (error) {
                        console.error('Error saving quest:', error);
                        alert(`Error saving quest: ${error}`);
                      }
                    }}>
                      Save Quest
                    </button>
                  </div>
                </div>
              </div>
            </Show>
          </Show>

          {/* Quest Reward Item Selection Modal */}
          <Show when={showQuestRewardItemModal()}>
            <div style={{
              position: "fixed",
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: "rgba(0, 0, 0, 0.5)",
              display: "flex",
              "align-items": "center",
              "justify-content": "center",
              "z-index": 10000,
              padding: "1rem"
            }}>
              <div class="card" style={{ 
                "max-width": "900px", 
                width: "100%",
                "max-height": "80vh",
                "overflow-y": "auto"
              }}>
                <h2 style={{ "margin-bottom": "1rem" }}>Select Item for Quest Reward</h2>
                
                <div style={{ "margin-bottom": "1rem" }}>
                  <input 
                    type="text" 
                    placeholder="Search items..." 
                    value={searchItems()} 
                    onInput={(e) => setSearchItems(e.currentTarget.value)}
                    style={{ width: "100%", padding: "0.5rem" }}
                  />
                </div>
                
                <div style={{ "max-height": "400px", "overflow-y": "auto", "margin-bottom": "1rem" }}>
                  <table style={{ width: "100%", "border-collapse": "collapse" }}>
                    <thead style={{ position: "sticky", top: 0, background: "var(--bg)", "z-index": 1 }}>
                      <tr style={{ "border-bottom": "2px solid var(--bg-light)" }}>
                        <th style={{ padding: "0.5rem", "text-align": "left" }}>Select</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>ID</th>
                        <th style={{ padding: "0.5rem", "text-align": "left" }}>Name</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Type</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Rarity</th>
                      </tr>
                    </thead>
                    <tbody>
                      <For each={items().filter((item: any) => 
                        !searchItems() || 
                        item.name.toLowerCase().includes(searchItems().toLowerCase()) ||
                        item.type.toLowerCase().includes(searchItems().toLowerCase())
                      )}>
                        {(item: any) => (
                          <tr 
                            style={{ 
                              "border-bottom": "1px solid var(--bg-light)",
                              background: selectedRewardItemId() === item.id ? "var(--bg-light)" : "transparent",
                              cursor: "pointer"
                            }}
                            onClick={() => setSelectedRewardItemId(item.id)}
                          >
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>
                              <input 
                                type="radio" 
                                checked={selectedRewardItemId() === item.id}
                                onChange={() => setSelectedRewardItemId(item.id)}
                              />
                            </td>
                            <td style={{ padding: "0.5rem", "text-align": "center", "font-weight": "bold", color: "var(--accent)" }}>{item.id}</td>
                            <td style={{ padding: "0.5rem" }}>{item.name}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>{item.type}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>
                              <span style={{ 
                                padding: "0.2rem 0.4rem", 
                                "border-radius": "3px",
                                background: item.rarity === 'legendary' ? 'var(--legendary)' :
                                           item.rarity === 'epic' ? 'var(--epic)' :
                                           item.rarity === 'rare' ? 'var(--rare)' :
                                           item.rarity === 'uncommon' ? 'var(--uncommon)' :
                                           'var(--common)',
                                color: '#fff',
                                "font-size": "0.75rem"
                              }}>
                                {item.rarity}
                              </span>
                            </td>
                          </tr>
                        )}
                      </For>
                    </tbody>
                  </table>
                </div>
                
                <div style={{ display: "flex", gap: "1rem", "align-items": "end" }}>
                  <div style={{ flex: 1 }}>
                    <label style={{ display: "block", "margin-bottom": "0.25rem" }}>Quantity</label>
                    <input 
                      type="number" 
                      min="1" 
                      value={rewardItemQuantity()} 
                      onInput={(e) => setRewardItemQuantity(parseInt(e.currentTarget.value) || 1)}
                      style={{ width: "100%", padding: "0.5rem" }}
                    />
                  </div>
                  <button 
                    type="button" 
                    class="button primary" 
                    style={{ flex: 1 }}
                    onClick={() => {
                      const idx = editingRewardIndex();
                      if (idx !== null && selectedRewardItemId()) {
                        const updated = [...editingQuestRewards()];
                        updated[idx] = {
                          ...updated[idx],
                          reward_item_id: selectedRewardItemId(),
                          reward_amount: rewardItemQuantity()
                        };
                        setEditingQuestRewards(updated);
                        setShowQuestRewardItemModal(false);
                        setEditingRewardIndex(null);
                        setSelectedRewardItemId(null);
                        setRewardItemQuantity(1);
                      }
                    }}
                    disabled={!selectedRewardItemId()}
                  >
                    Confirm
                  </button>
                  <button 
                    type="button" 
                    class="button secondary" 
                    style={{ flex: 1 }}
                    onClick={() => {
                      setShowQuestRewardItemModal(false);
                      setEditingRewardIndex(null);
                      setSelectedRewardItemId(null);
                      setRewardItemQuantity(1);
                    }}
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </Show>

          {/* Loot Tables Tab */}
          <Show when={activeTab() === "loot"}>
            <div class="card" style={{ "margin-bottom": "1rem" }}>
              <h2 style={{ "margin-bottom": "1rem" }}>Mob Loot Tables</h2>
              <div style={{ display: "grid", "grid-template-columns": "1fr auto", gap: "1rem", "margin-bottom": "1rem", "align-items": "end" }}>
                <div>
                  <label style={{ display: "block", "margin-bottom": "0.5rem", "font-weight": "bold" }}>Select Mob</label>
                  <select 
                    value={selectedMobForLoot() || ''} 
                    onChange={(e) => setSelectedMobForLoot(e.currentTarget.value ? parseInt(e.currentTarget.value) : null)}
                    style={{ width: "100%", padding: "0.5rem", "font-size": "1rem" }}
                  >
                    <option value="">-- Select a mob to edit loot --</option>
                    <For each={mobs().sort((a: any, b: any) => a.level - b.level || a.name.localeCompare(b.name))}>
                      {(mob: any) => (
                        <option value={mob.id}>
                          {mob.name} (Lvl {mob.level}) - {mobLoot().filter((l: any) => l.mob_id === mob.id).length} items
                        </option>
                      )}
                    </For>
                  </select>
                </div>
                <Show when={selectedMobForLoot()}>
                  <button class="button primary" onClick={() => {
                    setEditingMobLoot({
                      mob_id: selectedMobForLoot()!,
                      item_id: items()[0]?.id || 1,
                      drop_chance: 0.1,
                      min_quantity: 1,
                      max_quantity: 1
                    });
                    setShowMobLootModal(true);
                  }}>
                    Add Item to Loot Table
                  </button>
                </Show>
              </div>
              
              <Show when={selectedMobForLoot()}>
                <Show 
                  when={mobLoot().filter((l: any) => l.mob_id === selectedMobForLoot()).length > 0}
                  fallback={
                    <div style={{ padding: "2rem", "text-align": "center", color: "var(--text-secondary)" }}>
                      <p>This mob has no loot configured.</p>
                      <p style={{ "font-size": "0.9rem", "margin-top": "0.5rem" }}>Click "Add Item to Loot Table" to add drops.</p>
                    </div>
                  }
                >
                  <div style={{ overflow: "auto", "max-height": "600px" }}>
                    <table style={{ width: "100%", "border-collapse": "collapse", "font-size": "0.9rem" }}>
                      <thead style={{ position: "sticky", top: 0, background: "var(--bg-dark)" }}>
                        <tr style={{ "border-bottom": "2px solid var(--bg-light)" }}>
                          <th style={{ padding: "0.5rem", "text-align": "left" }}>Item</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Type</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Rarity</th>
                          <th style={{ padding: "0.5rem", "text-align": "right" }}>Drop %</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Quantity</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <For each={mobLoot().filter((l: any) => l.mob_id === selectedMobForLoot())}>
                          {(loot: any) => (
                            <tr style={{ "border-bottom": "1px solid var(--bg-light)" }}>
                              <td style={{ padding: "0.5rem" }}>{loot.item_name}</td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>{loot.item_type}</td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>
                                <span style={{ 
                                  padding: "0.2rem 0.4rem", 
                                  "border-radius": "3px",
                                  background: loot.item_rarity === 'legendary' ? 'var(--legendary)' :
                                             loot.item_rarity === 'epic' ? 'var(--epic)' :
                                             loot.item_rarity === 'rare' ? 'var(--rare)' :
                                             loot.item_rarity === 'uncommon' ? 'var(--uncommon)' :
                                             'var(--common)',
                                  color: '#fff',
                                  "font-size": "0.75rem"
                                }}>
                                  {loot.item_rarity}
                                </span>
                              </td>
                              <td style={{ padding: "0.5rem", "text-align": "right" }}>
                                {(loot.drop_chance * 100).toFixed(1)}%
                              </td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>
                                {loot.min_quantity === loot.max_quantity ? loot.min_quantity : `${loot.min_quantity}-${loot.max_quantity}`}
                              </td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>
                                <button 
                                  class="button secondary" 
                                  style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", "margin-right": "0.25rem" }}
                                  onClick={() => handleEditMobLoot(loot)}
                                >
                                  Edit
                                </button>
                                <button 
                                  class="button" 
                                  style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", background: "var(--danger)" }}
                                  onClick={() => handleDeleteMobLoot(loot.id)}
                                >
                                  Delete
                                </button>
                              </td>
                            </tr>
                          )}
                        </For>
                      </tbody>
                    </table>
                  </div>
                </Show>
              </Show>
              
              <Show when={!selectedMobForLoot()}>
                <div style={{ padding: "3rem", "text-align": "center", color: "var(--text-secondary)" }}>
                  <p style={{ "font-size": "1.1rem" }}>Select a mob from the dropdown above to view and edit its loot table.</p>
                </div>
              </Show>
            </div>
            
            <div class="card">
              <h2 style={{ "margin-bottom": "1rem" }}>Region Rare Loot</h2>
              <div style={{ display: "grid", "grid-template-columns": "1fr auto", gap: "1rem", "margin-bottom": "1rem", "align-items": "end" }}>
                <div>
                  <label style={{ display: "block", "margin-bottom": "0.5rem", "font-weight": "bold" }}>Select Region</label>
                  <select 
                    value={selectedRegionForLoot() || ''} 
                    onChange={(e) => setSelectedRegionForLoot(e.currentTarget.value ? parseInt(e.currentTarget.value) : null)}
                    style={{ width: "100%", padding: "0.5rem", "font-size": "1rem" }}
                  >
                    <option value="">-- Select a region to edit rare loot --</option>
                    <For each={regions()}>
                      {(region: any) => (
                        <option value={region.id}>
                          {region.name} - {regionRareLoot().filter((l: any) => l.region_id === region.id).length} rare items
                        </option>
                      )}
                    </For>
                  </select>
                </div>
                <Show when={selectedRegionForLoot()}>
                  <button class="button primary" onClick={() => {
                    setEditingRegionLoot({
                      region_id: selectedRegionForLoot()!,
                      item_id: items()[0]?.id || 1,
                      drop_chance: 0.001,
                      min_level: 1
                    });
                    setShowRegionLootModal(true);
                  }}>
                    Add Rare Item
                  </button>
                </Show>
              </div>
              
              <Show when={selectedRegionForLoot()}>
                <Show 
                  when={regionRareLoot().filter((l: any) => l.region_id === selectedRegionForLoot()).length > 0}
                  fallback={
                    <div style={{ padding: "2rem", "text-align": "center", color: "var(--text-secondary)" }}>
                      <p>This region has no rare loot configured.</p>
                      <p style={{ "font-size": "0.9rem", "margin-top": "0.5rem" }}>Click "Add Rare Item" to add region-wide rare drops.</p>
                    </div>
                  }
                >
                  <div style={{ overflow: "auto", "max-height": "600px" }}>
                    <table style={{ width: "100%", "border-collapse": "collapse", "font-size": "0.9rem" }}>
                      <thead style={{ position: "sticky", top: 0, background: "var(--bg-dark)" }}>
                        <tr style={{ "border-bottom": "2px solid var(--bg-light)" }}>
                          <th style={{ padding: "0.5rem", "text-align": "left" }}>Item</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Type</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Rarity</th>
                          <th style={{ padding: "0.5rem", "text-align": "right" }}>Drop %</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Min Level</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <For each={regionRareLoot().filter((l: any) => l.region_id === selectedRegionForLoot())}>
                          {(loot: any) => (
                            <tr style={{ "border-bottom": "1px solid var(--bg-light)" }}>
                              <td style={{ padding: "0.5rem" }}>{loot.item_name}</td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>{loot.item_type}</td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>
                                <span style={{ 
                                  padding: "0.2rem 0.4rem", 
                                  "border-radius": "3px",
                                  background: loot.item_rarity === 'legendary' ? 'var(--legendary)' :
                                             loot.item_rarity === 'epic' ? 'var(--epic)' :
                                             loot.item_rarity === 'rare' ? 'var(--rare)' :
                                             loot.item_rarity === 'uncommon' ? 'var(--uncommon)' :
                                             'var(--common)',
                                  color: '#fff',
                                  "font-size": "0.75rem"
                                }}>
                                  {loot.item_rarity}
                                </span>
                              </td>
                              <td style={{ padding: "0.5rem", "text-align": "right" }}>
                                {(loot.drop_chance * 100).toFixed(3)}%
                              </td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>{loot.min_level}</td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>
                                <button 
                                  class="button secondary" 
                                  style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", "margin-right": "0.25rem" }}
                                  onClick={() => handleEditRegionLoot(loot)}
                                >
                                  Edit
                                </button>
                                <button 
                                  class="button" 
                                  style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", background: "var(--danger)" }}
                                  onClick={() => handleDeleteRegionLoot(loot.id)}
                                >
                                  Delete
                                </button>
                              </td>
                            </tr>
                          )}
                        </For>
                      </tbody>
                      </table>
                  </div>
                </Show>
              </Show>
              
              <Show when={!selectedRegionForLoot()}>
                <div style={{ padding: "3rem", "text-align": "center", color: "var(--text-secondary)" }}>
                  <p style={{ "font-size": "1.1rem" }}>Select a region from the dropdown above to view and edit its rare loot.</p>
                </div>
              </Show>
            </div>
          </Show>
          
          {/* Merchants Tab */}
          <Show when={activeTab() === "merchants"}>
            <div class="card">
              <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
                <h2>Merchants ({merchants()?.length || 0})</h2>
                <button class="button primary" onClick={() => {
                  setEditingMerchant({
                    name: '', description: '', region_id: 1
                  });
                  setShowMerchantModal(true);
                }}>
                  Add Merchant
                </button>
              </div>
              <div style={{ "margin-bottom": "1rem" }}>
                <input 
                  type="text" 
                  placeholder="Search by name, description, or region..." 
                  value={searchMerchants()}
                  onInput={(e) => setSearchMerchants(e.currentTarget.value)}
                  style={{ width: "100%", padding: "0.5rem" }}
                />
              </div>
              <Show when={merchants()}>
                <div style={{ overflow: "auto", "max-height": "600px" }}>
                  <table style={{ width: "100%", "border-collapse": "collapse" }}>
                    <thead style={{ position: "sticky", top: 0, background: "var(--bg-dark)" }}>
                      <tr style={{ "border-bottom": "2px solid var(--bg-light)" }}>
                        <th style={{ padding: "0.5rem", "text-align": "left" }}>Name</th>
                        <th style={{ padding: "0.5rem", "text-align": "left" }}>Description</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Region</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <For each={merchants().filter((m: any) => {
                        const search = searchMerchants().toLowerCase();
                        if (!search) return true;
                        return (
                          m.name?.toLowerCase().includes(search) ||
                          m.description?.toLowerCase().includes(search) ||
                          m.region_name?.toLowerCase().includes(search)
                        );
                      })}>
                        {(merchant: any) => (
                          <tr style={{ "border-bottom": "1px solid var(--bg-light)" }}>
                            <td style={{ padding: "0.5rem" }}>{merchant.name}</td>
                            <td style={{ padding: "0.5rem" }}>{merchant.description}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>{merchant.region_name}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>
                              <button 
                                class="button secondary" 
                                style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", "margin-right": "0.25rem" }}
                                onClick={() => handleEditMerchant(merchant)}
                              >
                                Edit
                              </button>
                              <button 
                                class="button" 
                                style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", background: "var(--danger)" }}
                                onClick={() => handleDeleteMerchant(merchant.id)}
                              >
                                Delete
                              </button>
                            </td>
                          </tr>
                        )}
                      </For>
                    </tbody>
                  </table>
                </div>
              </Show>
            </div>
          </Show>
          
          {/* Mob Spawns Tab */}
          <Show when={activeTab() === "spawns"}>
            <div class="card">
              <h2 style={{ "margin-bottom": "1rem" }}>Sub-Area Mob Spawns</h2>
              <div style={{ display: "grid", "grid-template-columns": "1fr auto", gap: "1rem", "margin-bottom": "1rem", "align-items": "end" }}>
                <div>
                  <label style={{ display: "block", "margin-bottom": "0.5rem", "font-weight": "bold" }}>Select Sub-Area</label>
                  <select 
                    value={selectedSubAreaForMobs() || ''} 
                    onChange={(e) => setSelectedSubAreaForMobs(e.currentTarget.value ? parseInt(e.currentTarget.value) : null)}
                    style={{ width: "100%", padding: "0.5rem", "font-size": "1rem" }}
                  >
                    <option value="">-- Select a sub-area --</option>
                    <For each={subAreas().sort((a: any, b: any) => a.region_id - b.region_id || a.id - b.id)}>
                      {(subArea: any) => (
                        <option value={subArea.id}>
                          {subArea.region_name} - {subArea.name} (Lvl {subArea.min_level}-{subArea.max_level}) - {subAreaMobs().filter((sam: any) => sam.sub_area_id === subArea.id).length} mobs
                        </option>
                      )}
                    </For>
                  </select>
                </div>
                <Show when={selectedSubAreaForMobs()}>
                  <button class="button primary" onClick={() => {
                    setEditingSubAreaMob({
                      sub_area_id: selectedSubAreaForMobs()!,
                      mob_id: mobs()[0]?.id || 1,
                      spawn_weight: 100,
                      level_variance: 0
                    });
                    setShowSubAreaMobModal(true);
                  }}>
                    Add Mob Spawn
                  </button>
                </Show>
              </div>
              
              <Show when={selectedSubAreaForMobs()}>
                <Show 
                  when={subAreaMobs().filter((sam: any) => sam.sub_area_id === selectedSubAreaForMobs()).length > 0}
                  fallback={
                    <div style={{ padding: "2rem", "text-align": "center", color: "var(--text-secondary)" }}>
                      <p>No mobs spawn in this sub-area.</p>
                      <p style={{ "font-size": "0.9rem", "margin-top": "0.5rem" }}>Click "Add Mob Spawn" to configure mob spawns.</p>
                    </div>
                  }
                >
                  <div style={{ overflow: "auto", "max-height": "600px" }}>
                    <table style={{ width: "100%", "border-collapse": "collapse", "font-size": "0.9rem" }}>
                      <thead style={{ position: "sticky", top: 0, background: "var(--bg-dark)" }}>
                        <tr style={{ "border-bottom": "2px solid var(--bg-light)" }}>
                          <th style={{ padding: "0.5rem", "text-align": "left" }}>Mob Name</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Level</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Spawn Weight</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Level Variance</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <For each={subAreaMobs().filter((sam: any) => sam.sub_area_id === selectedSubAreaForMobs()).sort((a: any, b: any) => b.spawn_weight - a.spawn_weight)}>
                          {(subAreaMob: any) => (
                            <tr style={{ "border-bottom": "1px solid var(--bg-light)" }}>
                              <td style={{ padding: "0.5rem" }}>{subAreaMob.mob_name}</td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>{subAreaMob.mob_level}</td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>{subAreaMob.spawn_weight}</td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>{subAreaMob.level_variance}</td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>
                                <button 
                                  class="button secondary" 
                                  style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", "margin-right": "0.25rem" }}
                                  onClick={() => handleEditSubAreaMob(subAreaMob)}
                                >
                                  Edit
                                </button>
                                <button 
                                  class="button" 
                                  style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", background: "var(--danger)" }}
                                  onClick={() => handleDeleteSubAreaMob(subAreaMob.id)}
                                >
                                  Delete
                                </button>
                              </td>
                            </tr>
                          )}
                        </For>
                      </tbody>
                    </table>
                  </div>
                </Show>
              </Show>
              
              <Show when={!selectedSubAreaForMobs()}>
                <div style={{ padding: "3rem", "text-align": "center", color: "var(--text-secondary)" }}>
                  <p style={{ "font-size": "1.1rem" }}>Select a sub-area from the dropdown above to manage which mobs spawn there.</p>
                </div>
              </Show>
            </div>
          </Show>
          
          {/* Merchant Inventory Tab */}
          <Show when={activeTab() === "inventory"}>
            <div class="card">
              <h2 style={{ "margin-bottom": "1rem" }}>Merchant Inventory</h2>
              <div style={{ display: "grid", "grid-template-columns": "1fr auto", gap: "1rem", "margin-bottom": "1rem", "align-items": "end" }}>
                <div>
                  <label style={{ display: "block", "margin-bottom": "0.5rem", "font-weight": "bold" }}>Select Merchant</label>
                  <select 
                    value={selectedMerchantForInv() || ''} 
                    onChange={(e) => setSelectedMerchantForInv(e.currentTarget.value ? parseInt(e.currentTarget.value) : null)}
                    style={{ width: "100%", padding: "0.5rem", "font-size": "1rem" }}
                  >
                    <option value="">-- Select a merchant --</option>
                    <For each={merchants()}>
                      {(merchant: any) => (
                        <option value={merchant.id}>
                          {merchant.name} ({merchant.region_name}) - {merchantInventory().filter((mi: any) => mi.merchant_id === merchant.id).length} items
                        </option>
                      )}
                    </For>
                  </select>
                </div>
                <Show when={selectedMerchantForInv()}>
                  <button class="button primary" onClick={() => {
                    setEditingMerchantInv({
                      merchant_id: selectedMerchantForInv()!,
                      item_id: items()[0]?.id || 1,
                      stock: -1,
                      price_multiplier: 1.0
                    });
                    setShowMerchantInvModal(true);
                  }}>
                    Add Item
                  </button>
                </Show>
              </div>
              
              <Show when={selectedMerchantForInv()}>
                <Show 
                  when={merchantInventory().filter((mi: any) => mi.merchant_id === selectedMerchantForInv()).length > 0}
                  fallback={
                    <div style={{ padding: "2rem", "text-align": "center", color: "var(--text-secondary)" }}>
                      <p>This merchant has no inventory.</p>
                      <p style={{ "font-size": "0.9rem", "margin-top": "0.5rem" }}>Click "Add Item" to add items to sell.</p>
                    </div>
                  }
                >
                  <div style={{ overflow: "auto", "max-height": "600px" }}>
                    <table style={{ width: "100%", "border-collapse": "collapse", "font-size": "0.9rem" }}>
                      <thead style={{ position: "sticky", top: 0, background: "var(--bg-dark)" }}>
                        <tr style={{ "border-bottom": "2px solid var(--bg-light)" }}>
                          <th style={{ padding: "0.5rem", "text-align": "left" }}>Item</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Type</th>
                          <th style={{ padding: "0.5rem", "text-align": "right" }}>Base Value</th>
                          <th style={{ padding: "0.5rem", "text-align": "right" }}>Price Mult</th>
                          <th style={{ padding: "0.5rem", "text-align": "right" }}>Final Price</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Stock</th>
                          <th style={{ padding: "0.5rem", "text-align": "center" }}>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <For each={merchantInventory().filter((mi: any) => mi.merchant_id === selectedMerchantForInv()).sort((a: any, b: any) => a.item_name.localeCompare(b.item_name))}>
                          {(inv: any) => (
                            <tr style={{ "border-bottom": "1px solid var(--bg-light)" }}>
                              <td style={{ padding: "0.5rem" }}>{inv.item_name}</td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>{inv.item_type}</td>
                              <td style={{ padding: "0.5rem", "text-align": "right" }}>{inv.base_value}g</td>
                              <td style={{ padding: "0.5rem", "text-align": "right" }}>{inv.price_multiplier}x</td>
                              <td style={{ padding: "0.5rem", "text-align": "right" }}>{Math.round(inv.base_value * inv.price_multiplier)}g</td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>{inv.stock === -1 ? "" : inv.stock}</td>
                              <td style={{ padding: "0.5rem", "text-align": "center" }}>
                                <button 
                                  class="button secondary" 
                                  style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", "margin-right": "0.25rem" }}
                                  onClick={() => handleEditMerchantInv(inv)}
                                >
                                  Edit
                                </button>
                                <button 
                                  class="button" 
                                  style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", background: "var(--danger)" }}
                                  onClick={() => handleDeleteMerchantInv(inv.id)}
                                >
                                  Delete
                                </button>
                              </td>
                            </tr>
                          )}
                        </For>
                      </tbody>
                    </table>
                  </div>
                </Show>
              </Show>
              
              <Show when={!selectedMerchantForInv()}>
                <div style={{ padding: "3rem", "text-align": "center", color: "var(--text-secondary)" }}>
                  <p style={{ "font-size": "1.1rem" }}>Select a merchant from the dropdown above to manage their inventory.</p>
                </div>
              </Show>
            </div>
          </Show>
        </div>
      </Show>
      
      {/* Mob Edit Modal */}
      <Show when={showMobModal()}>
        <div style={{
          position: "fixed", top: 0, left: 0, right: 0, bottom: 0,
          background: "rgba(0,0,0,0.7)", display: "flex",
          "align-items": "center", "justify-content": "center", "z-index": 1000
        }} onClick={() => setShowMobModal(false)}>
          <div class="card" style={{ "max-width": "600px", width: "90%", "max-height": "90vh", overflow: "auto" }} 
               onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
              <h2>{editingMob()?.id ? 'Edit Mob' : 'Create Mob'}</h2>
              <button onClick={() => setShowMobModal(false)} style={{ background: "none", border: "none", "font-size": "1.5rem", cursor: "pointer" }}></button>
            </div>
            <form onSubmit={handleSaveMob}>
              <div style={{ display: "grid", gap: "1rem", "grid-template-columns": "1fr 1fr" }}>
                <div style={{ "grid-column": "1 / -1" }}>
                  <label>Name</label>
                  <input type="text" value={editingMob()?.name || ''} 
                         onInput={(e) => setEditingMob({...editingMob()!, name: e.currentTarget.value})} required />
                </div>
                <div>
                  <label>Level</label>
                  <input type="number" step="1" value={editingMob()?.level || 1} 
                         onInput={(e) => setEditingMob({...editingMob()!, level: parseInt(e.currentTarget.value)})} required />
                </div>
                <div>
                  <label>Max Health</label>
                  <input type="number" step="1" value={editingMob()?.max_health || 100} 
                         onInput={(e) => setEditingMob({...editingMob()!, max_health: parseInt(e.currentTarget.value)})} required />
                </div>
                <div>
                  <label>Attack</label>
                  <input type="number" step="0.1" value={editingMob()?.attack || 10} 
                         onInput={(e) => setEditingMob({...editingMob()!, attack: parseInt(e.currentTarget.value)})} required />
                </div>
                <div>
                  <label>Defense</label>
                  <input type="number" step="0.1" value={editingMob()?.defense || 5} 
                         onInput={(e) => setEditingMob({...editingMob()!, defense: parseInt(e.currentTarget.value)})} required />
                </div>
                <div>
                  <label>Experience</label>
                  <input type="number" step="1" value={editingMob()?.experience || 10} 
                         onInput={(e) => setEditingMob({...editingMob()!, experience: parseInt(e.currentTarget.value)})} required />
                </div>
                <div>
                  <label>Gold Min</label>
                  <input type="number" step="1" value={editingMob()?.gold_min || 1} 
                         onInput={(e) => setEditingMob({...editingMob()!, gold_min: parseInt(e.currentTarget.value)})} required />
                </div>
                <div>
                  <label>Gold Max</label>
                  <input type="number" step="1" value={editingMob()?.gold_max || 5} 
                         onInput={(e) => setEditingMob({...editingMob()!, gold_max: parseInt(e.currentTarget.value)})} required />
                </div>
                <div>
                  <label>Attack Speed</label>
                  <input type="number" step="any" value={editingMob()?.attack_speed || 1.0} 
                         onInput={(e) => {
                           const val = parseFloat(e.currentTarget.value);
                           if (!isNaN(val)) setEditingMob({...editingMob()!, attack_speed: val});
                         }} required />
                </div>
                <div>
                  <label>Region ID <span style={{ "font-size": "0.8rem", color: "var(--warning)" }}>(controls rare loot)</span></label>
                  <input type="number" step="1" value={editingMob()?.region_id || 1} 
                         onInput={(e) => setEditingMob({...editingMob()!, region_id: parseInt(e.currentTarget.value)})} />
                </div>
                <div style={{ "grid-column": "1 / -1" }}>
                  <label>Area <span style={{ "font-size": "0.8rem", color: "var(--text-secondary)" }}>(description only, not used for spawning)</span></label>
                  <input type="text" value={editingMob()?.area || ''} 
                         onInput={(e) => setEditingMob({...editingMob()!, area: e.currentTarget.value})} 
                         placeholder="e.g., 'Forest', 'Cave', 'Mountains'" />
                </div>
              </div>
              <div style={{ 
                "margin-top": "1rem", 
                padding: "0.75rem", 
                background: "var(--bg-light)", 
                "border-radius": "4px",
                "font-size": "0.85rem",
                color: "var(--text-secondary)",
                border: "1px solid var(--accent)"
              }}>
                <div style={{ "margin-bottom": "0.5rem" }}>
                  <strong style={{ color: "var(--accent)" }}>Spawning:</strong> Controlled by the <strong>region_mobs</strong> table, not region_id. 
                  Add this mob to region_mobs with a spawn_weight to make it appear in a region.
                </div>
                <div>
                  <strong style={{ color: "var(--warning)" }}>Region ID:</strong> Determines which region rare loot this mob can drop (from region_rare_loot table).
                </div>
                <div style={{ "margin-top": "0.5rem" }}>
                  <strong style={{ color: "var(--text-secondary)" }}>Area:</strong> Description only, not used by game logic.
                </div>
              </div>
              <div style={{ display: "flex", gap: "1rem", "margin-top": "1rem" }}>
                <button type="submit" class="button primary" style={{ flex: 1 }}>Save</button>
                <button type="button" class="button secondary" style={{ flex: 1 }} onClick={() => setShowMobModal(false)}>Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </Show>
      
      {/* Mob Loot Edit Modal */}
      <Show when={showMobLootModal()}>
        <div style={{
          position: "fixed", top: 0, left: 0, right: 0, bottom: 0,
          background: "rgba(0,0,0,0.7)", display: "flex",
          "align-items": "center", "justify-content": "center", "z-index": 1000
        }} onClick={() => setShowMobLootModal(false)}>
          <div class="card" style={{ "max-width": "500px", width: "90%" }} 
               onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
              <h2>{editingMobLoot()?.id ? 'Edit Mob Loot' : 'Add Mob Loot'}</h2>
              <button onClick={() => setShowMobLootModal(false)} style={{ background: "none", border: "none", "font-size": "1.5rem", cursor: "pointer" }}></button>
            </div>
            <form onSubmit={handleSaveMobLoot}>
              <div style={{ display: "grid", gap: "1rem" }}>
                <div>
                  <label>Mob</label>
                  <select value={editingMobLoot()?.mob_id || ''} 
                          onChange={(e) => setEditingMobLoot({...editingMobLoot()!, mob_id: parseInt(e.currentTarget.value)})} required>
                    <For each={mobs()}>
                      {(mob: any) => <option value={mob.id}>{mob.name} (Lvl {mob.level})</option>}
                    </For>
                  </select>
                </div>
                <div>
                  <label>Item</label>
                  <select value={editingMobLoot()?.item_id || ''} 
                          onChange={(e) => setEditingMobLoot({...editingMobLoot()!, item_id: parseInt(e.currentTarget.value)})} required>
                    <For each={items()}>
                      {(item: any) => <option value={item.id}>{item.name} ({item.rarity})</option>}
                    </For>
                  </select>
                </div>
                <div>
                  <label>Drop Chance (0-1, e.g. 0.05 = 5%)</label>
                  <input type="number" step="0.001" min="0" max="1" value={editingMobLoot()?.drop_chance || 0.1} 
                         onInput={(e) => setEditingMobLoot({...editingMobLoot()!, drop_chance: parseFloat(e.currentTarget.value)})} required />
                </div>
                <div style={{ display: "grid", "grid-template-columns": "1fr 1fr", gap: "1rem" }}>
                  <div>
                    <label>Min Quantity</label>
                    <input type="number" step="1" min="1" value={editingMobLoot()?.min_quantity || 1} 
                           onInput={(e) => setEditingMobLoot({...editingMobLoot()!, min_quantity: parseInt(e.currentTarget.value)})} required />
                  </div>
                  <div>
                    <label>Max Quantity</label>
                    <input type="number" step="1" min="1" value={editingMobLoot()?.max_quantity || 1} 
                           onInput={(e) => setEditingMobLoot({...editingMobLoot()!, max_quantity: parseInt(e.currentTarget.value)})} required />
                  </div>
                </div>
              </div>
              <div style={{ display: "flex", gap: "1rem", "margin-top": "1.5rem" }}>
                <button type="submit" class="button primary" style={{ flex: 1 }}>Save</button>
                <button type="button" class="button secondary" style={{ flex: 1 }} onClick={() => setShowMobLootModal(false)}>Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </Show>
      
      {/* Region Rare Loot Edit Modal */}
      <Show when={showRegionLootModal()}>
        <div style={{
          position: "fixed", top: 0, left: 0, right: 0, bottom: 0,
          background: "rgba(0,0,0,0.7)", display: "flex",
          "align-items": "center", "justify-content": "center", "z-index": 1000
        }} onClick={() => setShowRegionLootModal(false)}>
          <div class="card" style={{ "max-width": "500px", width: "90%" }} 
               onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
              <h2>{editingRegionLoot()?.id ? 'Edit Region Rare Loot' : 'Add Region Rare Loot'}</h2>
              <button onClick={() => setShowRegionLootModal(false)} style={{ background: "none", border: "none", "font-size": "1.5rem", cursor: "pointer" }}></button>
            </div>
            <form onSubmit={handleSaveRegionLoot}>
              <div style={{ display: "grid", gap: "1rem" }}>
                <div>
                  <label>Region</label>
                  <select value={editingRegionLoot()?.region_id || ''} 
                          onChange={(e) => setEditingRegionLoot({...editingRegionLoot()!, region_id: parseInt(e.currentTarget.value)})} required>
                    <For each={regions()}>
                      {(region: any) => <option value={region.id}>{region.name}</option>}
                    </For>
                  </select>
                </div>
                <div>
                  <label>Item</label>
                  <select value={editingRegionLoot()?.item_id || ''} 
                          onChange={(e) => setEditingRegionLoot({...editingRegionLoot()!, item_id: parseInt(e.currentTarget.value)})} required>
                    <For each={items()}>
                      {(item: any) => <option value={item.id}>{item.name} ({item.rarity})</option>}
                    </For>
                  </select>
                </div>
                <div>
                  <label>Drop Chance (0-1, e.g. 0.001 = 0.1%)</label>
                  <input type="number" step="0.0001" min="0" max="1" value={editingRegionLoot()?.drop_chance || 0.001} 
                         onInput={(e) => setEditingRegionLoot({...editingRegionLoot()!, drop_chance: parseFloat(e.currentTarget.value)})} required />
                </div>
                <div>
                  <label>Minimum Mob Level</label>
                  <input type="number" step="1" min="1" value={editingRegionLoot()?.min_level || 1} 
                         onInput={(e) => setEditingRegionLoot({...editingRegionLoot()!, min_level: parseInt(e.currentTarget.value)})} required />
                </div>
              </div>
              <div style={{ display: "flex", gap: "1rem", "margin-top": "1.5rem" }}>
                <button type="submit" class="button primary" style={{ flex: 1 }}>Save</button>
                <button type="button" class="button secondary" style={{ flex: 1 }} onClick={() => setShowRegionLootModal(false)}>Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </Show>
      
      {/* Item Edit Modal */}
      <Show when={showItemModal()}>
        <div style={{
          position: "fixed", top: 0, left: 0, right: 0, bottom: 0,
          background: "rgba(0,0,0,0.7)", display: "flex",
          "align-items": "center", "justify-content": "center", "z-index": 1000
        }} onClick={() => setShowItemModal(false)}>
          <div class="card" style={{ "max-width": "800px", width: "90%", "max-height": "90vh", overflow: "auto" }} 
               onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
              <h2>{editingItem()?.id ? 'Edit Item' : 'Create Item'}</h2>
              <button onClick={() => setShowItemModal(false)} style={{ background: "none", border: "none", "font-size": "1.5rem", cursor: "pointer" }}></button>
            </div>
            <form onSubmit={handleSaveItem}>
              <div style={{ display: "grid", gap: "1rem", "grid-template-columns": "1fr 1fr" }}>
                <div style={{ "grid-column": "1 / -1" }}>
                  <label>Name</label>
                  <input type="text" value={editingItem()?.name || ''} 
                         onInput={(e) => setEditingItem({...editingItem()!, name: e.currentTarget.value})} required />
                </div>
                <div style={{ "grid-column": "1 / -1" }}>
                  <label>Description</label>
                  <textarea value={editingItem()?.description || ''} rows={2}
                            onInput={(e) => setEditingItem({...editingItem()!, description: e.currentTarget.value})} />
                </div>
                <div>
                  <label>Type</label>
                  <select value={editingItem()?.type || 'weapon'} 
                          onChange={(e) => setEditingItem({...editingItem()!, type: e.currentTarget.value})} required>
                    <option value="weapon">Weapon</option>
                    <option value="armor">Armor</option>
                    <option value="consumable">Consumable</option>
                    <option value="scroll">Scroll</option>
                    <option value="misc">Misc</option>
                  </select>
                </div>
                <div>
                  <label>Rarity</label>
                  <select value={editingItem()?.rarity || 'common'} 
                          onChange={(e) => setEditingItem({...editingItem()!, rarity: e.currentTarget.value})} required>
                    <option value="common">Common</option>
                    <option value="uncommon">Uncommon</option>
                    <option value="rare">Rare</option>
                    <option value="epic">Epic</option>
                    <option value="legendary">Legendary</option>
                  </select>
                </div>
                <div>
                  <label>Level Requirement</label>
                  <input type="number" step="1" min="1" value={editingItem()?.level || 1} 
                         onInput={(e) => setEditingItem({...editingItem()!, level: parseInt(e.currentTarget.value)})} required />
                </div>
                <div>
                  <label>Value (Gold)</label>
                  <input type="number" min="0" value={editingItem()?.value || 1} 
                         onInput={(e) => setEditingItem({...editingItem()!, value: parseInt(e.currentTarget.value)})} required />
                </div>
                <div>
                  <label>Damage</label>
                  <input type="number" step="0.1" min="0" value={editingItem()?.damage || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, damage: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>Armor</label>
                  <input type="number" step="0.1" min="0" value={editingItem()?.armor || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, armor: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>STR Bonus</label>
                  <input type="number" step="0.1" value={editingItem()?.strength_bonus || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, strength_bonus: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>DEX Bonus</label>
                  <input type="number" step="0.1" value={editingItem()?.dexterity_bonus || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, dexterity_bonus: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>CON Bonus</label>
                  <input type="number" step="0.1" value={editingItem()?.constitution_bonus || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, constitution_bonus: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>INT Bonus</label>
                  <input type="number" step="0.1" value={editingItem()?.intelligence_bonus || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, intelligence_bonus: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>WIS Bonus</label>
                  <input type="number" step="0.1" value={editingItem()?.wisdom_bonus || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, wisdom_bonus: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>CHA Bonus</label>
                  <input type="number" step="0.1" value={editingItem()?.charisma_bonus || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, charisma_bonus: parseInt(e.currentTarget.value)})} />
                </div>
                
                <div style={{ "grid-column": "1 / -1", "margin-top": "0.5rem" }}>
                  <h4 style={{ "font-size": "1rem", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Equipment Properties</h4>
                </div>
                
                <div>
                  <label>Slot</label>
                  <select value={editingItem()?.slot || ''} 
                          onChange={(e) => setEditingItem({...editingItem()!, slot: e.currentTarget.value || null})}>
                    <option value="">None</option>
                    <option value="weapon">Weapon</option>
                    <option value="offhand">Offhand</option>
                    <option value="head">Head</option>
                    <option value="chest">Chest</option>
                    <option value="legs">Legs</option>
                    <option value="hands">Hands</option>
                    <option value="feet">Feet</option>
                  </select>
                </div>
                
                <div>
                  <label>Weapon Type</label>
                  <select value={editingItem()?.weapon_type || ''} 
                          onChange={(e) => setEditingItem({...editingItem()!, weapon_type: e.currentTarget.value || null})}>
                    <option value="">None</option>
                    <option value="sword">Sword (1H)</option>
                    <option value="axe">Axe (1H)</option>
                    <option value="dagger">Dagger (1H)</option>
                    <option value="mace">Mace (1H)</option>
                    <option value="staff">Staff (2H)</option>
                    <option value="bow">Bow (1H)</option>
                    <option value="greatsword">Greatsword (2H)</option>
                    <option value="greataxe">Greataxe (2H)</option>
                    <option value="dual_dagger">Dual Daggers (Offhand)</option>
                    <option value="dual_sword">Dual Swords (Offhand)</option>
                  </select>
                  <small style={{ display: "block", "font-size": "0.75rem", color: "var(--text-secondary)", "margin-top": "0.25rem" }}>
                    For weapon items only
                  </small>
                </div>
                
                <div>
                  <label>Offhand Type</label>
                  <select value={editingItem()?.offhand_type || ''} 
                          onChange={(e) => setEditingItem({...editingItem()!, offhand_type: e.currentTarget.value || null})}>
                    <option value="">None</option>
                    <option value="shield">Shield</option>
                    <option value="tome">Tome</option>
                    <option value="orb">Orb</option>
                    <option value="quiver">Quiver</option>
                    <option value="dual_dagger">Dual Daggers</option>
                    <option value="dual_sword">Dual Swords</option>
                  </select>
                  <small style={{ display: "block", "font-size": "0.75rem", color: "var(--text-secondary)", "margin-top": "0.25rem" }}>
                    For offhand items only
                  </small>
                </div>
                
                <div>
                  <label>Damage Min</label>
                  <input type="number" step="0.1" min="0" value={editingItem()?.damage_min || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, damage_min: parseInt(e.currentTarget.value)})} />
                </div>
                
                <div>
                  <label>Damage Max</label>
                  <input type="number" step="0.1" min="0" value={editingItem()?.damage_max || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, damage_max: parseInt(e.currentTarget.value)})} />
                </div>
                
                <div>
                  <label>Attack Speed</label>
                  <input type="number" step="any" min="0" value={editingItem()?.attack_speed || 1.0} 
                         onInput={(e) => {
                           const val = parseFloat(e.currentTarget.value);
                           if (!isNaN(val)) setEditingItem({...editingItem()!, attack_speed: val});
                         }} />
                  <small style={{ display: "block", "font-size": "0.75rem", color: "var(--text-secondary)", "margin-top": "0.25rem" }}>
                    Seconds between attacks (lower = faster)
                  </small>
                </div>
                
                <div>
                  <label>Two-Handed</label>
                  <select value={editingItem()?.is_two_handed || 0} 
                          onChange={(e) => setEditingItem({...editingItem()!, is_two_handed: parseInt(e.currentTarget.value)})}>
                    <option value={0}>No</option>
                    <option value={1}>Yes</option>
                  </select>
                  <small style={{ display: "block", "font-size": "0.75rem", color: "var(--text-secondary)", "margin-top": "0.25rem" }}>
                    Auto-unequips offhand when equipped
                  </small>
                </div>
                
                <div style={{ "grid-column": "1 / -1", "margin-top": "0.5rem" }}>
                  <h4 style={{ "font-size": "1rem", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Stat Requirements</h4>
                  <p style={{ "font-size": "0.875rem", color: "var(--text-secondary)", margin: "0 0 0.5rem 0" }}>
                    Character must meet these stats to equip this item
                  </p>
                </div>
                
                <div>
                  <label>Required STR</label>
                  <input type="number" min="0" value={editingItem()?.required_strength || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, required_strength: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>Required DEX</label>
                  <input type="number" min="0" value={editingItem()?.required_dexterity || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, required_dexterity: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>Required CON</label>
                  <input type="number" min="0" value={editingItem()?.required_constitution || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, required_constitution: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>Required INT</label>
                  <input type="number" min="0" value={editingItem()?.required_intelligence || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, required_intelligence: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>Required WIS</label>
                  <input type="number" min="0" value={editingItem()?.required_wisdom || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, required_wisdom: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>Required CHA</label>
                  <input type="number" min="0" value={editingItem()?.required_charisma || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, required_charisma: parseInt(e.currentTarget.value)})} />
                </div>
                
                <div style={{ "grid-column": "1 / -1", "margin-top": "0.5rem" }}>
                  <h4 style={{ "font-size": "1rem", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Consumable Settings</h4>
                </div>
                
                <div>
                  <label>Health Restore</label>
                  <input type="number" min="0" value={editingItem()?.health_restore || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, health_restore: parseInt(e.currentTarget.value)})} />
                  <small style={{ display: "block", "font-size": "0.75rem", color: "var(--text-secondary)", "margin-top": "0.25rem" }}>
                    HP restored when consumed (for potions)
                  </small>
                </div>
                
                <div>
                  <label>Mana Restore</label>
                  <input type="number" min="0" value={editingItem()?.mana_restore || 0} 
                         onInput={(e) => setEditingItem({...editingItem()!, mana_restore: parseInt(e.currentTarget.value)})} />
                  <small style={{ display: "block", "font-size": "0.75rem", color: "var(--text-secondary)", "margin-top": "0.25rem" }}>
                    MP restored when consumed (for potions)
                  </small>
                </div>
                
                <div style={{ "grid-column": "1 / -1", "margin-top": "0.5rem" }}>
                  <h4 style={{ "font-size": "1rem", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Scroll Settings</h4>
                </div>
                
                <div style={{ "grid-column": "1 / -1" }}>
                  <label>Teaches Ability (for scrolls)</label>
                  <select value={editingItem()?.teaches_ability_id || ''} 
                          onChange={(e) => setEditingItem({...editingItem()!, teaches_ability_id: e.currentTarget.value ? parseInt(e.currentTarget.value) : null})}>
                    <option value="">None - Not a scroll</option>
                    <For each={abilities().sort((a: any, b: any) => a.name.localeCompare(b.name))}>
                      {(ability: any) => (
                        <option value={ability.id}>{ability.name} (Lvl {ability.required_level})</option>
                      )}
                    </For>
                  </select>
                  <small style={{ display: "block", "font-size": "0.75rem", color: "var(--text-secondary)", "margin-top": "0.25rem" }}>
                    Set this to make the item a scroll that teaches an ability when used
                  </small>
                </div>
              </div>
              <div style={{ display: "flex", gap: "1rem", "margin-top": "1.5rem" }}>
                <button type="submit" class="button primary" style={{ flex: 1 }}>Save</button>
                <button type="button" class="button secondary" style={{ flex: 1 }} onClick={() => setShowItemModal(false)}>Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </Show>
      
      {/* Ability Edit Modal */}
      <Show when={showAbilityModal()}>
        <div style={{
          position: "fixed", top: 0, left: 0, right: 0, bottom: 0,
          background: "rgba(0,0,0,0.7)", display: "flex",
          "align-items": "center", "justify-content": "center", "z-index": 1000
        }} onClick={() => setShowAbilityModal(false)}>
          <div class="card" style={{ "max-width": "600px", width: "90%", "max-height": "90vh", overflow: "auto" }} 
               onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
              <h2>{editingAbility()?.id ? 'Edit Ability' : 'Create Ability'}</h2>
              <button onClick={() => setShowAbilityModal(false)} style={{ background: "none", border: "none", "font-size": "1.5rem", cursor: "pointer" }}></button>
            </div>
            <form onSubmit={handleSaveAbility}>
              <div style={{ display: "grid", gap: "1rem", "grid-template-columns": "1fr 1fr" }}>
                <div style={{ "grid-column": "1 / -1" }}>
                  <label>Name</label>
                  <input type="text" value={editingAbility()?.name || ''} 
                         onInput={(e) => setEditingAbility({...editingAbility()!, name: e.currentTarget.value})} required />
                </div>
                <div style={{ "grid-column": "1 / -1" }}>
                  <label>Description</label>
                  <textarea value={editingAbility()?.description || ''} rows={2}
                            onInput={(e) => setEditingAbility({...editingAbility()!, description: e.currentTarget.value})} />
                </div>
                <div>
                  <label>Type</label>
                  <select value={editingAbility()?.type || 'damage'} 
                          onChange={(e) => setEditingAbility({...editingAbility()!, type: e.currentTarget.value})} required>
                    <option value="ability">Ability</option>
                    <option value="active">Active</option>
                    <option value="buff">Buff</option>
                    <option value="damage">Damage</option>
                    <option value="debuff">Debuff</option>
                    <option value="heal">Heal</option>
                    <option value="magical">Magical</option>
                    <option value="spell">Spell</option>
                    <option value="utility">Utility</option>
                  </select>
                </div>
                <div>
                  <label>Category</label>
                  <select value={editingAbility()?.category || 'combat'} 
                          onChange={(e) => setEditingAbility({...editingAbility()!, category: e.currentTarget.value})} required>
                    <option value="buff">Buff</option>
                    <option value="combat">Combat</option>
                    <option value="damage">Damage</option>
                    <option value="defense">Defense</option>
                    <option value="heal">Heal</option>
                    <option value="healing">Healing</option>
                    <option value="magic">Magic</option>
                    <option value="utility">Utility</option>
                  </select>
                </div>
                
                <div style={{ "grid-column": "1 / -1", "margin-top": "0.5rem" }}>
                  <h3 style={{ "font-size": "1rem", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Effect Values</h3>
                </div>
                
                <div style={{ "grid-column": "1 / -1", padding: "0.5rem", background: "var(--bg-light)", "border-radius": "4px" }}>
                  <p style={{ margin: 0, "font-size": "0.875rem", color: "var(--text-secondary)" }}>
                    INFO: Damage, healing, and stat scaling are now configured in the <strong>Ability Effects</strong> system below. The old damage_min, damage_max, healing, and stat_scaling fields have been removed.
                  </p>
                </div>
                
                <div style={{ "grid-column": "1 / -1", "margin-top": "0.5rem" }}>
                  <h3 style={{ "font-size": "1rem", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Buff/Debuff (if applicable)</h3>
                </div>
                
                <div style={{ "grid-column": "1 / -1", padding: "0.5rem", background: "var(--bg-light)", "border-radius": "4px" }}>
                  <p style={{ margin: 0, "font-size": "0.875rem", color: "var(--text-secondary)" }}>
                    INFO: Buff abilities now use the <strong>Ability Effects</strong> system below. The old buff_stat, buff_amount, and buff_duration fields are deprecated.
                  </p>
                </div>
                
                <div style={{ "grid-column": "1 / -1", "margin-top": "0.5rem" }}>
                  <h3 style={{ "font-size": "1rem", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Costs & Requirements</h3>
                </div>
                
                <div>
                  <label>Level Requirement</label>
                  <input type="number" step="1" min="1" value={editingAbility()?.required_level || 1} 
                         onInput={(e) => setEditingAbility({...editingAbility()!, required_level: parseInt(e.currentTarget.value)})} required />
                </div>
                <div>
                  <label>Mana Cost</label>
                  <input type="number" step="1" min="0" value={editingAbility()?.mana_cost || 0} 
                         onInput={(e) => setEditingAbility({...editingAbility()!, mana_cost: parseInt(e.currentTarget.value)})} required />
                </div>
                <div>
                  <label>Cooldown (seconds)</label>
                  <input type="number" step="0.01" min="0" value={editingAbility()?.cooldown || 0} 
                         onChange={(e) => setEditingAbility({...editingAbility()!, cooldown: parseFloat(e.currentTarget.value) || 0})} required />
                </div>
                <div>
                  <label>Primary Stat (for scaling)</label>
                  <select value={editingAbility()?.primary_stat || ''} 
                          onChange={(e) => setEditingAbility({...editingAbility()!, primary_stat: e.currentTarget.value || null})}>
                    <option value="">None</option>
                    <option value="strength">Strength</option>
                    <option value="dexterity">Dexterity</option>
                    <option value="constitution">Constitution</option>
                    <option value="intelligence">Intelligence</option>
                    <option value="wisdom">Wisdom</option>
                    <option value="charisma">Charisma</option>
                  </select>
                </div>
                
                <div style={{ "grid-column": "1 / -1", "margin-top": "0.5rem" }}>
                  <h3 style={{ "font-size": "1rem", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Stat Requirements</h3>
                </div>
                
                <div>
                  <label>Required STR</label>
                  <input type="number" step="1" min="0" value={editingAbility()?.required_strength ?? 0} 
                         onInput={(e) => setEditingAbility({...editingAbility()!, required_strength: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>Required DEX</label>
                  <input type="number" step="1" min="0" value={editingAbility()?.required_dexterity ?? 0} 
                         onInput={(e) => setEditingAbility({...editingAbility()!, required_dexterity: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>Required CON</label>
                  <input type="number" step="1" min="0" value={editingAbility()?.required_constitution ?? 0} 
                         onInput={(e) => setEditingAbility({...editingAbility()!, required_constitution: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>Required INT</label>
                  <input type="number" step="1" min="0" value={editingAbility()?.required_intelligence ?? 0} 
                         onInput={(e) => setEditingAbility({...editingAbility()!, required_intelligence: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>Required WIS</label>
                  <input type="number" step="1" min="0" value={editingAbility()?.required_wisdom ?? 0} 
                         onInput={(e) => setEditingAbility({...editingAbility()!, required_wisdom: parseInt(e.currentTarget.value)})} />
                </div>
                <div>
                  <label>Required CHA</label>
                  <input type="number" step="1" min="0" value={editingAbility()?.required_charisma ?? 0} 
                         onInput={(e) => setEditingAbility({...editingAbility()!, required_charisma: parseInt(e.currentTarget.value)})} />
                </div>
                
                <div style={{ "grid-column": "1 / -1", "margin-top": "0.5rem" }}>
                  <h3 style={{ "font-size": "1rem", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Equipment Requirements</h3>
                  <p style={{ "font-size": "0.875rem", color: "var(--text-secondary)", margin: "0 0 0.5rem 0" }}>
                    Hold Ctrl/Cmd to select multiple weapon or offhand types
                  </p>
                </div>
                
                <div>
                  <label>Weapon Types Required</label>
                  <select 
                    multiple 
                    size="8"
                    onChange={(e) => {
                      const selected = Array.from(e.currentTarget.selectedOptions).map(opt => opt.value);
                      setEditingAbility({...editingAbility()!, weapon_type_requirement: selected.length > 0 ? selected.join(',') : null});
                    }}
                    style={{ width: "100%", padding: "0.5rem" }}
                  >
                    <option value="sword" selected={editingAbility()?.weapon_type_requirement?.includes('sword') && !editingAbility()?.weapon_type_requirement?.includes('dual_sword')}>Sword (1H)</option>
                    <option value="greatsword" selected={editingAbility()?.weapon_type_requirement?.includes('greatsword')}>Greatsword (2H)</option>
                    <option value="axe" selected={editingAbility()?.weapon_type_requirement?.includes('axe') && !editingAbility()?.weapon_type_requirement?.includes('greataxe')}>Axe (1H)</option>
                    <option value="greataxe" selected={editingAbility()?.weapon_type_requirement?.includes('greataxe')}>Greataxe (2H)</option>
                    <option value="mace" selected={editingAbility()?.weapon_type_requirement?.includes('mace')}>Mace (1H)</option>
                    <option value="dagger" selected={editingAbility()?.weapon_type_requirement?.includes('dagger') && !editingAbility()?.weapon_type_requirement?.includes('dual_dagger')}>Dagger (1H)</option>
                    <option value="dual_dagger" selected={editingAbility()?.weapon_type_requirement?.includes('dual_dagger')}>Dual Daggers</option>
                    <option value="dual_sword" selected={editingAbility()?.weapon_type_requirement?.includes('dual_sword')}>Dual Swords</option>
                    <option value="bow" selected={editingAbility()?.weapon_type_requirement?.includes('bow')}>Bow</option>
                    <option value="wand" selected={editingAbility()?.weapon_type_requirement?.includes('wand')}>Wand</option>
                    <option value="staff" selected={editingAbility()?.weapon_type_requirement?.includes('staff')}>Staff (2H)</option>
                    <option value="polearm" selected={editingAbility()?.weapon_type_requirement?.includes('polearm')}>Polearm</option>
                  </select>
                  <div style={{ "font-size": "0.75rem", color: "var(--text-secondary)", "margin-top": "0.25rem" }}>
                    Selected: {editingAbility()?.weapon_type_requirement || 'None (Any Weapon)'}
                  </div>
                </div>
                
                <div>
                  <label>Offhand Types Required</label>
                  <select 
                    multiple 
                    size="8"
                    onChange={(e) => {
                      const selected = Array.from(e.currentTarget.selectedOptions).map(opt => opt.value);
                      setEditingAbility({...editingAbility()!, offhand_type_requirement: selected.length > 0 ? selected.join(',') : null});
                    }}
                    style={{ width: "100%", padding: "0.5rem" }}
                  >
                    <option value="shield" selected={editingAbility()?.offhand_type_requirement?.includes('shield')}>Shield</option>
                    <option value="orb" selected={editingAbility()?.offhand_type_requirement?.includes('orb')}>Orb</option>
                    <option value="tome" selected={editingAbility()?.offhand_type_requirement?.includes('tome')}>Tome</option>
                    <option value="focus" selected={editingAbility()?.offhand_type_requirement?.includes('focus')}>Focus</option>
                    <option value="quiver" selected={editingAbility()?.offhand_type_requirement?.includes('quiver')}>Quiver</option>
                    <option value="dual_dagger" selected={editingAbility()?.offhand_type_requirement?.includes('dual_dagger')}>Dual Daggers</option>
                    <option value="dual_sword" selected={editingAbility()?.offhand_type_requirement?.includes('dual_sword')}>Dual Swords</option>
                  </select>
                  <div style={{ "font-size": "0.75rem", color: "var(--text-secondary)", "margin-top": "0.25rem" }}>
                    Selected: {editingAbility()?.offhand_type_requirement || 'None (No Requirement)'}
                  </div>
                </div>
              </div>
              <div style={{ display: "flex", gap: "1rem", "margin-top": "1.5rem" }}>
                <button type="submit" class="button primary" style={{ flex: 1 }}>Save</button>
                <button type="button" class="button secondary" style={{ flex: 1 }} onClick={() => setShowAbilityModal(false)}>Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </Show>
      
      {/* Ability Effects Modal */}
      <Show when={showAbilityEffectModal()}>
        <div style={{
          position: "fixed", top: 0, left: 0, right: 0, bottom: 0,
          background: "rgba(0,0,0,0.7)", display: "flex",
          "align-items": "center", "justify-content": "center", "z-index": 1000
        }} onClick={() => setShowAbilityEffectModal(false)}>
          <div class="card" style={{ "max-width": "900px", width: "95%", "max-height": "90vh", overflow: "auto" }} 
               onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
              <h2>Ability Effects - {abilities().find((a: any) => a.id === selectedAbilityForEffects())?.name}</h2>
              <button onClick={() => setShowAbilityEffectModal(false)} style={{ background: "none", border: "none", "font-size": "1.5rem", cursor: "pointer" }}></button>
            </div>
            
            {/* Add New Effect Button */}
            <button class="button primary" style={{ "margin-bottom": "1rem" }} onClick={() => {
              setEditingAbilityEffect({
                ability_id: selectedAbilityForEffects(),
                effect_order: (abilityEffects().length || 0) + 1,
                effect_type: 'damage',
                target: 'enemy',
                value_min: 0,
                value_max: 0,
                is_periodic: 0,
                tick_interval: 0,
                tick_count: 0,
                tick_value: 0,
                stat_affected: null,
                stat_scaling: null,
                scaling_factor: 0,
                chance: 1.0,
                duration: 0,
                shield_amount: 0,
                drain_percent: 0,
                stacks_max: 1
              });
            }}>
              Add New Effect
            </button>
            
            {/* Effects List */}
            <Show when={abilityEffects().length > 0}>
              <div style={{ "margin-bottom": "2rem" }}>
                <h3 style={{ "margin-bottom": "1rem" }}>Current Effects</h3>
                <For each={abilityEffects()}>
                  {(effect: any) => (
                    <div style={{ 
                      padding: "1rem", 
                      background: "var(--bg-light)", 
                      "border-radius": "8px",
                      "margin-bottom": "1rem"
                    }}>
                      <div style={{ display: "flex", "justify-content": "space-between", "align-items": "start" }}>
                        <div style={{ flex: 1 }}>
                          <div style={{ "font-weight": "bold", "margin-bottom": "0.5rem" }}>
                            Effect #{effect.effect_order}: {effect.effect_type?.toUpperCase() || 'UNKNOWN'}  {effect.target || 'N/A'}
                          </div>
                          <div style={{ "font-size": "0.9rem", color: "var(--text-secondary)" }}>
                            <Show when={effect.effect_type === 'damage' || effect.effect_type === 'heal'}>
                              <div>Value: {effect.value_min}-{effect.value_max}</div>
                            </Show>
                            <Show when={effect.is_periodic === 1}>
                              <div>Periodic: {effect.tick_value} per tick, every {effect.tick_interval}s for {effect.tick_count} ticks (Total: {effect.tick_interval * effect.tick_count}s)</div>
                            </Show>
                            <Show when={effect.stat_affected}>
                              <div>Stat: {effect.stat_affected}</div>
                            </Show>
                            <Show when={effect.duration > 0}>
                              <div>Duration: {effect.duration}s</div>
                            </Show>
                            <Show when={effect.stat_scaling}>
                              <div>Scaling: {effect.stat_scaling}  {effect.scaling_factor}</div>
                            </Show>
                            <Show when={effect.chance < 1.0}>
                              <div>Chance: {(effect.chance * 100).toFixed(0)}%</div>
                            </Show>
                            <Show when={effect.shield_amount > 0}>
                              <div>Shield: {effect.shield_amount}</div>
                            </Show>
                            <Show when={effect.drain_percent > 0}>
                              <div>Drain: {(effect.drain_percent * 100).toFixed(0)}%</div>
                            </Show>
                            <Show when={effect.stat_affected === 'thorns'}>
                              <div>Thorns: {effect.value_min}% reflect</div>
                            </Show>
                            <Show when={effect.stacks_max > 1}>
                              <div>Max Stacks: {effect.stacks_max}</div>
                            </Show>
                          </div>
                        </div>
                        <div style={{ display: "flex", gap: "0.5rem" }}>
                          <button 
                            class="button secondary" 
                            style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem" }}
                            onClick={() => handleEditAbilityEffect(effect)}
                          >
                            Edit
                          </button>
                          <button 
                            class="button" 
                            style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", background: "var(--danger)" }}
                            onClick={() => handleDeleteAbilityEffect(effect.id)}
                          >
                            Delete
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </For>
              </div>
            </Show>
            
            {/* Effect Edit Form */}
            <Show when={editingAbilityEffect()}>
              <div style={{ padding: "1.5rem", background: "var(--bg-light)", "border-radius": "8px" }}>
                <h3 style={{ "margin-bottom": "1rem" }}>{editingAbilityEffect()?.id ? 'Edit Effect' : 'New Effect'}</h3>
                <form onSubmit={handleSaveAbilityEffect}>
                  <div style={{ display: "grid", gap: "1rem", "grid-template-columns": "1fr 1fr" }}>
                    <div>
                      <label>Effect Order</label>
                      <input type="number" step="1" min="1" value={editingAbilityEffect()?.effect_order || 1} 
                             onInput={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, effect_order: parseInt(e.currentTarget.value)})} required />
                    </div>
                    <div>
                      <label>Effect Type</label>
                      <select value={editingAbilityEffect()?.effect_type || 'damage'} 
                              onChange={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, effect_type: e.currentTarget.value})} required>
                        <option value="damage">Damage</option>
                        <option value="heal">Heal</option>
                        <option value="buff">Buff</option>
                        <option value="debuff">Debuff</option>
                        <option value="dot">DOT (Damage Over Time)</option>
                        <option value="hot">HOT (Heal Over Time)</option>
                        <option value="drain">Drain</option>
                        <option value="shield">Shield</option>
                      </select>
                    </div>
                    <div>
                      <label>Target</label>
                      <select value={editingAbilityEffect()?.target || 'enemy'} 
                              onChange={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, target: e.currentTarget.value})} required>
                        <option value="self">Self</option>
                        <option value="enemy">Enemy</option>
                        <option value="ally">Ally</option>
                      </select>
                    </div>
                    <div>
                      <label>Chance (0-1)</label>
                      <input type="number" step="0.01" min="0" max="1" value={editingAbilityEffect()?.chance ?? 1.0} 
                             onChange={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, chance: parseFloat(e.currentTarget.value) || 1.0})} />
                    </div>
                    
                    <div style={{ "grid-column": "1 / -1", "margin-top": "0.5rem" }}>
                      <h4 style={{ "font-size": "1rem", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Instant Values</h4>
                    </div>
                    
                    <div>
                      <label>Value Min</label>
                      <input type="number" step="0.1" min="0" value={editingAbilityEffect()?.value_min ?? 0} 
                             onInput={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, value_min: parseInt(e.currentTarget.value) || 0})} />
                    </div>
                    <div>
                      <label>Value Max</label>
                      <input type="number" step="0.1" min="0" value={editingAbilityEffect()?.value_max ?? 0} 
                             onInput={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, value_max: parseInt(e.currentTarget.value) || 0})} />
                    </div>
                    
                    <div style={{ "grid-column": "1 / -1", "margin-top": "0.5rem" }}>
                      <h4 style={{ "font-size": "1rem", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Periodic Effects (DOT/HOT)</h4>
                    </div>
                    
                    <div>
                      <label>Is Periodic</label>
                      <select value={editingAbilityEffect()?.is_periodic ?? 0} 
                              onChange={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, is_periodic: parseInt(e.currentTarget.value)})}>
                        <option value={0}>No</option>
                        <option value={1}>Yes</option>
                      </select>
                    </div>
                    <div>
                      <label>Tick Value</label>
                      <input type="number" step="0.1" min="0" value={editingAbilityEffect()?.tick_value ?? 0} 
                             onInput={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, tick_value: parseInt(e.currentTarget.value) || 0})} />
                    </div>
                    <div>
                      <label>Tick Interval (seconds)</label>
                      <input 
                        type="number" 
                        min="0" 
                        step="0.1" 
                        value={editingAbilityEffect()?.tick_interval ?? 0} 
                        onChange={(e) => {
                          const val = parseFloat(e.currentTarget.value);
                          setEditingAbilityEffect({...editingAbilityEffect()!, tick_interval: isNaN(val) ? 0 : val});
                        }} 
                      />
                      <small style={{ display: "block", "font-size": "0.75rem", color: "var(--text-secondary)", "margin-top": "0.25rem" }}>
                        Can use decimals (e.g., 0.5 for half-second ticks)
                      </small>
                    </div>
                    <div>
                      <label>Tick Count</label>
                      <input type="number" step="1" min="0" value={editingAbilityEffect()?.tick_count ?? 0} 
                             onInput={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, tick_count: parseInt(e.currentTarget.value) || 0})} />
                    </div>
                    
                    <div style={{ "grid-column": "1 / -1", "margin-top": "0.5rem" }}>
                      <h4 style={{ "font-size": "1rem", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Buffs/Debuffs</h4>
                    </div>
                    
                    <div>
                      <label>Stat Affected</label>
                      <select value={editingAbilityEffect()?.stat_affected || ''} 
                              onChange={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, stat_affected: e.currentTarget.value || null})}>
                        <option value="">None</option>
                        <option value="strength">Strength</option>
                        <option value="dexterity">Dexterity</option>
                        <option value="constitution">Constitution</option>
                        <option value="intelligence">Intelligence</option>
                        <option value="wisdom">Wisdom</option>
                        <option value="charisma">Charisma</option>
                        <option value="evasiveness">Evasiveness</option>
                        <option value="armor">Armor</option>
                        <option value="damage">Damage</option>
                        <option value="thorns">Thorns (Reflect Damage)</option>
                      </select>
                      <small style={{ display: "block", "font-size": "0.75rem", color: "var(--text-secondary)", "margin-top": "0.25rem" }}>For Thorns, set value_min to reflect %</small>
                    </div>
                    <div>
                      <label>Duration (seconds)</label>
                      <input type="number" step="0.1" min="0" value={editingAbilityEffect()?.duration ?? 0} 
                             onInput={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, duration: parseInt(e.currentTarget.value) || 0})} />
                    </div>
                    
                    <div style={{ "grid-column": "1 / -1", "margin-top": "0.5rem" }}>
                      <h4 style={{ "font-size": "1rem", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Scaling</h4>
                    </div>
                    
                    <div>
                      <label>Stat Scaling</label>
                      <select value={editingAbilityEffect()?.stat_scaling || ''} 
                              onChange={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, stat_scaling: e.currentTarget.value || null})}>
                        <option value="">None</option>
                        <option value="strength">Strength</option>
                        <option value="dexterity">Dexterity</option>
                        <option value="constitution">Constitution</option>
                        <option value="intelligence">Intelligence</option>
                        <option value="wisdom">Wisdom</option>
                        <option value="charisma">Charisma</option>
                      </select>
                    </div>
                    <div>
                      <label>Scaling Factor</label>
                      <input type="number" step="0.1" min="0" value={editingAbilityEffect()?.scaling_factor ?? 0} 
                             onChange={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, scaling_factor: parseFloat(e.currentTarget.value) || 0})} />
                    </div>
                    
                    <div style={{ "grid-column": "1 / -1", "margin-top": "0.5rem" }}>
                      <h4 style={{ "font-size": "1rem", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Special Effects</h4>
                    </div>
                    
                    <div>
                      <label>Shield Amount</label>
                      <input type="number" step="0.1" min="0" value={editingAbilityEffect()?.shield_amount ?? 0} 
                             onInput={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, shield_amount: parseInt(e.currentTarget.value) || 0})} />
                    </div>
                    <div>
                      <label>Drain % (0-1)</label>
                      <input type="number" step="0.01" min="0" max="1" value={editingAbilityEffect()?.drain_percent ?? 0} 
                             onChange={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, drain_percent: parseFloat(e.currentTarget.value) || 0})} />
                    </div>
                    <div>
                      <label>Max Stacks</label>
                      <input type="number" step="1" min="1" value={editingAbilityEffect()?.stacks_max ?? 1} 
                             onInput={(e) => setEditingAbilityEffect({...editingAbilityEffect()!, stacks_max: parseInt(e.currentTarget.value) || 1})} />
                      <small style={{ display: "block", "font-size": "0.75rem", color: "var(--text-secondary)" }}>How many times this effect can stack</small>
                    </div>
                  </div>
                  <div style={{ display: "flex", gap: "1rem", "margin-top": "1.5rem" }}>
                    <button type="submit" class="button primary" style={{ flex: 1 }}>Save Effect</button>
                    <button type="button" class="button secondary" style={{ flex: 1 }} onClick={() => setEditingAbilityEffect(null)}>Cancel</button>
                  </div>
                </form>
              </div>
            </Show>
            
            <div style={{ "margin-top": "1.5rem" }}>
              <button class="button secondary" onClick={() => setShowAbilityEffectModal(false)}>Close</button>
            </div>
          </div>
        </div>
      </Show>
      
      {/* Region Edit Modal */}
      <Show when={showRegionModal()}>
        <div style={{
          position: "fixed", top: 0, left: 0, right: 0, bottom: 0,
          background: "rgba(0,0,0,0.7)", display: "flex",
          "align-items": "center", "justify-content": "center", "z-index": 1000
        }} onClick={() => setShowRegionModal(false)}>
          <div class="card" style={{ "max-width": "600px", width: "90%", "max-height": "90vh", overflow: "auto" }} 
               onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
              <h2>{editingRegion()?.id ? 'Edit Region' : 'Create Region'}</h2>
              <button onClick={() => setShowRegionModal(false)} style={{ background: "none", border: "none", "font-size": "1.5rem", cursor: "pointer" }}></button>
            </div>
            <form onSubmit={handleSaveRegion}>
              <div style={{ display: "grid", gap: "1rem" }}>
                <div>
                  <label>Name</label>
                  <input type="text" value={editingRegion()?.name || ''} 
                         onInput={(e) => setEditingRegion({...editingRegion()!, name: e.currentTarget.value})} required />
                </div>
                <div>
                  <label>Description</label>
                  <textarea value={editingRegion()?.description || ''} rows={3}
                            onInput={(e) => setEditingRegion({...editingRegion()!, description: e.currentTarget.value})} />
                </div>
                <div style={{ display: "grid", "grid-template-columns": "1fr 1fr", gap: "1rem" }}>
                  <div>
                    <label>Min Level</label>
                    <input type="number" min="1" value={editingRegion()?.min_level || 1} 
                           onInput={(e) => setEditingRegion({...editingRegion()!, min_level: parseInt(e.currentTarget.value)})} required />
                  </div>
                  <div>
                    <label>Max Level</label>
                    <input type="number" min="1" value={editingRegion()?.max_level || 5} 
                           onInput={(e) => setEditingRegion({...editingRegion()!, max_level: parseInt(e.currentTarget.value)})} required />
                  </div>
                </div>
                <div>
                  <label style={{ display: "flex", "align-items": "center", gap: "0.5rem" }}>
                    <input type="checkbox" checked={editingRegion()?.locked === 1} 
                           onChange={(e) => setEditingRegion({...editingRegion()!, locked: e.currentTarget.checked ? 1 : 0})} />
                    Locked (requires unlock requirement)
                  </label>
                </div>
                <div>
                  <label>Unlock Requirement (optional)</label>
                  <div style={{ 
                    background: "var(--bg-light)", 
                    padding: "0.75rem", 
                    "border-radius": "4px", 
                    "margin-bottom": "0.5rem",
                    "font-size": "0.85rem",
                    "line-height": "1.5"
                  }}>
                    <strong style={{ display: "block", "margin-bottom": "0.5rem", color: "var(--accent)" }}>Supported Formats:</strong>
                    <ul style={{ margin: "0", "padding-left": "1.25rem" }}>
                      <li><strong>Level:</strong> "Reach level X" or "level X" (e.g., "Reach level 18")</li>
                      <li><strong>Boss:</strong> "Defeat [Boss Name]" - must match named mob exactly (e.g., "Defeat Shadowfang")</li>
                      <li><strong>Dungeon:</strong> "Complete [Dungeon Name] dungeon" (e.g., "Complete Ancient Ruins dungeon")</li>
                    </ul>
                    <small style={{ display: "block", "margin-top": "0.5rem", color: "var(--text-secondary)" }}>
                      Note: Text patterns are case-insensitive. Changes take effect immediately for new unlocks.
                    </small>
                  </div>
                  <input type="text" value={editingRegion()?.unlock_requirement || ''} 
                         onInput={(e) => setEditingRegion({...editingRegion()!, unlock_requirement: e.currentTarget.value || null})}
                         placeholder="e.g., Reach level 18" />
                </div>
              </div>
              <div style={{ display: "flex", gap: "1rem", "margin-top": "1.5rem" }}>
                <button type="submit" class="button primary" style={{ flex: 1 }}>Save</button>
                <button type="button" class="button secondary" style={{ flex: 1 }} onClick={() => setShowRegionModal(false)}>Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </Show>
      
      {/* Merchant Edit Modal */}
      <Show when={showMerchantModal()}>
        <div style={{
          position: "fixed", top: 0, left: 0, right: 0, bottom: 0,
          background: "rgba(0,0,0,0.7)", display: "flex",
          "align-items": "center", "justify-content": "center", "z-index": 1000
        }} onClick={() => setShowMerchantModal(false)}>
          <div class="card" style={{ "max-width": "600px", width: "90%", "max-height": "90vh", overflow: "auto" }} 
               onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
              <h2>{editingMerchant()?.id ? 'Edit Merchant' : 'Create Merchant'}</h2>
              <button onClick={() => setShowMerchantModal(false)} style={{ background: "none", border: "none", "font-size": "1.5rem", cursor: "pointer" }}></button>
            </div>
            <form onSubmit={handleSaveMerchant}>
              <div style={{ display: "grid", gap: "1rem" }}>
                <div>
                  <label>Name</label>
                  <input type="text" value={editingMerchant()?.name || ''} 
                         onInput={(e) => setEditingMerchant({...editingMerchant()!, name: e.currentTarget.value})} required />
                </div>
                <div>
                  <label>Description</label>
                  <textarea value={editingMerchant()?.description || ''} rows={2}
                            onInput={(e) => setEditingMerchant({...editingMerchant()!, description: e.currentTarget.value})} />
                </div>
                <div>
                  <label>Region</label>
                  <select value={editingMerchant()?.region_id || 1} 
                          onChange={(e) => setEditingMerchant({...editingMerchant()!, region_id: parseInt(e.currentTarget.value)})} required>
                    <For each={regions()}>
                      {(region: any) => <option value={region.id}>{region.name}</option>}
                    </For>
                  </select>
                </div>
              </div>
              <div style={{ display: "flex", gap: "1rem", "margin-top": "1.5rem" }}>
                <button type="submit" class="button primary" style={{ flex: 1 }}>Save</button>
                <button type="button" class="button secondary" style={{ flex: 1 }} onClick={() => setShowMerchantModal(false)}>Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </Show>
      
      {/* Sub-Area Mob Spawn Modal */}
      <Show when={showSubAreaMobModal()}>
        <div style={{
          position: "fixed", top: 0, left: 0, right: 0, bottom: 0,
          background: "rgba(0,0,0,0.7)", display: "flex",
          "align-items": "center", "justify-content": "center", "z-index": 1000
        }} onClick={() => setShowSubAreaMobModal(false)}>
          <div class="card" style={{ "max-width": "500px", width: "90%"}} 
               onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
              <h2>{editingSubAreaMob()?.id ? 'Edit Mob Spawn' : 'Add Mob Spawn'}</h2>
              <button onClick={() => setShowSubAreaMobModal(false)} style={{ background: "none", border: "none", "font-size": "1.5rem", cursor: "pointer" }}></button>
            </div>
            <form onSubmit={handleSaveSubAreaMob}>
              <div style={{ display: "grid", gap: "1rem" }}>
                <div>
                  <label>Sub-Area</label>
                  <select value={editingSubAreaMob()?.sub_area_id || 1} 
                          onChange={(e) => setEditingSubAreaMob({...editingSubAreaMob()!, sub_area_id: parseInt(e.currentTarget.value)})} required>
                    <For each={subAreas().sort((a: any, b: any) => a.region_id - b.region_id || a.id - b.id)}>
                      {(subArea: any) => <option value={subArea.id}>{subArea.region_name} - {subArea.name}</option>}
                    </For>
                  </select>
                </div>
                <div>
                  <label>Mob</label>
                  <select value={editingSubAreaMob()?.mob_id || 1} 
                          onChange={(e) => setEditingSubAreaMob({...editingSubAreaMob()!, mob_id: parseInt(e.currentTarget.value)})} required>
                    <For each={mobs().sort((a: any, b: any) => a.level - b.level || a.name.localeCompare(b.name))}>
                      {(mob: any) => <option value={mob.id}>{mob.name} (Lvl {mob.level})</option>}
                    </For>
                  </select>
                </div>
                <div>
                  <label>Spawn Weight (higher = more common)</label>
                  <input type="number" min="1" value={editingSubAreaMob()?.spawn_weight || 100} 
                         onInput={(e) => setEditingSubAreaMob({...editingSubAreaMob()!, spawn_weight: parseInt(e.currentTarget.value)})} required />
                  <small style={{ display: "block", "margin-top": "0.25rem", color: "var(--text-secondary)" }}>
                    Relative spawn frequency. Higher numbers = spawns more often.
                  </small>
                </div>
                <div>
                  <label>Level Variance ()</label>
                  <input type="number" min="0" max="5" value={editingSubAreaMob()?.level_variance || 0} 
                         onInput={(e) => setEditingSubAreaMob({...editingSubAreaMob()!, level_variance: parseInt(e.currentTarget.value)})} required />
                  <small style={{ display: "block", "margin-top": "0.25rem", color: "var(--text-secondary)" }}>
                    Mob level can vary by  this amount from base level.
                  </small>
                </div>
              </div>
              <div style={{ display: "flex", gap: "1rem", "margin-top": "1.5rem" }}>
                <button type="submit" class="button primary" style={{ flex: 1 }}>Save</button>
                <button type="button" class="button secondary" style={{ flex: 1 }} onClick={() => setShowSubAreaMobModal(false)}>Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </Show>
      
      {/* Merchant Inventory Modal */}
      <Show when={showMerchantInvModal()}>
        <div style={{
          position: "fixed", top: 0, left: 0, right: 0, bottom: 0,
          background: "rgba(0,0,0,0.7)", display: "flex",
          "align-items": "center", "justify-content": "center", "z-index": 1000
        }} onClick={() => setShowMerchantInvModal(false)}>
          <div class="card" style={{ "max-width": "500px", width: "90%" }} 
               onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
              <h2>{editingMerchantInv()?.id ? 'Edit Merchant Item' : 'Add Merchant Item'}</h2>
              <button onClick={() => setShowMerchantInvModal(false)} style={{ background: "none", border: "none", "font-size": "1.5rem", cursor: "pointer" }}></button>
            </div>
            <form onSubmit={handleSaveMerchantInv}>
              <div style={{ display: "grid", gap: "1rem" }}>
                <div>
                  <label>Merchant</label>
                  <select value={editingMerchantInv()?.merchant_id || 1} 
                          onChange={(e) => setEditingMerchantInv({...editingMerchantInv()!, merchant_id: parseInt(e.currentTarget.value)})} required>
                    <For each={merchants()}>
                      {(merchant: any) => <option value={merchant.id}>{merchant.name} ({merchant.region_name})</option>}
                    </For>
                  </select>
                </div>
                <div>
                  <label>Item</label>
                  <select value={editingMerchantInv()?.item_id || 1} 
                          onChange={(e) => setEditingMerchantInv({...editingMerchantInv()!, item_id: parseInt(e.currentTarget.value)})} required>
                    <For each={items().sort((a: any, b: any) => a.name.localeCompare(b.name))}>
                      {(item: any) => <option value={item.id}>{item.name} ({item.type})</option>}
                    </For>
                  </select>
                </div>
                <div>
                  <label>Stock (-1 = infinite)</label>
                  <input type="number" min="-1" value={editingMerchantInv()?.stock ?? -1} 
                         onInput={(e) => setEditingMerchantInv({...editingMerchantInv()!, stock: parseInt(e.currentTarget.value)})} required />
                </div>
                <div>
                  <label>Price Multiplier</label>
                  <input type="number" step="0.1" min="0.1" value={editingMerchantInv()?.price_multiplier || 1.0} 
                         onInput={(e) => setEditingMerchantInv({...editingMerchantInv()!, price_multiplier: parseFloat(e.currentTarget.value)})} required />
                  <small style={{ display: "block", "margin-top": "0.25rem", color: "var(--text-secondary)" }}>
                    1.0 = normal price, 0.5 = half price, 2.0 = double price
                  </small>
                </div>
              </div>
              <div style={{ display: "flex", gap: "1rem", "margin-top": "1.5rem" }}>
                <button type="submit" class="button primary" style={{ flex: 1 }}>Save</button>
                <button type="button" class="button secondary" style={{ flex: 1 }} onClick={() => setShowMerchantInvModal(false)}>Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </Show>
      
      {/* Character Edit Modal */}
      <Show when={showCharacterModal()}>
        <div style={{
          position: "fixed", top: 0, left: 0, right: 0, bottom: 0,
          background: "rgba(0,0,0,0.7)", display: "flex",
          "align-items": "center", "justify-content": "center", "z-index": 1000
        }} onClick={() => setShowCharacterModal(false)}>
          <div class="card" style={{ "max-width": "900px", width: "90%", "max-height": "90vh", overflow: "auto" }} 
               onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
              <h2>Edit Character: {editingCharacter()?.name}</h2>
              <button onClick={() => setShowCharacterModal(false)} style={{ background: "none", border: "none", "font-size": "1.5rem", cursor: "pointer" }}></button>
            </div>
            
            {/* Sub-tabs */}
            <div style={{ display: "flex", gap: "0.5rem", "margin-bottom": "1rem", "border-bottom": "2px solid var(--bg-light)", "padding-bottom": "0.5rem" }}>
              <button
                class={characterModalTab() === "stats" ? "button primary" : "button secondary"}
                onClick={() => setCharacterModalTab("stats")}
                style={{ padding: "0.5rem 1rem" }}
              >
                Stats & Gold
              </button>
              <button
                class={characterModalTab() === "inventory" ? "button primary" : "button secondary"}
                onClick={() => setCharacterModalTab("inventory")}
                style={{ padding: "0.5rem 1rem" }}
              >
                Inventory ({characterInventory().length})
              </button>
              <button
                class={characterModalTab() === "abilities" ? "button primary" : "button secondary"}
                onClick={() => setCharacterModalTab("abilities")}
                style={{ padding: "0.5rem 1rem" }}
              >
                Abilities ({characterAbilities().length})
              </button>
              <button
                class={characterModalTab() === "regions" ? "button primary" : "button secondary"}
                onClick={() => setCharacterModalTab("regions")}
                style={{ padding: "0.5rem 1rem" }}
              >
                Region Unlocks
              </button>
              <button
                class={characterModalTab() === "professions" ? "button primary" : "button secondary"}
                onClick={() => setCharacterModalTab("professions")}
                style={{ padding: "0.5rem 1rem" }}
              >
                Professions ({characterProfessions().length})
              </button>
            </div>
            
            {/* Stats Tab */}
            <Show when={characterModalTab() === "stats"}>
              <form onSubmit={handleSaveCharacter}>
                <div style={{ display: "grid", gap: "1rem", "grid-template-columns": "1fr 1fr 1fr" }}>
                  <div style={{ "grid-column": "1 / -1" }}>
                    <label>Character Name</label>
                    <input type="text" value={editingCharacter()?.name || ''} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, name: e.currentTarget.value})} required />
                  </div>
                  
                  <div style={{ "grid-column": "1 / -1", "margin-top": "1rem" }}>
                    <h3 style={{ "font-size": "1.1rem", color: "var(--accent)" }}>Level & Resources</h3>
                  </div>
                  
                  <div>
                    <label>Level</label>
                    <input type="number" min="1" value={editingCharacter()?.level || 1} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, level: parseInt(e.currentTarget.value)})} required />
                  </div>
                  <div>
                    <label>Experience</label>
                    <input type="number" min="0" value={editingCharacter()?.experience || 0} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, experience: parseInt(e.currentTarget.value)})} required />
                  </div>
                  <div>
                    <label>Gold</label>
                    <input type="number" min="0" value={editingCharacter()?.gold || 0} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, gold: parseInt(e.currentTarget.value)})} required />
                  </div>
                  <div>
                    <label>Available Stat Points</label>
                    <input type="number" min="0" value={editingCharacter()?.available_points || 0} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, available_points: parseInt(e.currentTarget.value)})} required />
                  </div>
                  
                  <div style={{ "grid-column": "1 / -1", "margin-top": "1rem" }}>
                    <h3 style={{ "font-size": "1.1rem", color: "var(--accent)" }}>Health & Mana</h3>
                  </div>
                  
                  <div>
                    <label>Current Health</label>
                    <input type="number" min="0" value={editingCharacter()?.current_health || 100} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, current_health: parseInt(e.currentTarget.value)})} required />
                  </div>
                  <div>
                    <label>Max Health</label>
                    <input type="number" min="1" value={editingCharacter()?.max_health || 100} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, max_health: parseInt(e.currentTarget.value)})} required />
                  </div>
                  <div></div>
                  <div>
                    <label>Current Mana</label>
                    <input type="number" min="0" value={editingCharacter()?.current_mana || 100} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, current_mana: parseInt(e.currentTarget.value)})} required />
                  </div>
                  <div>
                    <label>Max Mana</label>
                    <input type="number" min="1" value={editingCharacter()?.max_mana || 100} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, max_mana: parseInt(e.currentTarget.value)})} required />
                  </div>
                  
                  <div style={{ "grid-column": "1 / -1", "margin-top": "1rem" }}>
                    <h3 style={{ "font-size": "1.1rem", color: "var(--accent)" }}>Attributes</h3>
                  </div>
                  
                  <div>
                    <label>Strength</label>
                    <input type="number" min="1" value={editingCharacter()?.strength || 10} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, strength: parseInt(e.currentTarget.value)})} required />
                  </div>
                  <div>
                    <label>Dexterity</label>
                    <input type="number" min="1" value={editingCharacter()?.dexterity || 10} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, dexterity: parseInt(e.currentTarget.value)})} required />
                  </div>
                  <div>
                    <label>Constitution</label>
                    <input type="number" min="1" value={editingCharacter()?.constitution || 10} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, constitution: parseInt(e.currentTarget.value)})} required />
                  </div>
                  <div>
                    <label>Intelligence</label>
                    <input type="number" min="1" value={editingCharacter()?.intelligence || 10} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, intelligence: parseInt(e.currentTarget.value)})} required />
                  </div>
                  <div>
                    <label>Wisdom</label>
                    <input type="number" min="1" value={editingCharacter()?.wisdom || 10} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, wisdom: parseInt(e.currentTarget.value)})} required />
                  </div>
                  <div>
                    <label>Charisma</label>
                    <input type="number" min="1" value={editingCharacter()?.charisma || 10} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, charisma: parseInt(e.currentTarget.value)})} required />
                  </div>
                  
                  <div style={{ "grid-column": "1 / -1", "margin-top": "1rem" }}>
                    <h3 style={{ "font-size": "1.1rem", color: "var(--accent)" }}>Location</h3>
                  </div>
                  
                  <div>
                    <label>Current Region</label>
                    <select value={editingCharacter()?.current_region || 1} 
                            onChange={(e) => setEditingCharacter({...editingCharacter()!, current_region: parseInt(e.currentTarget.value)})}>
                      <For each={regions()}>
                        {(region: any) => <option value={region.id}>{region.name}</option>}
                      </For>
                    </select>
                  </div>
                  <div>
                    <label>Current Sub-Area (nullable)</label>
                    <input type="number" min="0" value={editingCharacter()?.current_sub_area || ''} 
                           onInput={(e) => setEditingCharacter({...editingCharacter()!, current_sub_area: e.currentTarget.value ? parseInt(e.currentTarget.value) : null})} 
                           placeholder="Leave empty for none" />
                  </div>
                </div>
                <div style={{ display: "flex", gap: "1rem", "margin-top": "1.5rem" }}>
                  <button type="submit" class="button primary" style={{ flex: 1 }}>Save Character</button>
                  <button type="button" class="button secondary" style={{ flex: 1 }} onClick={() => setShowCharacterModal(false)}>Cancel</button>
                </div>
              </form>
            </Show>
            
            {/* Inventory Tab */}
            <Show when={characterModalTab() === "inventory"}>
              <div>
                <div style={{ "margin-bottom": "1rem" }}>
                  <button class="button primary" onClick={handleAddItemToCharacter}>Add Item</button>
                </div>
                <div style={{ overflow: "auto", "max-height": "500px" }}>
                  <table style={{ width: "100%", "border-collapse": "collapse", "font-size": "0.9rem" }}>
                    <thead style={{ position: "sticky", top: 0, background: "var(--bg-dark)" }}>
                      <tr style={{ "border-bottom": "2px solid var(--bg-light)" }}>
                        <th style={{ padding: "0.5rem", "text-align": "left" }}>Item</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Type</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Rarity</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Quantity</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Equipped</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <For each={characterInventory()}>
                        {(invItem: any) => (
                          <tr style={{ "border-bottom": "1px solid var(--bg-light)" }}>
                            <td style={{ padding: "0.5rem" }}>{invItem.name}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>{invItem.type}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>{invItem.rarity}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>
                              <input 
                                type="number" 
                                min="1" 
                                value={invItem.quantity} 
                                style={{ width: "60px", padding: "0.25rem", "text-align": "center" }}
                                onChange={(e) => handleUpdateInventoryItem(invItem.inventory_id, parseInt(e.currentTarget.value), invItem.equipped)}
                              />
                            </td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>
                              <input 
                                type="checkbox" 
                                checked={invItem.equipped === 1}
                                onChange={(e) => handleUpdateInventoryItem(invItem.inventory_id, invItem.quantity, e.currentTarget.checked ? 1 : 0)}
                              />
                            </td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>
                              <button 
                                class="button" 
                                style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", background: "var(--danger)" }}
                                onClick={() => handleRemoveItemFromCharacter(invItem.inventory_id)}
                              >
                                Remove
                              </button>
                            </td>
                          </tr>
                        )}
                      </For>
                    </tbody>
                  </table>
                  <Show when={characterInventory().length === 0}>
                    <div style={{ padding: "2rem", "text-align": "center", color: "var(--text-secondary)" }}>
                      No items in inventory
                    </div>
                  </Show>
                </div>
              </div>
            </Show>
            
            {/* Abilities Tab */}
            <Show when={characterModalTab() === "abilities"}>
              <div>
                <div style={{ "margin-bottom": "1rem" }}>
                  <button class="button primary" onClick={handleAddAbilityToCharacter}>Add Ability</button>
                </div>
                <div style={{ overflow: "auto", "max-height": "500px" }}>
                  <table style={{ width: "100%", "border-collapse": "collapse", "font-size": "0.9rem" }}>
                    <thead style={{ position: "sticky", top: 0, background: "var(--bg-dark)" }}>
                      <tr style={{ "border-bottom": "2px solid var(--bg-light)" }}>
                        <th style={{ padding: "0.5rem", "text-align": "left" }}>Ability</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Type</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Category</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Required Level</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <For each={characterAbilities()}>
                        {(ability: any) => (
                          <tr style={{ "border-bottom": "1px solid var(--bg-light)" }}>
                            <td style={{ padding: "0.5rem" }}>{ability.name}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>{ability.type}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>{ability.category}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>{ability.required_level}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>
                              <button 
                                class="button" 
                                style={{ padding: "0.25rem 0.5rem", "font-size": "0.8rem", background: "var(--danger)" }}
                                onClick={() => handleRemoveAbilityFromCharacter(ability.character_ability_id)}
                              >
                                Remove
                              </button>
                            </td>
                          </tr>
                        )}
                      </For>
                    </tbody>
                  </table>
                  <Show when={characterAbilities().length === 0}>
                    <div style={{ padding: "2rem", "text-align": "center", color: "var(--text-secondary)" }}>
                      No abilities learned
                    </div>
                  </Show>
                </div>
              </div>
            </Show>
            
            {/* Regions Tab */}
            <Show when={characterModalTab() === "regions"}>
              <div>
                <div style={{ "margin-bottom": "1rem" }}>
                  <p style={{ color: "var(--text-secondary)" }}>
                    Manage which regions this character has unlocked. Unlocked regions can be traveled to.
                  </p>
                </div>
                <div style={{ overflow: "auto", "max-height": "500px" }}>
                  <table style={{ width: "100%", "border-collapse": "collapse", "font-size": "0.9rem" }}>
                    <thead style={{ position: "sticky", top: 0, background: "var(--bg-dark)" }}>
                      <tr style={{ "border-bottom": "2px solid var(--bg-light)" }}>
                        <th style={{ padding: "0.5rem", "text-align": "left" }}>Region</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Status</th>
                        <th style={{ padding: "0.5rem", "text-align": "center" }}>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <For each={characterRegionUnlocks()}>
                        {(regionUnlock: any) => (
                          <tr style={{ "border-bottom": "1px solid var(--bg-light)" }}>
                            <td style={{ padding: "0.5rem" }}>{regionUnlock.region_name}</td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>
                              {regionUnlock.unlocked === 1 ? (
                                <span style={{ color: "var(--success)" }}>Yes Unlocked</span>
                              ) : (
                                <span style={{ color: "var(--text-secondary)" }}>Locked</span>
                              )}
                            </td>
                            <td style={{ padding: "0.5rem", "text-align": "center" }}>
                              <button 
                                class="button" 
                                style={{ 
                                  padding: "0.25rem 0.75rem", 
                                  "font-size": "0.8rem", 
                                  background: regionUnlock.unlocked === 1 ? "var(--danger)" : "var(--success)" 
                                }}
                                onClick={() => handleToggleRegionUnlock(regionUnlock.region_id, regionUnlock.unlocked === 1)}
                              >
                                {regionUnlock.unlocked === 1 ? "Lock" : "Unlock"}
                              </button>
                            </td>
                          </tr>
                        )}
                      </For>
                    </tbody>
                  </table>
                </div>
              </div>
            </Show>
            
            {/* Professions Tab */}
            <Show when={characterModalTab() === "professions"}>
              <div>
                <div style={{ "margin-bottom": "1rem" }}>
                  <p style={{ color: "var(--text-secondary)" }}>
                    Manage profession levels and experience. Max profession level equals character level ({editingCharacter()?.level || 1}).
                  </p>
                </div>
                <div style={{ display: "grid", gap: "1rem" }}>
                  {/* Blacksmithing */}
                  <Show when={characterProfessions().find((p: any) => p.profession_type === 'blacksmithing')}>
                    {(prof) => (
                      <div style={{ 
                        border: "1px solid var(--bg-medium)", 
                        padding: "1rem", 
                        "border-radius": "6px",
                        background: "var(--bg-light)"
                      }}>
                        <h4 style={{ 
                          "margin-top": "0", 
                          "margin-bottom": "1rem",
                          color: "var(--accent)"
                        }}>
                          Blacksmithing
                        </h4>
                        <div style={{ display: "grid", gap: "0.75rem", "grid-template-columns": "1fr 1fr" }}>
                          <div>
                            <label style={{ "font-size": "0.9rem", color: "var(--text-secondary)" }}>Level</label>
                            <input 
                              type="number" 
                              min="1" 
                              max={editingCharacter()?.level || 1}
                              value={prof().level} 
                              onInput={(e) => {
                                const newProfs = characterProfessions().map((p: any) => 
                                  p.profession_type === 'blacksmithing' 
                                    ? {...p, level: parseInt(e.currentTarget.value) || 1}
                                    : p
                                );
                                setCharacterProfessions(newProfs);
                              }}
                              style={{ width: "100%", padding: "0.5rem" }}
                            />
                          </div>
                          <div>
                            <label style={{ "font-size": "0.9rem", color: "var(--text-secondary)" }}>Experience</label>
                            <input 
                              type="number" 
                              min="0"
                              value={prof().experience} 
                              onInput={(e) => {
                                const newProfs = characterProfessions().map((p: any) => 
                                  p.profession_type === 'blacksmithing' 
                                    ? {...p, experience: parseInt(e.currentTarget.value) || 0}
                                    : p
                                );
                                setCharacterProfessions(newProfs);
                              }}
                              style={{ width: "100%", padding: "0.5rem" }}
                            />
                          </div>
                        </div>
                        <div style={{ "margin-top": "0.75rem", "font-size": "0.85rem", color: "var(--text-secondary)" }}>
                          XP needed for next level: {prof().level * 125}
                        </div>
                      </div>
                    )}
                  </Show>
                  
                  {/* Leatherworking */}
                  <Show when={characterProfessions().find((p: any) => p.profession_type === 'leatherworking')}>
                    {(prof) => (
                      <div style={{ 
                        border: "1px solid var(--bg-medium)", 
                        padding: "1rem", 
                        "border-radius": "6px",
                        background: "var(--bg-light)"
                      }}>
                        <h4 style={{ 
                          "margin-top": "0", 
                          "margin-bottom": "1rem",
                          color: "var(--accent)"
                        }}>
                          Leatherworking
                        </h4>
                        <div style={{ display: "grid", gap: "0.75rem", "grid-template-columns": "1fr 1fr" }}>
                          <div>
                            <label style={{ "font-size": "0.9rem", color: "var(--text-secondary)" }}>Level</label>
                            <input 
                              type="number" 
                              min="1" 
                              max={editingCharacter()?.level || 1}
                              value={prof().level} 
                              onInput={(e) => {
                                const newProfs = characterProfessions().map((p: any) => 
                                  p.profession_type === 'leatherworking' 
                                    ? {...p, level: parseInt(e.currentTarget.value) || 1}
                                    : p
                                );
                                setCharacterProfessions(newProfs);
                              }}
                              style={{ width: "100%", padding: "0.5rem" }}
                            />
                          </div>
                          <div>
                            <label style={{ "font-size": "0.9rem", color: "var(--text-secondary)" }}>Experience</label>
                            <input 
                              type="number" 
                              min="0"
                              value={prof().experience} 
                              onInput={(e) => {
                                const newProfs = characterProfessions().map((p: any) => 
                                  p.profession_type === 'leatherworking' 
                                    ? {...p, experience: parseInt(e.currentTarget.value) || 0}
                                    : p
                                );
                                setCharacterProfessions(newProfs);
                              }}
                              style={{ width: "100%", padding: "0.5rem" }}
                            />
                          </div>
                        </div>
                        <div style={{ "margin-top": "0.75rem", "font-size": "0.85rem", color: "var(--text-secondary)" }}>
                          XP needed for next level: {prof().level * 125}
                        </div>
                      </div>
                    )}
                  </Show>
                  
                  {/* Tailoring */}
                  <Show when={characterProfessions().find((p: any) => p.profession_type === 'tailoring')}>
                    {(prof) => (
                      <div style={{ 
                        border: "1px solid var(--bg-medium)", 
                        padding: "1rem", 
                        "border-radius": "6px",
                        background: "var(--bg-light)"
                      }}>
                        <h4 style={{ 
                          "margin-top": "0", 
                          "margin-bottom": "1rem",
                          color: "var(--accent)"
                        }}>
                          Tailoring
                        </h4>
                        <div style={{ display: "grid", gap: "0.75rem", "grid-template-columns": "1fr 1fr" }}>
                          <div>
                            <label style={{ "font-size": "0.9rem", color: "var(--text-secondary)" }}>Level</label>
                            <input 
                              type="number" 
                              min="1" 
                              max={editingCharacter()?.level || 1}
                              value={prof().level} 
                              onInput={(e) => {
                                const newProfs = characterProfessions().map((p: any) => 
                                  p.profession_type === 'tailoring' 
                                    ? {...p, level: parseInt(e.currentTarget.value) || 1}
                                    : p
                                );
                                setCharacterProfessions(newProfs);
                              }}
                              style={{ width: "100%", padding: "0.5rem" }}
                            />
                          </div>
                          <div>
                            <label style={{ "font-size": "0.9rem", color: "var(--text-secondary)" }}>Experience</label>
                            <input 
                              type="number" 
                              min="0"
                              value={prof().experience} 
                              onInput={(e) => {
                                const newProfs = characterProfessions().map((p: any) => 
                                  p.profession_type === 'tailoring' 
                                    ? {...p, experience: parseInt(e.currentTarget.value) || 0}
                                    : p
                                );
                                setCharacterProfessions(newProfs);
                              }}
                              style={{ width: "100%", padding: "0.5rem" }}
                            />
                          </div>
                        </div>
                        <div style={{ "margin-top": "0.75rem", "font-size": "0.85rem", color: "var(--text-secondary)" }}>
                          XP needed for next level: {prof().level * 125}
                        </div>
                      </div>
                    )}
                  </Show>
                  
                  {/* Fletching */}
                  <Show when={characterProfessions().find((p: any) => p.profession_type === 'fletching')}>
                    {(prof) => (
                      <div style={{ 
                        border: "1px solid var(--bg-medium)", 
                        padding: "1rem", 
                        "border-radius": "6px",
                        background: "var(--bg-light)"
                      }}>
                        <h4 style={{ 
                          "margin-top": "0", 
                          "margin-bottom": "1rem",
                          color: "var(--accent)"
                        }}>
                          Fletching
                        </h4>
                        <div style={{ display: "grid", gap: "0.75rem", "grid-template-columns": "1fr 1fr" }}>
                          <div>
                            <label style={{ "font-size": "0.9rem", color: "var(--text-secondary)" }}>Level</label>
                            <input 
                              type="number" 
                              min="1" 
                              max={editingCharacter()?.level || 1}
                              value={prof().level} 
                              onInput={(e) => {
                                const newProfs = characterProfessions().map((p: any) => 
                                  p.profession_type === 'fletching' 
                                    ? {...p, level: parseInt(e.currentTarget.value) || 1}
                                    : p
                                );
                                setCharacterProfessions(newProfs);
                              }}
                              style={{ width: "100%", padding: "0.5rem" }}
                            />
                          </div>
                          <div>
                            <label style={{ "font-size": "0.9rem", color: "var(--text-secondary)" }}>Experience</label>
                            <input 
                              type="number" 
                              min="0"
                              value={prof().experience} 
                              onInput={(e) => {
                                const newProfs = characterProfessions().map((p: any) => 
                                  p.profession_type === 'fletching' 
                                    ? {...p, experience: parseInt(e.currentTarget.value) || 0}
                                    : p
                                );
                                setCharacterProfessions(newProfs);
                              }}
                              style={{ width: "100%", padding: "0.5rem" }}
                            />
                          </div>
                        </div>
                        <div style={{ "margin-top": "0.75rem", "font-size": "0.85rem", color: "var(--text-secondary)" }}>
                          XP needed for next level: {prof().level * 125}
                        </div>
                      </div>
                    )}
                  </Show>
                  
                  {/* Alchemy */}
                  <Show when={characterProfessions().find((p: any) => p.profession_type === 'alchemy')}>
                    {(prof) => (
                      <div style={{ 
                        border: "1px solid var(--bg-medium)", 
                        padding: "1rem", 
                        "border-radius": "6px",
                        background: "var(--bg-light)"
                      }}>
                        <h4 style={{ 
                          "margin-top": "0", 
                          "margin-bottom": "1rem",
                          color: "var(--accent)"
                        }}>
                          Alchemy
                        </h4>
                        <div style={{ display: "grid", gap: "0.75rem", "grid-template-columns": "1fr 1fr" }}>
                          <div>
                            <label style={{ "font-size": "0.9rem", color: "var(--text-secondary)" }}>Level</label>
                            <input 
                              type="number" 
                              min="1" 
                              max={editingCharacter()?.level || 1}
                              value={prof().level} 
                              onInput={(e) => {
                                const newProfs = characterProfessions().map((p: any) => 
                                  p.profession_type === 'alchemy' 
                                    ? {...p, level: parseInt(e.currentTarget.value) || 1}
                                    : p
                                );
                                setCharacterProfessions(newProfs);
                              }}
                              style={{ width: "100%", padding: "0.5rem" }}
                            />
                          </div>
                          <div>
                            <label style={{ "font-size": "0.9rem", color: "var(--text-secondary)" }}>Experience</label>
                            <input 
                              type="number" 
                              min="0"
                              value={prof().experience} 
                              onInput={(e) => {
                                const newProfs = characterProfessions().map((p: any) => 
                                  p.profession_type === 'alchemy' 
                                    ? {...p, experience: parseInt(e.currentTarget.value) || 0}
                                    : p
                                );
                                setCharacterProfessions(newProfs);
                              }}
                              style={{ width: "100%", padding: "0.5rem" }}
                            />
                          </div>
                        </div>
                        <div style={{ "margin-top": "0.75rem", "font-size": "0.85rem", color: "var(--text-secondary)" }}>
                          XP needed for next level: {prof().level * 125}
                        </div>
                      </div>
                    )}
                  </Show>
                </div>
                <div style={{ "margin-top": "1.5rem" }}>
                  <button 
                    class="button primary" 
                    style={{ width: "100%" }}
                    onClick={handleSaveProfessions}
                  >
                    Save Professions
                  </button>
                </div>
              </div>
            </Show>
          </div>
        </div>
      </Show>
      
      {/* Add Item Modal */}
      <Show when={showAddItemModal()}>
        <div style={{
          position: "fixed", top: 0, left: 0, right: 0, bottom: 0,
          background: "rgba(0,0,0,0.8)", display: "flex",
          "align-items": "center", "justify-content": "center", "z-index": 1001
        }} onClick={() => setShowAddItemModal(false)}>
          <div class="card" style={{ "max-width": "700px", width: "90%", "max-height": "80vh", overflow: "hidden", display: "flex", "flex-direction": "column" }} 
               onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
              <h2>Add Item to Inventory</h2>
              <button onClick={() => setShowAddItemModal(false)} style={{ background: "none", border: "none", "font-size": "1.5rem", cursor: "pointer" }}></button>
            </div>
            
            <div style={{ "margin-bottom": "1rem" }}>
              <input 
                type="text" 
                placeholder="Search items by ID, name, or type..." 
                value={searchAddItem()}
                onInput={(e) => setSearchAddItem(e.currentTarget.value)}
                style={{ width: "100%", padding: "0.75rem", "font-size": "1rem" }}
                autofocus
              />
            </div>
            
            <div style={{ flex: 1, overflow: "auto", "margin-bottom": "1rem" }}>
              <table style={{ width: "100%", "border-collapse": "collapse", "font-size": "0.9rem" }}>
                <thead style={{ position: "sticky", top: 0, background: "var(--bg-dark)" }}>
                  <tr style={{ "border-bottom": "2px solid var(--bg-light)" }}>
                    <th style={{ padding: "0.5rem", "text-align": "center" }}>Select</th>
                    <th style={{ padding: "0.5rem", "text-align": "center" }}>ID</th>
                    <th style={{ padding: "0.5rem", "text-align": "left" }}>Name</th>
                    <th style={{ padding: "0.5rem", "text-align": "center" }}>Type</th>
                    <th style={{ padding: "0.5rem", "text-align": "center" }}>Rarity</th>
                    <th style={{ padding: "0.5rem", "text-align": "center" }}>Lvl</th>
                  </tr>
                </thead>
                <tbody>
                  <For each={items().filter((i: any) => {
                    const search = searchAddItem().toLowerCase();
                    if (!search) return true;
                    return (
                      i.id?.toString().includes(search) ||
                      i.name?.toLowerCase().includes(search) ||
                      i.type?.toLowerCase().includes(search)
                    );
                  })}>
                    {(item: any) => (
                      <tr 
                        style={{ 
                          "border-bottom": "1px solid var(--bg-light)",
                          background: selectedItemToAdd() === item.id ? "var(--bg-light)" : "transparent",
                          cursor: "pointer"
                        }}
                        onClick={() => setSelectedItemToAdd(item.id)}
                      >
                        <td style={{ padding: "0.5rem", "text-align": "center" }}>
                          <input 
                            type="radio" 
                            checked={selectedItemToAdd() === item.id}
                            onChange={() => setSelectedItemToAdd(item.id)}
                          />
                        </td>
                        <td style={{ padding: "0.5rem", "text-align": "center", "font-weight": "bold", color: "var(--accent)" }}>{item.id}</td>
                        <td style={{ padding: "0.5rem" }}>{item.name}</td>
                        <td style={{ padding: "0.5rem", "text-align": "center" }}>{item.type}</td>
                        <td style={{ padding: "0.5rem", "text-align": "center" }}>
                          <span style={{ 
                            padding: "0.2rem 0.4rem", 
                            "border-radius": "3px",
                            background: item.rarity === 'legendary' ? 'var(--legendary)' :
                                       item.rarity === 'epic' ? 'var(--epic)' :
                                       item.rarity === 'rare' ? 'var(--rare)' :
                                       item.rarity === 'uncommon' ? 'var(--uncommon)' :
                                       'var(--common)',
                            color: '#fff',
                            "font-size": "0.75rem"
                          }}>
                            {item.rarity}
                          </span>
                        </td>
                        <td style={{ padding: "0.5rem", "text-align": "center" }}>{item.level}</td>
                      </tr>
                    )}
                  </For>
                </tbody>
              </table>
            </div>
            
            <div style={{ display: "flex", gap: "1rem", "align-items": "end" }}>
              <div style={{ flex: 1 }}>
                <label style={{ display: "block", "margin-bottom": "0.25rem" }}>Quantity</label>
                <input 
                  type="number" 
                  min="1" 
                  value={itemQuantityToAdd()} 
                  onInput={(e) => setItemQuantityToAdd(parseInt(e.currentTarget.value) || 1)}
                  style={{ width: "100%", padding: "0.5rem" }}
                />
              </div>
              <button 
                type="button" 
                class="button primary" 
                style={{ flex: 1 }}
                onClick={handleConfirmAddItem}
                disabled={!selectedItemToAdd()}
              >
                Add Item
              </button>
              <button 
                type="button" 
                class="button secondary" 
                style={{ flex: 1 }}
                onClick={() => setShowAddItemModal(false)}
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      </Show>
      
      {/* Add Ability Modal */}
      <Show when={showAddAbilityModal()}>
        <div style={{
          position: "fixed", top: 0, left: 0, right: 0, bottom: 0,
          background: "rgba(0,0,0,0.8)", display: "flex",
          "align-items": "center", "justify-content": "center", "z-index": 1001
        }} onClick={() => setShowAddAbilityModal(false)}>
          <div class="card" style={{ "max-width": "800px", width: "90%", "max-height": "80vh", overflow: "hidden", display: "flex", "flex-direction": "column" }} 
               onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", "justify-content": "space-between", "align-items": "center", "margin-bottom": "1rem" }}>
              <h2>Add Ability to Character</h2>
              <button onClick={() => setShowAddAbilityModal(false)} style={{ background: "none", border: "none", "font-size": "1.5rem", cursor: "pointer" }}></button>
            </div>
            
            <div style={{ "margin-bottom": "1rem" }}>
              <input 
                type="text" 
                placeholder="Search abilities by ID, name, type, or category..." 
                value={searchAddAbility()}
                onInput={(e) => setSearchAddAbility(e.currentTarget.value)}
                style={{ width: "100%", padding: "0.75rem", "font-size": "1rem" }}
                autofocus
              />
            </div>
            
            <div style={{ flex: 1, overflow: "auto", "margin-bottom": "1rem" }}>
              <table style={{ width: "100%", "border-collapse": "collapse", "font-size": "0.9rem" }}>
                <thead style={{ position: "sticky", top: 0, background: "var(--bg-dark)" }}>
                  <tr style={{ "border-bottom": "2px solid var(--bg-light)" }}>
                    <th style={{ padding: "0.5rem", "text-align": "center" }}>Select</th>
                    <th style={{ padding: "0.5rem", "text-align": "center" }}>ID</th>
                    <th style={{ padding: "0.5rem", "text-align": "left" }}>Name</th>
                    <th style={{ padding: "0.5rem", "text-align": "center" }}>Type</th>
                    <th style={{ padding: "0.5rem", "text-align": "center" }}>Category</th>
                    <th style={{ padding: "0.5rem", "text-align": "center" }}>Lvl Req</th>
                    <th style={{ padding: "0.5rem", "text-align": "right" }}>Mana</th>
                  </tr>
                </thead>
                <tbody>
                  <For each={abilities().filter((a: any) => {
                    const search = searchAddAbility().toLowerCase();
                    if (!search) return true;
                    return (
                      a.id?.toString().includes(search) ||
                      a.name?.toLowerCase().includes(search) ||
                      a.type?.toLowerCase().includes(search) ||
                      a.category?.toLowerCase().includes(search)
                    );
                  })}>
                    {(ability: any) => (
                      <tr 
                        style={{ 
                          "border-bottom": "1px solid var(--bg-light)",
                          background: selectedAbilityToAdd() === ability.id ? "var(--bg-light)" : "transparent",
                          cursor: "pointer"
                        }}
                        onClick={() => setSelectedAbilityToAdd(ability.id)}
                      >
                        <td style={{ padding: "0.5rem", "text-align": "center" }}>
                          <input 
                            type="radio" 
                            checked={selectedAbilityToAdd() === ability.id}
                            onChange={() => setSelectedAbilityToAdd(ability.id)}
                          />
                        </td>
                        <td style={{ padding: "0.5rem", "text-align": "center", "font-weight": "bold", color: "var(--accent)" }}>{ability.id}</td>
                        <td style={{ padding: "0.5rem" }}>{ability.name}</td>
                        <td style={{ padding: "0.5rem", "text-align": "center" }}>{ability.type}</td>
                        <td style={{ padding: "0.5rem", "text-align": "center" }}>{ability.category}</td>
                        <td style={{ padding: "0.5rem", "text-align": "center" }}>{ability.required_level}</td>
                        <td style={{ padding: "0.5rem", "text-align": "right" }}>{ability.mana_cost || 0}</td>
                      </tr>
                    )}
                  </For>
                </tbody>
              </table>
            </div>
            
            <div style={{ display: "flex", gap: "1rem" }}>
              <button 
                type="button" 
                class="button primary" 
                style={{ flex: 1 }}
                onClick={handleConfirmAddAbility}
                disabled={!selectedAbilityToAdd()}
              >
                Add Ability
              </button>
              <button 
                type="button" 
                class="button secondary" 
                style={{ flex: 1 }}
                onClick={() => setShowAddAbilityModal(false)}
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      </Show>
    </div>
  );
}
